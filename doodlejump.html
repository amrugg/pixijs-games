<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Direction ship</title>
</head>
    <style>* {padding: 0; margin: 0}</style>
    <script src="pixi/pixi.min.js"></script>
    <script src="usefulFunctions.js"></script>
<body>
  <script type="text/javascript">
    var params = getParams();
    function getParams() {
      var params = {};
      location.search.substr(1).split("&").forEach(function(el) {
        var data = el.replace(/\+/g, " ").split("=");
        params[decodeURIComponent(data[0])] = data[1] ? decodeURIComponent(data[1]) : true;
      });
      return params;
    }
    PIXI.utils.skipHello();
    PIXI.settings.SCALE_MODE = PIXI.SCALE_MODES.NEAREST;
    let Application = PIXI.Application,
        Container = PIXI.Container,
        loader = PIXI.loader,
        resources = PIXI.loader.resources,
        TextureCache = PIXI.utils.TextureCache,
        Sprite = PIXI.Sprite,
        Rectangle = PIXI.Rectangle,
        Graphics = PIXI.Graphics;
    let app = new Application({ 
        width: 800,
        height: 800,              
        antialias: true,
        transparent: false,
        resolution: 1
      }
    );
    app.renderer.backgroundColor = 0x6666DD;
    /// Fill the screen 
    app.renderer.view.style.position = "absolute";
    app.renderer.view.style.display = "block";
    app.renderer.autoResize = true;
    app.renderer.resize(window.innerWidth, window.innerHeight);
    document.body.appendChild(app.view);
    loader.add("sprites/treasureHunter.json").add("sprites/platform.png").load(setup);
    var state;
    var keys = {};
    var hero;
    var id;
    var fall = 0.05;
    var friction = 0.03;
    var platforms = [{x:100,y:innerHeight - 250},{x:300,y:innerHeight - 450},{x:500,y:innerHeight - 650},{x:700,y:innerHeight - 650},{x:900,y:innerHeight - 450},{x:1100,y:innerHeight - 250}];
    var platformSprites = [];
    var blobs = [];
    var treasures = [];
    var healthBar;
    function setup() {
        state = play;
        id = resources["sprites/treasureHunter.json"].textures;
        hero = new Sprite(id["explorer.png"]);
        app.stage.addChild(hero);
        hero.vy = hero.vx = 0;
        hero.vvx = 1.6;
        hero.anchor.set(0.5);
        spawnBlobs(1);

        healthBar = new Container();
        healthBar.position.set(512-170, 4)
        app.stage.addChild(healthBar)
        var innerBar = new Graphics();
        innerBar.beginFill(0x000000);
        innerBar.drawRect(0, 0, 128, 8);
        innerBar.endFill();
        healthBar.addChild(innerBar);
        var outerBar = new Graphics();
        outerBar.beginFill(0xFF3300);
        outerBar.drawRect(0,0,128,8);
        outerBar.endFill();
        healthBar.addChild(outerBar);
        healthBar.outer = outerBar;
        platforms.forEach(function(p){
            var plata = new Sprite(resources["sprites/platform.png"].texture);
            app.stage.addChild(plata);
            plata.x = p.x;
            plata.y = p.y;
            plata.scale.set(3);
            plata.anchor.set(0.5);
            plata.rep = p;
            platformSprites.push(plata);
        });
        hero.y = innerHeight - hero.height * 2;
        hero.x = innerWidth / 2;
        var treasure = new Sprite(id["treasure.png"]);
        treasure.x = 700;
        treasure.y = innerHeight - 700;
        treasure.vy = 0;
        treasures.push(treasure);
        app.stage.addChild(treasure);
        app.ticker.add(delta => gameLoop(delta));
    }
    function spawnBlobs(x) {
        x = x || 1;
        for(let i = 0; i < x; i++) {
            var blob = new Sprite(id["blob.png"]);
            blobs.push(blob);
            app.stage.addChild(blob);    
            blob.vy = blob.vx = 0;
            blob.vvx = randNum(1,2);
            blob.x = randInt(-100,innerWidth + 100);
            blob.y = randInt(-100,200)
        }
    }
    function gameLoop(delta) {
      state(delta);
    }
    function play(){
        if(hero.grounded === getPlatformUnder(hero)) {

        } else {
            hero.vy += fall;
            if(keys.ArrowDown) {
                hero.vy += fall;
                hero.slam = true;
            } else {
                hero.slam = false;
            }
            hero.y += hero.vy;
            hero.grounded = false;
        }
        if(getPlatformUnder(hero) < 0) {
            while(getPlatformUnder(hero) < 0) {
                hero.y += 0.1;
            }
            hero.vy *= -0.8;
        } else if(getPlatformUnder(hero) < hero.height - hero.height / 3) {
            if(hero.slam && hero.vy > 6) {
                var slam = returnPlatformUnder(hero);
                if(slam) {
                    if(slam.x > hero.x + 30) {
                        slam.flip = "left";
                        slam.flipper = 62;
                    } else if(slam.x < hero.x - 30) {
                        slam.flip = "right";
                        slam.flipper = 62;
                    } else {
                        slam.y += 90;
                        slam.rep.y += 90;
                    }
                }
            } 
            if(hero.vy < 0.2) {
                hero.grounded = getPlatformUnder(hero);
            } else {
                hero.y -= hero.vy;
                hero.vy *= -0.4;
            }
        }
        if(keys.ArrowLeft) {
            hero.vx = -hero.vvx;
            if(clipPlatform(hero) && !hero.grounded) {
                hero.vx = 0;
            }
        }
        if(keys.ArrowRight) {
            hero.vx = hero.vvx;
            if(clipPlatform(hero) && !hero.grounded) {
                hero.vx = 0;
            }
        }
        if(keys.ArrowUp) {
            if(getPlatformUnder(hero) < hero.height) {
                hero.vy = -5;
                hero.grounded = false;
            }
        }
        hero.x += hero.vx;
        hero.vx = hero.vx > friction ? hero.vx -= friction : hero.vx > 0 ? hero.vx = 0 : hero.vx < -friction ? hero.vx += friction : hero.vx = 0;
        blobs.forEach(function(blob){
            /// Physics
            if(blob.grounded === getPlatformUnder(blob)) {

            } else {
                blob.vy += fall;
                blob.y += blob.vy;
                blob.grounded = false;
            }
            if(getPlatformUnder(blob) < 0) {
                while(getPlatformUnder(blob) < 0) {
                    blob.y += 0.1;
                }
                blob.vy *= -0.8;
            } else if(getPlatformUnder(blob) < blob.height - blob.height / 3) {
                if(blob.vy < 0.2) {
                    blob.grounded = getPlatformUnder(blob);
                } else {
                    blob.y -= blob.vy;
                    blob.vy *= -0.4;
                }
            }
            /// AI
            /// If the player is on the same platform level or a lower one...
            if(blob.y - hero.y < 275 && ! blob.jump){
                if(hero.x < blob.x) {
                    blob.vx = -blob.vvx;
                    if(clipPlatform(blob) && !blob.grounded) {
                        blob.vx = 0;
                    }
                }
                if(hero.x > blob.x) {
                    blob.vx = blob.vvx;
                    if(clipPlatform(blob) && !blob.grounded) {
                        blob.vx = 0;
                    }
                }
                if(hero.y < blob.y) {
                    if(getPlatformUnder(blob) < blob.height) {
                        blob.vy = -5;
                        blob.grounded = false;
                    }
                }
            } else {
                /// Make for the nearest low platform.
                if(blob.jump) {
                    if(blob.target.x < blob.x && blob.x - blob.target.x > 20) {
                        blob.vx = -blob.vvx;
                        if(clipPlatform(blob) && !blob.grounded) {
                            blob.vx = 0;
                        }
                    }
                    if(blob.target.x > blob.x && -blob.x + blob.target.x > 20) {
                        blob.vx = blob.vvx;
                        if(clipPlatform(blob) && !blob.grounded) {
                            blob.vx = 0;
                        }
                    }
                    if(blob.grounded) {
                        blob.jump = false;
                    }
                } else {
                    var nearestPlatform = {x:Infinity,y:Infinity};
                    platforms.forEach(function(platform){
                        if(blob.y - platform.y < 250 && blob.y - platform.y > 150 ) {
                            if(getDistance(nearestPlatform.x,nearestPlatform.y,blob.x,blob.y) > getDistance(platform.x,platform.y,blob.x,blob.y)) {
                                nearestPlatform = platform;
                            }
                        }
                    });
                    if(Math.abs(blob.x - nearestPlatform.x) < 200 && Math.abs(blob.x - nearestPlatform.x) > 175) {
                        if(getPlatformUnder(blob) < blob.height) {
                            blob.vy = -6;
                            blob.grounded = false;
                            blob.jump = true;
                            blob.target = nearestPlatform;
                        }
                    }
                    if(blob.grounded) {
                        if(nearestPlatform.x + 200 < blob.x && blob.x - nearestPlatform.x + 200 > 20) {
                            blob.vx = -blob.vvx;
                            if(clipPlatform(blob) && !blob.grounded) {
                                blob.vx = 0;
                            }
                        }
                        if(nearestPlatform.x + 200 > blob.x  && -blob.x + nearestPlatform.x + 200 > 20) {
                            blob.vx = blob.vvx;
                            if(clipPlatform(blob) && !blob.grounded) {
                                blob.vx = 0;
                            }
                        }
                    } else {
                        if(nearestPlatform.x < blob.x && blob.x - nearestPlatform.x > 20) {
                            blob.vx = -blob.vvx;
                            if(clipPlatform(blob) && !blob.grounded) {
                                blob.vx = 0;
                            }
                        }
                        if(nearestPlatform.x > blob.x && -blob.x + nearestPlatform.x < 20) {
                            blob.vx = blob.vvx;
                            if(clipPlatform(blob) && !blob.grounded) {
                                blob.vx = 0;
                            }
                        }
                    }
                }
            }
            blob.x += blob.vx;
            blob.vx = blob.vx > friction ? blob.vx -= friction : blob.vx > 0 ? blob.vx = 0 : blob.vx < -friction ? blob.vx += friction : blob.vx = 0;
            if(hitTestRectangle(hero,blob,5,5)) {
                healthBar.outer.width -= 1;
                if(healthBar.outer.width < 1) {
                    state = lose;
                }
            }
        });
        platformSprites.forEach(function(p){
            if(p.flip === "left") {
                --p.flipper;
                p.rotation -= 0.1;
                if(p.flipper === 0) {
                    p.rotation = 0;
                    p.flip = false;
                    if(clipPlatform(hero)) {
                        hero.y += hero.vy;
                        var tally = 0;
                        while(clipPlatform(hero)) {
                            hero.y += 0.1;
                            tally += 0.1;
                        }
                        hero.y -= tally + hero.vy;
                        hero.vy += tally / 2;
                    }
                }
            }
            if(p.flip === "right") {
                --p.flipper;
                p.rotation += 0.1;
                if(p.flipper === 0) {
                    p.rotation = 0;
                    p.flip = false;
                    while(clipPlatform(hero)) {
                        hero.y += 0.1;
                    }
                }
                if(clipPlatform(hero)) {
                    hero.y += hero.vy;
                    var tally = 0;
                    while(clipPlatform(hero)) {
                        hero.y += 0.1;
                        tally += 0.1;
                    }
                    hero.y -= tally + hero.vy;
                    hero.vy += tally / 2;
                }
            }
        });
        treasures.forEach(function(treasure,i){
            if(treasure.grounded === getPlatformUnder(treasure)) {

            } else {
                treasure.vy += fall;
                treasure.y += treasure.vy;
                treasure.grounded = false;
            }
            if(getPlatformUnder(treasure) < 0) {
                while(getPlatformUnder(treasure) < 0) {
                    treasure.y += 0.1;
                }
                treasure.vy *= -0.8;
            } else if(getPlatformUnder(treasure) < treasure.height) {
                if(treasure.vy < 0.2) {
                    treasure.grounded = getPlatformUnder(treasure);
                } else {
                    treasure.y -= treasure.vy;
                    treasure.vy *= -0.4;
                }
            }
            if(hitTestRectangle(treasure,hero)) {
                app.stage.removeChild(treasure);
                treasures.splice(i,1);
            }
        });
    }
    function lose() {
        
    }
    function getPlatformUnder(sprite) {
        var lowestDistance = innerHeight - sprite.y;
        platformSprites.forEach(function(p){
            if(sprite.x > p.x - 75 && sprite.x < p.x + 75 && !p.flip) {
                if(p.y - sprite.y < lowestDistance && p.y >= sprite.y - 30) {
                    lowestDistance = p.y - sprite.y;
                }
            }
        });
        return lowestDistance;
    }
    function returnPlatformUnder(sprite) {
        var lowestDistance = innerHeight - sprite.y;
        var platformSprite = false;
        platformSprites.forEach(function(p,i){
            if(sprite.x > p.x - 75 && sprite.x < p.x + 75) {
                if(p.y - sprite.y < lowestDistance && p.y >= sprite.y - 30) {
                    lowestDistance = p.y - sprite.y;
                    platformSprite = p;
                }
            }
        });
        return platformSprite;
    }
    function clipPlatform(sprite){
        var res = false;
        platformSprites.forEach(function(p){
            if(sprite.y - sprite.height / 2 > p.y - 32 && sprite.y + sprite.height / 2 < p.y + 50 && !p.flip) {
                if(sprite.x + sprite.width / 2 > p.x - 70 && sprite.x - sprite.width / 2 < p.x + 70) {
                    res = true;
                }
            }
        });
        return res;
    }
    function press(key){
        if(keys[key]){
            keys[key] = false;
            return true;
        }
        return false;
    }
    addEventListener("mousedown",function(e){
        if(e.button == 0) {
            keys.mouse = true;
        } else if(e.button == 2) {
            keys.rightMouse = true;
        }
        mouseX = e.pageX;
        mouseY = e.pageY;
    });
    addEventListener("mouseup",function(e){
        if(e.button == 0) { 
            keys.mouse = false;
        } else if(e.button == 2) {
            keys.rightMouse = true;
        }
    });
    addEventListener("blur", function (){
        keys = {};
    });
    addEventListener("mousemove",function(e){
        mouseX = e.pageX;
        mouseY = e.pageY;
    });
    addEventListener("keydown", function (e){
        keys[e.key] = true;
    });
    addEventListener("keyup", function (e){
        keys[e.key] = false;
    });
  </script>
</body>
</html>