<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Ship Shooter</title>
</head>
    <style>* {padding: 0; margin: 0}</style>
    <script src="pixi/pixi.min.js"></script>
    <script src="usefulFunctions.js"></script>
    <script src ="bump.js"></script>
<body>
  <script type="text/javascript">
    var b = new Bump(PIXI);
    var params = getParams();
    function getParams() {
      var params = {};
      location.search.substr(1).split("&").forEach(function(el) {
        var data = el.replace(/\+/g, " ").split("=");
        params[decodeURIComponent(data[0])] = data[1] ? decodeURIComponent(data[1]) : true;
      });
      return params;
    }
    var debug = params.debug || false;
    PIXI.utils.skipHello();
    PIXI.settings.SCALE_MODE = PIXI.SCALE_MODES.NEAREST;
    let Application = PIXI.Application,
        Container = PIXI.Container,
        loader = PIXI.loader,
        resources = PIXI.loader.resources,
        TextureCache = PIXI.utils.TextureCache,
        Sprite = PIXI.Sprite,
        Rectangle = PIXI.Rectangle,
        Graphics = PIXI.Graphics;
    let app = new Application({ 
        width: 800,
        height: 800,              
        antialias: true,
        transparent: false,
        resolution: 1
      }
    );
    app.renderer.backgroundColor = 0x7777FF;
    /// Fill the screen 
    app.renderer.view.style.position = "absolute";
    app.renderer.view.style.display = "block";
    app.renderer.autoResize = true;
    app.renderer.resize(window.innerWidth, window.innerHeight);
    document.body.appendChild(app.view);
    var fireCannon = false;
    loader.add("sprites/topDownShip.png").add("sprites/cannonball.png").add("sprites/pirateshipblack.png").add("sprites/pirateshipred.png").load(setup);
    var ship, windSpeed, windDirection;
    var pirateShips = [];
    var cannonballSpeed = 10;
    var cannonballs = 41;
    var HUD = new PIXI.Text("Cannonballs: "+cannonballs.toString());
    HUD.x = 1100;
    app.stage.addChild(HUD);
    var pirateShip, graphics;
    function setup() {
      pirateShip = new Sprite(resources["sprites/pirateshipblack.png"].texture);
      pirateShip.scale.x = 10;
      pirateShip.scale.y = 10;
      pirateShip.direction = 90;
      pirateShip.speed = 1;
      pirateShip.lastFire = Date.now() - 25000;
      pirateShip.shouldFire = true;
      pirateShip.anchor.set(0.5, 0.5);
      pirateShip.position.set(200,200)
      pirateShip.rotation = pointInDirection(pirateShip.direction + 90);
      pirateShips.push(pirateShip)
      app.stage.addChild(pirateShip);
      ship = new Sprite(resources["sprites/topDownShip.png"].texture);
      ship.scale.x = 10;
      ship.scale.y = 10;
      app.stage.addChild(ship);
      app.renderer.render(app.stage);
      ship.vx = 0;
      ship.vy = 0;
      ship.x = 500
      ship.y = 500;
      ship.direction = 90;
      ship.speed = 1;
      ship.turn = 0
      ship.anchor.set(0.5, 0.5);
      var left = keyboard("ArrowLeft"), right = keyboard("ArrowRight"), up = keyboard("ArrowUp"), down = keyboard("ArrowDown");
      var space = keyboard(" "), a = keyboard("a"), d = keyboard("d");
      space.press = () => {
        fireCannon = 2;
      }
      a.press = () => {
        fireCannon = 1;
      }
      d.press = () => {
        fireCannon = -1;
      }
      left.press = () => {
        ship.turn = 1;
      }
      left.release = () => {
        ship.turn = 0;
      };
      right.press = () => {
        ship.turn = -1;
      }
      right.release = () => {
        ship.turn = 0;
      }
      up.press = () => {
        ++ship.speed
      }
      down.press = () => {
        if(ship.speed > 0) {
          --ship.speed
        }
      }
      if(debug) {
        graphics = new PIXI.Graphics();
        graphics.beginFill(0xFF0000);
        graphics.alpha = 0.5;
        graphics.drawRect((ship.x - ship.width / 2), (ship.y - ship.height / 2), ship.width, ship.height);
        graphics.drawPolygon([100,100,100,200,200,200,200,100]);
      }
      app.stage.addChild(graphics);
      app.ticker.add(delta => gameLoop(delta));
      windSpeed = 1;
      windDirection = 90;
      setTimeout(changeWind,30000 + randInt(-10000,10000))
    }
    function changeWind() {
      windSpeed = randInt(0,5);
      windDirection = randInt(0,360);
      setTimeout(changeWind,30000 + randInt(-10000,10000));
    }
    var shots = []
    function drawCollision(){
      graphics.clear();
      graphics.beginFill(0xFF0000);
      graphics.alpha = 0.5;
      var point1 = rotatePoint((ship.x - ship.width / 2), (ship.y - ship.height / 2),ship.x,ship.y,ship.rotation);
      var point2 = rotatePoint((ship.x - ship.width / 2), (ship.y + ship.height / 2),ship.x,ship.y,ship.rotation);
      var point3 = rotatePoint((ship.x + ship.width / 2), (ship.y + ship.height / 2),ship.x,ship.y,ship.rotation);
      var point4 = rotatePoint((ship.x + ship.width / 2), (ship.y - ship.height / 2),ship.x,ship.y,ship.rotation);
      //var path = [(ship.x - ship.width / 2), (ship.y - ship.height / 2),(ship.x - ship.width / 2), (ship.y + ship.height / 2),(ship.x + ship.width / 2), (ship.y + ship.height / 2),(ship.x + ship.width / 2), (ship.y - ship.height / 2)]
      var path = [point1.x,point1.y, point2.x,point2.y,point3.x,point3.y,point4.x,point4.y];
      graphics.drawPolygon(path);
    }
    function gameLoop(delta) {
      var data = direction(ship.speed,ship.direction);
      ship.vx = data.r;
      ship.vy = data.u;
      ship.x += ship.vx;
      ship.y += ship.vy;
      ship.point1 = rotatePoint((ship.x - ship.width / 2), (ship.y - ship.height / 2),ship.x,ship.y,ship.rotation);
      ship.point2 = rotatePoint((ship.x - ship.width / 2), (ship.y + ship.height / 2),ship.x,ship.y,ship.rotation);
      ship.point3 = rotatePoint((ship.x + ship.width / 2), (ship.y + ship.height / 2),ship.x,ship.y,ship.rotation);
      ship.point4 = rotatePoint((ship.x + ship.width / 2), (ship.y - ship.height / 2),ship.x,ship.y,ship.rotation);
      ship.anchor.x = 0.5;
      ship.anchor.y = 0.5;
      if(debug){
        drawCollision();  
      }
      pirateShips.forEach(function(pShip){
        var badData = direction(pShip.speed, pShip.direction);
        pShip.vx = badData.r;
        pShip.vy = badData.u;
        pShip.x += pShip.vx;
        pShip.y += pShip.vy;
        var fireRotation1 = pointTowards(pShip.x, pShip.y, ship.x, ship.y);
        var fireRotation2 = pointTowards(pShip.x, pShip.y, ship.x, ship.y) + 180;
        if((Math.abs(fireRotation1-(pShip.direction + 90)) < 20 || Math.abs(fireRotation2-(pShip.direction+90)) < 20)&& pShip.lastFire + 2500 < Date.now()) {
          pirateShip.lastFire = Date.now();
          addNewCannonball(90, 0, pShip);
          addNewCannonball(-90, 0, pShip);
          pShip.shouldFire = false;
        } else if (getDistance(pShip.x, pShip.y, ship.x, ship.y) > 850 && true) {
          var pointTowardsShip = pointTowards(pShip.x, pShip.y, ship.x, ship.y) - 180;
          if(pointTowardsShip < 0) {
            pointTowardsShip += 360;
          }
          var calcDirection = pShip.direction;
          var turnLeftDistance = 0;
          for(let i = 0; i < 360; i++) {
            calcDirection++;
            if(calcDirection > 359) {
              calcDirection = 0;
            }
            if(Math.abs(pointTowardsShip - calcDirection)<10) {
              turnLeftDistance = i+1;
              calcDirection = pShip.direction;
              break;
            }
          }
          var turnRightDistance = 0;
          calcDirection = pShip.direction;
          var rightData = [];
          for(let i = 0; i < 360; i++) {
            calcDirection--;
            if(calcDirection < 0) {
              calcDirection = 359;
            }
            rightData.push(calcDirection, pointTowardsShip);
            if(Math.abs(pointTowardsShip - calcDirection)<10) {
              turnRightDistance = i+1;
              calcDirection = pShip.direction;
              break;
            }
          }
          if(turnLeftDistance < turnRightDistance) {
            pShip.direction += 0.25
          } else if (turnRightDistance < turnLeftDistance){
            pShip.direction -= 0.25
          }
        } else {
            if(Math.abs(fireRotation1-(pShip.direction + 90)) < Math.abs(fireRotation2-(pShip.direction+90))) {
              if((Math.abs(fireRotation1-(pShip.direction + 91)) < Math.abs(fireRotation1-(pShip.direction + 89)))) {
                pShip.direction += 0.25;
              } else {
                pShip.direction -= 0.25;
              }
            } else {
              if((Math.abs(fireRotation2-(pShip.direction + 91)) < Math.abs(fireRotation2-(pShip.direction + 89)))) {
                pShip.direction += 0.25;
              } else {
                pShip.direction -= 0.25;
              }
            } 
        }
        pShip.rotation = pointInDirection(pShip.direction+90); 
      });
      shots.forEach(function(shot, i){
        var newData = direction(shot.speed, shot.direction);
        shot.x += newData.r + shot.offset.r;
        shot.y += newData.u + shot.offset.u;
        if(shot.x < -50 || shot.x > 1450 || shot.y < -50 || shot.y > 1000) {
          app.stage.removeChild(shot);
          shots.splice(i, 1);
        }
        if(b.hit(shot, pirateShips) && shot.id == 1) {
          pirateShip.visible = false;
          app.stage.removeChild(shot);
          shots.splice(i, 1);
        }
        if(circleInRectangle([[ship.point1.x, ship.point1.y], [ship.point2.x, ship.point2.y], [ship.point3.x, ship.point3.y],[ship.point4.x, ship.point4.y]],[shot.x, shot.y],shot.width/2) && shot.id == 0) {
          ship.visible = false;
          app.stage.removeChild(shot);
          shots.splice(i, 1);
        }
      });
      ship.rotation = ((ship.direction + 90) * Math.PI * -1) / 180;
      ship.direction += ship.turn;
      if(fireCannon === 2) {
        if(cannonballs > 0) {
          addNewCannonball(90, 1, ship);
          --cannonballs;
        }
        if(cannonballs > 0) {
          addNewCannonball(-90, 1, ship);
          --cannonballs;
        }
        HUD.text = "Cannonballs: "+cannonballs.toString();
        fireCannon = false;
      } else if(fireCannon === 1) {
        if(cannonballs > 0) {
          addNewCannonball(90, 1, ship);
          --cannonballs;
        }
        HUD.text = "Cannonballs: "+cannonballs.toString();
        fireCannon = false;
      } else if (fireCannon === -1) {
        if(cannonballs > 0) {
          addNewCannonball(-90, 1, ship);
          --cannonballs;
        }
        HUD.text = "Cannonballs: "+cannonballs.toString();
        fireCannon = false;
      }
    }
    function addNewCannonball(offset, id, launcher) {
      offset = offset || 0;
      let cannonball = new Sprite(resources["sprites/cannonball.png"].texture);
      cannonball.scale.set(0.25,0.25);
      cannonball.speed = cannonballSpeed;
      cannonball.direction = launcher.direction + offset;
      cannonball.position.set(launcher.x, launcher.y);
      cannonball.offset = direction(launcher.speed,launcher.direction);
      let newData = direction(50, cannonball.direction);
      cannonball.x += newData.r + cannonball.offset.r;
      cannonball.y += newData.u + cannonball.offset.u;
      cannonball.id = id;
      shots.push(cannonball);
      app.stage.addChild(cannonball);
    }
    function keyboard(value) {
      let key = {};
      key.value = value;
      key.isDown = false;
      key.isUp = true;
      key.press = undefined;
      key.release = undefined;
      //The `downHandler`
      key.downHandler = event => {
        if (event.key === key.value) {
          if (key.isUp && key.press) key.press();
          key.isDown = true;
          key.isUp = false;
          event.preventDefault();
        }
      };

      //The `upHandler`
      key.upHandler = event => {
        if (event.key === key.value) {
          if (key.isDown && key.release) key.release();
          key.isDown = false;
          key.isUp = true;
          event.preventDefault();
        }
      };

      //Attach event listeners
      const downListener = key.downHandler.bind(key);
      const upListener = key.upHandler.bind(key);
      
      window.addEventListener(
        "keydown", downListener, false
      );
      window.addEventListener(
        "keyup", upListener, false
      );
      
      // Detach event listeners
      key.unsubscribe = () => {
        window.removeEventListener("keydown", downListener);
        window.removeEventListener("keyup", upListener);
      };
      
      return key;
    }
  </script>
</body>
</html>