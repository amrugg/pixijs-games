<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Direction ship</title>
</head>
    <style>* {padding: 0; margin: 0}</style>
    <script src="pixi/pixi.min.js"></script>
    <script src="usefulFunctions.js"></script>
<body>
  <script type="text/javascript">
    var params = getParams();
    function getParams() {
      var params = {};
      location.search.substr(1).split("&").forEach(function(el) {
        var data = el.replace(/\+/g, " ").split("=");
        params[decodeURIComponent(data[0])] = data[1] ? decodeURIComponent(data[1]) : true;
      });
      return params;
    }
    PIXI.utils.skipHello();
    PIXI.settings.SCALE_MODE = PIXI.SCALE_MODES.NEAREST;
    let Application = PIXI.Application,
        Container = PIXI.Container,
        loader = PIXI.loader,
        resources = PIXI.loader.resources,
        TextureCache = PIXI.utils.TextureCache,
        Sprite = PIXI.Sprite,
        Rectangle = PIXI.Rectangle,
        Graphics = PIXI.Graphics;
    let app = new Application({ 
        width: 800,
        height: 800,              
        antialias: true,
        transparent: false,
        resolution: 1
      }
    );
    app.renderer.backgroundColor = 0x000000;
    /// Fill the screen 
    app.renderer.view.style.position = "absolute";
    app.renderer.view.style.display = "block";
    app.renderer.autoResize = true;
    app.renderer.resize(window.innerWidth, window.innerHeight);
    document.body.appendChild(app.view);
    loader.add("sprites/redbar.png").add("sprites/bluebar.png").add("sprites/ball.png").load(setup);
    var state;
    var keys = {};
    var enemy;
    var balls = [];
    var player;
    var playerText = new PIXI.Text("Health: 1000\nGold: 0");
    playerText.style.fill = "#ffff00";
    app.stage.addChild(playerText);
    var enemyText = new PIXI.Text("Health: 1000\nGold: 0");
    enemyText.style.fill = "#ff5500";
    app.stage.addChild(enemyText);
    enemyText.x = innerWidth - 150;
    function setup() {
        player = new Sprite(resources["sprites/bluebar.png"].texture);
        enemy = new Sprite(resources["sprites/redbar.png"].texture);
        spawnBall(-90);
        app.stage.addChild(player);
        app.stage.addChild(enemy);
        player.anchor.set(0.5);
        enemy.anchor.set(0.5);
        player.x += 20;
        enemy.x = innerWidth - 20;
        player.y = enemy.y = innerHeight / 2;
        player.health = 1000;
        enemy.health = 1000;
        player.gold = 0;
        enemy.gold = 0;
        player.income = 1;
        enemy.income = 1;
        state = play;
        app.ticker.add(delta => gameLoop(delta));
    }
    function gameLoop(delta) {
        state(delta);
    }
    function spawnBall(direction) {
        var ball = new Sprite(resources["sprites/ball.png"].texture);
        app.stage.addChild(ball);
        ball.x = innerWidth / 2;
        ball.y = innerHeight / 2;
        ball.scale.set(0.2);
        ball.speed = 5;
        ball.friction = 0.001;
        ball.direction = typeof direction == "number" ? direction : Math.random() * 360;
        ball.damage = 5;
        ball.anchor.set(0.5);
        balls.push(ball);
    }
    function play() {
        balls.forEach(function(ball,i){
            function bounceBall(dir,vy){
                if(dir === "vertically") {
                    ball.direction = 180 - ball.direction;
                } else if(dir === "horizontally") {
                    ball.direction *= -1;
                } else if(dir === "diagonally") {
                    ball.direction += 180;
                }
                ball.direction += 5 * vy;
                player.gold += player.income;
                enemy.gold += enemy.income;
                    
                var data = direction(5,ball.direction);
                ball.x += data.r;
                ball.y += data.u;
            }
            var data = direction(ball.speed,ball.direction);
            ball.x += data.r;
            ball.y += data.u;
            if(ball.y > innerHeight - 10) {
                bounceBall("vertically");
            } else if(ball.y < 10) {
                bounceBall("vertically");
            }
            if(ball.x > innerWidth - 10) {
                enemy.health -= ball.damage;
                player.gold += ball.damage;
                app.stage.removeChild(ball);
                balls.splice(i,1);
            } else if(ball.x < 10) {
                player.health -= ball.damage;
                enemy.gold += ball.damage;
                app.stage.removeChild(ball);
                balls.splice(i,1);
            }
            if(Math.abs(ball.x-player.x) < 20 && Math.abs(ball.y-player.y) < 37){
                var side = 0;
                if(Math.abs((ball.x - data.r) - player.x) < 20) {
                    side += 0.5;
                }
                if(Math.abs((ball.y - data.u) - player.y) < 37) {
                    side += 1;
                }
                if(side > 1 || side < 0.2) {
                    bounceBall("diagonally",player.vy);
                } else if(side > 0.5) {
                    bounceBall("horizontally",player.vy);
                } else {
                    bounceBall("vertically",player.vy);
                }
            }
            if(Math.abs(ball.x-enemy.x) < 20 && Math.abs(ball.y-enemy.y) < 37){
                var side = 0;
                if(Math.abs((ball.x - data.r) - enemy.x) < 20) {
                    side += 0.5;
                }
                if(Math.abs((ball.y - data.u) - enemy.y) < 37) {
                    side += 1;
                }
                if(side > 1 || side < 0.2) {
                    bounceBall("diagonally",enemy.vy);
                } else if(side > 0.5) {
                    bounceBall("horizontally",enemy.vy);
                } else {
                    bounceBall("vertically",enemy.vy);
                }
            }
            ball.speed -= ball.friction;
            if(ball.speed < 1) {
                app.stage.removeChild(ball);
                balls.splice(i,1);
            }
            player.vy = 0;
            if(keys.ArrowUp) {
                player.vy -= 3;
            }
            if(keys.ArrowDown) {
                player.vy += 3;
            }
            player.y += player.vy;
            if(Math.floor((ball.y-enemy.y)/20) > 0) {
                enemy.y += 5;
                enemy.vy = 5;
            } else if(Math.floor((ball.y-enemy.y)/20) < 0){
                enemy.y -= 5;
                enemy.vy = -5;
            }
        });
        if(!balls.length) {
            spawnBall();
        }
        playerText.text = "Health: " + player.health + "\nGold: " + player.gold;
        enemyText.text = "Health: " + enemy.health + "\nGold: " + enemy.gold;
    }
    addEventListener("blur", function (){
        keys = {};
    });
    addEventListener("keydown", function (e){
        keys[e.key] = true;
    });
    addEventListener("keyup", function (e){
        keys[e.key] = false;
    });
  </script>
</body>
</html>