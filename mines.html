<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Minesweeper</title>
</head>
    <style>* {padding: 0; margin: 0}</style>
    <script src="pixi/pixi.min.js"></script>
    <script src="usefulFunctions.js"></script>
<body>
  <script type="text/javascript">
    var params = getParams();
    function getParams() {
      var params = {};
      location.search.substr(1).split("&").forEach(function(el) {
        var data = el.replace(/\+/g, " ").split("=");
        params[decodeURIComponent(data[0])] = data[1] ? decodeURIComponent(data[1]) : true;
      });
      return params;
    }
    PIXI.utils.skipHello();
    PIXI.settings.SCALE_MODE = PIXI.SCALE_MODES.NEAREST;
    let Application = PIXI.Application,
        Container = PIXI.Container,
        loader = PIXI.loader,
        resources = PIXI.loader.resources,
        TextureCache = PIXI.utils.TextureCache,
        Sprite = PIXI.Sprite,
        Rectangle = PIXI.Rectangle,
        Graphics = PIXI.Graphics;
    let app = new Application({ 
        width: 800,
        height: 800,              
        antialias: true,
        transparent: true,
        resolution: 1
      }
    );
    app.renderer.backgroundColor = 0x55DD55;
    /// Fill the screen 
    app.renderer.view.style.position = "absolute";
    app.renderer.view.style.display = "block";
    app.renderer.autoResize = true;
    app.renderer.resize(window.innerWidth, window.innerHeight);
    document.body.appendChild(app.view);
    loader.add("sprites/treasureHunter.json").load(setup);
    var state;
    var keys = {};
    var boardArr = [];
    var mineNum = params.mines || 10;
    var boardSize = Number(params.size);
    var board = new PIXI.Graphics();
    var mouseX, mouseY, startingX, startingY;
    var mineShots = Math.floor(mineNum*1.25);
    var shotsText;
    function setup() {
        shotsText = new PIXI.Text("Mine Shots Left:");
        shotsText.text = "Mine Shots Left: " +mineShots.toString();
        app.stage.addChild(shotsText);
        state = drawBoard;
        app.stage.addChild(board);
        app.ticker.add(delta => gameLoop(delta));
    }
    function gameLoop(delta) {
      state(delta);
    }
    function drawBoard(){
        startingX = (innerWidth - (boardSize+1) * 50)/ 2 < innerWidth - ((boardSize+1)*50)?(innerWidth - (boardSize+1)*50) / 2:innerWidth - (500);
        startingY = (innerHeight - (boardSize+1)*50) / 2
        for(let j = boardSize; j > 0; j--) {
            for(let i = boardSize; i > 0; i--) {
                board.lineStyle(2,0,1);
                board.beginFill(0xFFFFFF);
                board.drawRect(startingX + i*50,startingY+j*50,50,50);
                board.endFill();
            }
        }
        state = generateBoard;
    }
    function generateBoard(){
        var mines = mineNum;
        var squaresLeft = (boardSize**2)-4;
        for(let i = 0; i < boardSize; i++) {
            boardArr.push([]);
            for(let j = 0; j < boardSize; j++) {
                if(Math.probability(mines * 100 / squaresLeft) && (i > 0  || (j > 0 && j < boardSize - 1)) && (i < boardSize - 1 || (j > 0 && j < boardSize - 1))) {
                    console.log("Added Mine");
                    mines--;
                    boardArr[i].push("M")
                } else {
                    boardArr[i].push("CONSIDER");
                }
                --squaresLeft;
            }
        }
        for(let i = 0; i < boardArr.length; i++) {
            for(let j = 0; j < boardArr.length; j++) {
                if(boardArr[i][j] == "CONSIDER") {
                    let thisSquareCount = 0;
                    if (i < boardSize-1) {
                        if(boardArr[i + 1][j] == "M") {
                            thisSquareCount++;
                        }
                        if(j > 0) {
                            if(boardArr[i + 1][j - 1] == "M") {
                                thisSquareCount++;
                            }
                        }
                        if(j < boardSize-1) {
                            if(boardArr[i + 1][j + 1] == "M") {
                                thisSquareCount++;
                            }
                        }
                    }
                    if(j < boardSize-1) {
                        if(boardArr[i][j + 1] == "M") {
                            thisSquareCount++;
                        }
                    }
                    if(j > 0) {
                    if(boardArr[i][j - 1] == "M") {
                        thisSquareCount++;
                    }
                    }
                    if(i > 0) {
                        if(boardArr[i - 1][j] == "M") {
                            thisSquareCount++;
                        }
                        if(j < boardSize-1) {
                            if(boardArr[i - 1][j + 1] == "M") {
                                thisSquareCount++;
                            }
                        }
                        if(j > 0) {
                            if(boardArr[i - 1][j - 1] == "M") {
                                thisSquareCount++;
                            }
                        }
                    }
                    boardArr[i][j] = thisSquareCount.toString();
                }
            }
        }
        console.log(boardArr);
        state = play;
    }
    function play(){
        if(press("mouse")) {
            let testMouseX = mouseX - startingX;
            let testMouseY = mouseY - startingY;
            /// Chosen square will be Math.floor
            var chosenX = Math.floor(testMouseX / 50);
            var chosenY = Math.floor(testMouseY / 50);
            if((startingX + (chosenX * 50) - 50 >= startingX && (startingY + (chosenY * 50) - 50) >= startingY)) {
                if((startingX + (chosenX * 50) - 50) < startingX + boardSize * 50 && startingY + (chosenY * 50) - 50 < startingY + boardSize*50) {
                    chooseSquare(chosenX,chosenY);
                }
            }
        }
        if(press("rightMouse") && mineShots > 0) {
            let testMouseX = mouseX - startingX;
            let testMouseY = mouseY - startingY;
            /// Chosen square will be Math.floor
            var chosenX = Math.floor(testMouseX / 50);
            var chosenY = Math.floor(testMouseY / 50);
            if((startingX + (chosenX * 50) - 50 >= startingX && (startingY + (chosenY * 50) - 50) >= startingY)) {
                if((startingX + (chosenX * 50) - 50) < startingX + boardSize * 50 && startingY + (chosenY * 50) - 50 < startingY + boardSize * 50) {
                    if(boardArr[chosenY-1][chosenX-1] == "M") {
                        drawBoardSquare(chosenX,chosenY,0x00FF00);
                        mineShots--;
                        shotsText.text = "Mine Shots Left: " +mineShots.toString();
                    } else if(boardArr[chosenY-1][chosenX-1] !== "FINISHED"){
                        boardArr[chosenY-1][chosenX-1] = "X";
                        drawBoardSquare(chosenX,chosenY,0xFF0000)
                        mineShots--;
                        shotsText.text = "Mine Shots Left: " +mineShots.toString();
                    }
                    console.log(boardArr[chosenY-1][chosenX-1]);
                    var complete = true;
                    boardArr.forEach(function(e,j){
                        for(let i = 0; i < e.length; i++) {
                            if(e[i] !== "FINISHED" && (j !== chosenY || i !== chosenX )) {
                                complete = false;
                            }
                        }
                    });
                    if(complete) {
                        alert("You win!");
                    }
                }
            }
        }
    }
    function chooseSquare(x,y) {
        if(boardArr[y-1][x-1] == "M") {
            drawBoardSquare(x,y,0xFF0000);
            state = lose;
        } else if(boardArr[y-1][x-1] !== "FINISHED") {
            drawBoardSquare(x,y);
            var complete = true;
            boardArr.forEach(function(e,j){
                for(let i = 0; i < e.length; i++) {
                    if(e[i] !== "FINISHED" && (j !==y || i !== x )) {
                        complete = false;
                    }
                }
            });
            if(complete) {
                alert("You win!");
            }
        }
    }
    function lose(){
        alert("You hit a mine! You lose!");
        app.ticker.stop();
    }
    function drawBoardSquare(x,y,color){
        if(boardArr[y-1][x-1] !== "FINISHED") {
            var boardSquareText = new PIXI.Text("");
            // console.log(x,y);
            boardSquareText.text = boardArr[y-1][x-1].toString();
            boardSquareText.x = startingX + x*50;
            boardSquareText.y = startingY + y*50;
            app.stage.addChild(boardSquareText);
            if(color) {
                board.lineStyle(2,0,1);
                board.beginFill(color);
                board.drawRect(startingX + x * 50, startingY + y * 50, 50,50);
                board.endFill();
            }
            boardArr[y-1][x-1] = "FINISHED";
        }
    }
    function press(key){
        if(keys[key]){
            keys[key] = false;
            return true;
        }
        return false;
    }
    addEventListener("blur", function (){
        keys = {};
    });
    addEventListener("mousedown",function(e){
        if(e.button == 0) {
            keys.mouse = true;
        } else if(e.button == 2) {
            keys.rightMouse = true;
        }
        mouseX = e.pageX;
        mouseY = e.pageY;
    });
    addEventListener("mouseup",function(e){
        if(e.button == 0) { 
            keys.mouse = false;
        } else if(e.button == 2) {
            keys.rightMouse = true;
        }
    });
    window.addEventListener("contextmenu",function(e){
        e.preventDefault();
    });
    addEventListener("mousemove",function(e){
        mouseX = e.pageX;
        mouseY = e.pageY;
    })
    addEventListener("keydown", function (e){
        keys[e.key] = true;
    });
    addEventListener("keyup", function (e){
        keys[e.key] = false;
    });
  </script>
</body>
</html>