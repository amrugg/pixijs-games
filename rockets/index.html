<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>RA Blaster</title>
</head>
    <style>* {padding: 0; margin: 0}</style>
    <script src="pixi/pixi.min.js"></script>
    <script src="usefulFunctions.js"></script>
    <script src="howler.core.min.js"></script>
    <div id="central"></div>
    <select style="position:absolute", id="chapter">
        <option>John 12</option>
        <option>John 13</option>
        <option>John 14</option>
        <option>John 15</option>
        <option>John 16</option>
        <option>John 17</option>
        <option>John 20</option>
    </select>
    <select style="position:absolute; top: 20px", id="level">
        <option>Invincible</option>
        <option>Novice</option>
        <option>Easy</option>
        <option>Medium</option>
        <option>Hard</option>
        <option>Insane</option>
    </select>
    <input type="text" value="1-4" style="position:absolute; top: 40px", id="range">
    <button id="start", style="position: absolute; top: 60px">&nbsp;Start&nbsp;</button>
<body>
  <script type="text/javascript">
    "use strict";
    
    var params = getParams();
    function getParams() {
      var params = {};
      location.search.substr(1).split("&").forEach(function(el) {
        var data = el.replace(/\+/g, " ").split("=");
        params[decodeURIComponent(data[0])] = data[1] ? decodeURIComponent(data[1]) : true;
      });
      return params;
    }
    PIXI.utils.skipHello();
    PIXI.settings.SCALE_MODE = PIXI.SCALE_MODES.NEAREST;
    let Application = PIXI.Application,
        Container = PIXI.Container,
        loader = PIXI.loader,
        resources = PIXI.loader.resources,
        TextureCache = PIXI.utils.TextureCache,
        Sprite = PIXI.Sprite,
        Rectangle = PIXI.Rectangle,
        Graphics = PIXI.Graphics;
    let app = new Application({ 
        width: 800,
        height: 800,              
        antialias: true,
        transparent: false,
        resolution: 1
      }
    );
    var chapterEl = document.getElementById("chapter");
    var levelEl = document.getElementById("level");
    levelEl.selectedIndex = 3;
    var inputEl = document.getElementById("range");
    var buttonStartEl = document.getElementById("start");
    var invincible = false;
    chapterEl.style.zIndex = "100";
    levelEl.style.zIndex = "100";
    inputEl.style.zIndex = "100";
    buttonStartEl.style.zIndex = "100";
    buttonStartEl.addEventListener("click", function() {
        if(chapterEl.selectedIndex === 13) {
            chapter = false;
        } else {
            chapter = chapterEl.selectedIndex+1;
        }
        rangeDiv.innerHTML = inputEl.value;
        params.min = inputEl.value.split("-")[0];
        params.max = inputEl.value.split("-")[1];
        questionsLeft = params.max;

        if(levelEl.selectedIndex === 0) {
            difficulty = 1;
            invincible = true;
        } else if(levelEl.selectedIndex === 1) {
            difficulty = 0.25;
        } else if(levelEl.selectedIndex === 2) {
            difficulty = 0.5;
        } else if(levelEl.selectedIndex === 3) {
            difficulty = 0.75;
        } else if(levelEl.selectedIndex === 4) {
            difficulty = 1;
        } else if(levelEl.selectedIndex === 5) {
            difficulty = 1.25;
        }
        chapterEl.remove();
        levelEl.remove();
        inputEl.remove();
        buttonStartEl.remove();

        curVerse = randVerse();
        correctAnswer = curVerse[0];
        console.log(curVerse);
        curVerse = curVerse[1];
        textDiv.innerHTML = curVerse;

        intro.fade(0.5,0, 3000);
        setTimeout(function() {
            music.play();
            music.fade(0, 0.5, 3000);
        },3000);
        state = play;
        app.ticker.add(delta => gameLoop(delta));
    });
    var central = document.getElementById("central");
    central.style.position = "absolute";
    central.style.zIndex = "100";
    central.style.width = (innerWidth- 200) + "px";
    central.style.display = "flex";
    central.style.left = "100px";
    central.style.alignItems = "center";
    central.style.justifyContent = "center";
    app.renderer.backgroundColor = 0x000015;
    /// Fill the screen 
    app.renderer.view.style.position = "absolute";
    app.renderer.view.style.display = "block";
    app.renderer.autoResize = true;
    app.renderer.resize(window.innerWidth, window.innerHeight);
    document.body.appendChild(app.view);
    loader.add(["sprites/exp1.png","sprites/exp2.png","sprites/exp3.png", "sprites/enemy.png", "sprites/rocket.png", "sprites/laser.png", "sprites/medium.png", "sprites/emp.png", "sprites/enemyEMP.png", "sprites/boss1.png", "sprites/missile.png", "sprites/boss2.png", "sprites/drone.png", "sprites/boss3.png", "sprites/enemy-laser.png", "sprites/mothership.png"]).load(setup);
    var textDiv = document.createElement("div");
    textDiv.style.position = "relative";
    // textDiv.innerHTML = "In the beginning was the Word."
    textDiv.style.fontSize = "30px";
    textDiv.style.color = "white";
    central.appendChild(textDiv);
    var numDiv = document.createElement("div");
    numDiv.style.position = "absolute";
    numDiv.style.right = "-100px";
    numDiv.innerHTML = "";
    numDiv.style.fontSize = "30px";
    numDiv.style.color = "white";
    central.appendChild(numDiv);

    var rangeDiv = document.createElement("div");
    rangeDiv.style.position = "absolute";
    rangeDiv.style.left = "-100px";
    rangeDiv.style.top = innerHeight-40 + "px";
    rangeDiv.innerHTML = "1-4";
    params.min = 1;
    params.max = 4;
    var questionsLeft = 4;
    rangeDiv.style.fontSize = "30px";
    rangeDiv.style.color = "white";
    central.appendChild(rangeDiv);
    var energyHolder = new PIXI.Graphics();
    energyHolder.lineStyle(5, 0x00AAAA,10);
    energyHolder.beginFill(0x000015);
    energyHolder.drawRect(0,0,200,25)
    app.stage.addChild(energyHolder);
    energyHolder.x = innerWidth - 225;
    energyHolder.y = innerHeight - 50;
    var energyBar = new PIXI.Graphics();
    energyBar.lineStyle(5, 0x00AAAA,10);
    energyBar.beginFill(0x00AAAA, 10);
    energyBar.drawRect(0,0,200,25);
    energyBar.x = innerWidth - 225;
    energyBar.y = innerHeight - 50;
    app.stage.addChild(energyBar);



    var healthHolder = new PIXI.Graphics();
    healthHolder.lineStyle(5, 0xFF0000,10);
    healthHolder.beginFill(0x000015);
    healthHolder.drawRect(0,0,200,25)
    app.stage.addChild(healthHolder);
    healthHolder.x = innerWidth - 225;
    healthHolder.y = innerHeight - 100;
    var healthBar = new PIXI.Graphics();
    healthBar.lineStyle(5, 0xFF0000,10);
    healthBar.beginFill(0xFF0000, 10);
    healthBar.drawRect(0,0,200,25);
    healthBar.x = innerWidth - 225;
    healthBar.y = innerHeight - 100;
    app.stage.addChild(healthBar);
    var canUseMissiles = false;
    var canUseEMP = false;
    var canUseLaser = false;
    var intro = new Howl({src: ["music/intro.mp3"], autoplay: true, loop: true, volume: 0.5});
    var music = new Howl({src: ["music/level1.mp3"], autoplay: false, loop: true, volume: 0.5});
    /// TODO: Change intro to intro after we get intro and music to battle after the intro ends.
    var boss1 = new Howl({src: ["music/boss1.mp3"], autoplay: false, loop: true, volume: 0});
    var boss2 = new Howl({src: ["music/boss2.mp3"], autoplay: false, loop: true, volume: 0});
    var boss3 = new Howl({src: ["music/boss3.mp3"], autoplay: false, loop: true, volume: 0});
    var mothership = new Howl({src: ["music/mothership.mp3"], autoplay: false, loop: true, volume: 0});


    var rom18 = [
        ["Then Jesus six days before the passover came to Bethany, where Lazarus was which had been dead, whom he raised from the dead.", "There they made him a supper; and Martha served: but Lazarus was one of them that sat at the table with him.", "Then took Mary a pound of ointment of spikenard, very costly, and anointed the feet of Jesus, and wiped his feet with her hair: and the house was filled with the odour of the ointment.", "Then saith one of his disciples, Judas Iscariot, Simon’s son, which should betray him,", "Why was not this ointment sold for three hundred pence, and given to the poor?", "This he said, not that he cared for the poor; but because he was a thief, and had the bag, and bare what was put therein.", "Then said Jesus, Let her alone: against the day of my burying hath she kept this.", "For the poor always ye have with you; but me ye have not always.", "Much people of the Jews therefore knew that he was there: and they came not for Jesus’ sake only, but that they might see Lazarus also, whom he had raised from the dead.", "But the chief priests consulted that they might put Lazarus also to death;", "Because that by reason of him many of the Jews went away, and believed on Jesus.", "On the next day much people that were come to the feast, when they heard that Jesus was coming to Jerusalem,", "Took branches of palm trees, and went forth to meet him, and cried, Hosanna: Blessed is the King of Israel that cometh in the name of the Lord.", "And Jesus, when he had found a young ass, sat thereon; as it is written,", "Fear not, daughter of Sion: behold, thy King cometh, sitting on an ass’s colt.", "These things understood not his disciples at the first: but when Jesus was glorified, then remembered they that these things were written of him, and that they had done these things unto him.", "The people therefore that was with him when he called Lazarus out of his grave, and raised him from the dead, bare record.", "For this cause the people also met him, for that they heard that he had done this miracle.", "The Pharisees therefore said among themselves, Perceive ye how ye prevail nothing? behold, the world is gone after him.", "And there were certain Greeks among them that came up to worship at the feast:", "The same came therefore to Philip, which was of Bethsaida of Galilee, and desired him, saying, Sir, we would see Jesus.", "Philip cometh and telleth Andrew: and again Andrew and Philip tell Jesus.", "And Jesus answered them, saying, The hour is come, that the Son of man should be glorified.", "Verily, verily, I say unto you, Except a corn of wheat fall into the ground and die, it abideth alone: but if it die, it bringeth forth much fruit.", "He that loveth his life shall lose it; and he that hateth his life in this world shall keep it unto life eternal.", "If any man serve me, let him follow me; and where I am, there shall also my servant be: if any man serve me, him will my Father honour.", "Now is my soul troubled; and what shall I say? Father, save me from this hour: but for this cause came I unto this hour.", "Father, glorify thy name. Then came there a voice from heaven, saying, I have both glorified it, and will glorify it again.", "The people therefore, that stood by, and heard it, said that it thundered: others said, An angel spake to him.", "Jesus answered and said, This voice came not because of me, but for your sakes.", "Now is the judgment of this world: now shall the prince of this world be cast out.", "And I, if I be lifted up from the earth, will draw all men unto me.", "This he said, signifying what death he should die.", "The people answered him, We have heard out of the law that Christ abideth for ever: and how sayest thou, The Son of man must be lifted up? who is this Son of man?", "Then Jesus said unto them, Yet a little while is the light with you. Walk while ye have the light, lest darkness come upon you: for he that walketh in darkness knoweth not whither he goeth.", "While ye have light, believe in the light, that ye may be the children of light. These things spake Jesus, and departed, and did hide himself from them.", "But though he had done so many miracles before them, yet they believed not on him:", "That the saying of Esaias the prophet might be fulfilled, which he spake, Lord, who hath believed our report? and to whom hath the arm of the Lord been revealed?", "Therefore they could not believe, because that Esaias said again,", "He hath blinded their eyes, and hardened their heart; that they should not see with their eyes, nor understand with their heart, and be converted, and I should heal them.", "These things said Esaias, when he saw his glory, and spake of him.", "Nevertheless among the chief rulers also many believed on him; but because of the Pharisees they did not confess him, lest they should be put out of the synagogue:", "For they loved the praise of men more than the praise of God.", "Jesus cried and said, He that believeth on me, believeth not on me, but on him that sent me.", "And he that seeth me seeth him that sent me.", "I am come a light into the world, that whosoever believeth on me should not abide in darkness.", "And if any man hear my words, and believe not, I judge him not: for I came not to judge the world, but to save the world.", "He that rejecteth me, and receiveth not my words, hath one that judgeth him: the word that I have spoken, the same shall judge him in the last day.", "For I have not spoken of myself; but the Father which sent me, he gave me a commandment, what I should say, and what I should speak.", "And I know that his commandment is life everlasting: whatsoever I speak therefore, even as the Father said unto me, so I speak."],
        ["Now before the feast of the passover, when Jesus knew that his hour was come that he should depart out of this world unto the Father, having loved his own which were in the world, he loved them unto the end.", "And supper being ended, the devil having now put into the heart of Judas Iscariot, Simon's son, to betray him;", "Jesus knowing that the Father had given all things into his hands, and that he was come from God, and went to God;", "He riseth from supper, and laid aside his garments; and took a towel, and girded himself.", "After that he poureth water into a bason, and began to wash the disciples' feet, and to wipe them with the towel wherewith he was girded.", "Then cometh he to Simon Peter: and Peter saith unto him, Lord, dost thou wash my feet?", "Jesus answered and said unto him, What I do thou knowest not now; but thou shalt know hereafter.", "Peter saith unto him, Thou shalt never wash my feet. Jesus answered him, If I wash thee not, thou hast no part with me.", "Simon Peter saith unto him, Lord, not my feet only, but also my hands and my head.", "Jesus saith to him, He that is washed needeth not save to wash his feet, but is clean every whit: and ye are clean, but not all.", "For he knew who should betray him; therefore said he, Ye are not all clean.", "So after he had washed their feet, and had taken his garments, and was set down again, he said unto them, Know ye what I have done to you?", "Ye call me Master and Lord: and ye say well; for so I am.", "If I then, your Lord and Master, have washed your feet; ye also ought to wash one another's feet.", "For I have given you an example, that ye should do as I have done to you.", "Verily, verily, I say unto you, The servant is not greater than his lord; neither he that is sent greater than he that sent him.", "If ye know these things, happy are ye if ye do them.", "I speak not of you all: I know whom I have chosen: but that the scripture may be fulfilled, He that eateth bread with me hath lifted up his heel against me.", "Now I tell you before it come, that, when it is come to pass, ye may believe that I am he.", "Verily, verily, I say unto you, He that receiveth whomsoever I send receiveth me; and he that receiveth me receiveth him that sent me.", "When Jesus had thus said, he was troubled in spirit, and testified, and said, Verily, verily, I say unto you, that one of you shall betray me.", "Then the disciples looked one on another, doubting of whom he spake.", "Now there was leaning on Jesus' bosom one of his disciples, whom Jesus loved.", "Simon Peter therefore beckoned to him, that he should ask who it should be of whom he spake.", "He then lying on Jesus' breast saith unto him, Lord, who is it?", "Jesus answered, He it is, to whom I shall give a sop, when I have dipped it. And when he had dipped the sop, he gave it to Judas Iscariot, the son of Simon.", "And after the sop Satan entered into him. Then said Jesus unto him, That thou doest, do quickly.", "Now no man at the table knew for what intent he spake this unto him.", "For some of them thought, because Judas had the bag, that Jesus had said unto him, Buy those things that we have need of against the feast; or, that he should give something to the poor.", "He then having received the sop went immediately out: and it was night.", "Therefore, when he was gone out, Jesus said, Now is the Son of man glorified, and God is glorified in him.", "If God be glorified in him, God shall also glorify him in himself, and shall straightway glorify him.", "Little children, yet a little while I am with you. Ye shall seek me: and as I said unto the Jews, Whither I go, ye cannot come; so now I say to you.", "A new commandment I give unto you, That ye love one another; as I have loved you, that ye also love one another.", "By this shall all men know that ye are my disciples, if ye have love one to another.", "Simon Peter said unto him, Lord, whither goest thou? Jesus answered him, Whither I go, thou canst not follow me now; but thou shalt follow me afterwards.", "Peter said unto him, Lord, why cannot I follow thee now? I will lay down my life for thy sake.", "Jesus answered him, Wilt thou lay down thy life for my sake? Verily, verily, I say unto thee, The cock shall not crow, till thou hast denied me thrice."],
        ["Let not your heart be troubled: ye believe in God, believe also in me.", "In my Father's house are many mansions: if it were not so, I would have told you. I go to prepare a place for you.", "And if I go and prepare a place for you, I will come again, and receive you unto myself; that where I am, there ye may be also.", "And whither I go ye know, and the way ye know.", "Thomas saith unto him, Lord, we know not whither thou goest; and how can we know the way?", "Jesus saith unto him, I am the way, the truth, and the life: no man cometh unto the Father, but by me.", "If ye had known me, ye should have known my Father also: and from henceforth ye know him, and have seen him.", "Philip saith unto him, Lord, shew us the Father, and it sufficeth us.", "Jesus saith unto him, Have I been so long time with you, and yet hast thou not known me, Philip? he that hath seen me hath seen the Father; and how sayest thou then, Shew us the Father?", "Believest thou not that I am in the Father, and the Father in me? the words that I speak unto you I speak not of myself: but the Father that dwelleth in me, he doeth the works.", "Believe me that I am in the Father, and the Father in me: or else believe me for the very works' sake.", "Verily, verily, I say unto you, He that believeth on me, the works that I do shall he do also; and greater works than these shall he do; because I go unto my Father.", "And whatsoever ye shall ask in my name, that will I do, that the Father may be glorified in the Son.", "If ye shall ask any thing in my name, I will do it.", "If ye love me, keep my commandments.", "And I will pray the Father, and he shall give you another Comforter, that he may abide with you for ever;", "Even the Spirit of truth; whom the world cannot receive, because it seeth him not, neither knoweth him: but ye know him; for he dwelleth with you, and shall be in you.", "I will not leave you comfortless: I will come to you.", "Yet a little while, and the world seeth me no more; but ye see me: because I live, ye shall live also.", "At that day ye shall know that I am in my Father, and ye in me, and I in you.", "He that hath my commandments, and keepeth them, he it is that loveth me: and he that loveth me shall be loved of my Father, and I will love him, and will manifest myself to him.", "Judas saith unto him, not Iscariot, Lord, how is it that thou wilt manifest thyself unto us, and not unto the world?", "Jesus answered and said unto him, If a man love me, he will keep my words: and my Father will love him, and we will come unto him, and make our abode with him.", "He that loveth me not keepeth not my sayings: and the word which ye hear is not mine, but the Father's which sent me.", "These things have I spoken unto you, being yet present with you.", "But the Comforter, which is the Holy Ghost, whom the Father will send in my name, he shall teach you all things, and bring all things to your remembrance, whatsoever I have said unto you.", "Peace I leave with you, my peace I give unto you: not as the world giveth, give I unto you. Let not your heart be troubled, neither let it be afraid.", "Ye have heard how I said unto you, I go away, and come again unto you. If ye loved me, ye would rejoice, because I said, I go unto the Father: for my Father is greater than I.", "And now I have told you before it come to pass, that, when it is come to pass, ye might believe.", "Hereafter I will not talk much with you: for the prince of this world cometh, and hath nothing in me.", "But that the world may know that I love the Father; and as the Father gave me commandment, even so I do. Arise, let us go hence."],
        ["I am the true vine, and my Father is the husbandman.", "Every branch in me that beareth not fruit he taketh away: and every branch that beareth fruit, he purgeth it, that it may bring forth more fruit.", "Now ye are clean through the word which I have spoken unto you.", "Abide in me, and I in you. As the branch cannot bear fruit of itself, except it abide in the vine; no more can ye, except ye abide in me.", "I am the vine, ye are the branches: He that abideth in me, and I in him, the same bringeth forth much fruit: for without me ye can do nothing.", "If a man abide not in me, he is cast forth as a branch, and is withered; and men gather them, and cast them into the fire, and they are burned.", "If ye abide in me, and my words abide in you, ye shall ask what ye will, and it shall be done unto you.", "Herein is my Father glorified, that ye bear much fruit; so shall ye be my disciples.", "As the Father hath loved me, so have I loved you: continue ye in my love.", "If ye keep my commandments, ye shall abide in my love; even as I have kept my Father's commandments, and abide in his love.", "These things have I spoken unto you, that my joy might remain in you, and that your joy might be full.", "This is my commandment, That ye love one another, as I have loved you.", "Greater love hath no man than this, that a man lay down his life for his friends.", "Ye are my friends, if ye do whatsoever I command you.", "Henceforth I call you not servants; for the servant knoweth not what his lord doeth: but I have called you friends; for all things that I have heard of my Father I have made known unto you.", "Ye have not chosen me, but I have chosen you, and ordained you, that ye should go and bring forth fruit, and that your fruit should remain: that whatsoever ye shall ask of the Father in my name, he may give it you.", "These things I command you, that ye love one another.", "If the world hate you, ye know that it hated me before it hated you.", "If ye were of the world, the world would love his own: but because ye are not of the world, but I have chosen you out of the world, therefore the world hateth you.", "Remember the word that I said unto you, The servant is not greater than his lord. If they have persecuted me, they will also persecute you; if they have kept my saying, they will keep yours also.", "But all these things will they do unto you for my name's sake, because they know not him that sent me.", "If I had not come and spoken unto them, they had not had sin: but now they have no cloke for their sin.", "He that hateth me hateth my Father also.", "If I had not done among them the works which none other man did, they had not had sin: but now have they both seen and hated both me and my Father.", "But this cometh to pass, that the word might be fulfilled that is written in their law, They hated me without a cause.", "But when the Comforter is come, whom I will send unto you from the Father, even the Spirit of truth, which proceedeth from the Father, he shall testify of me:", "And ye also shall bear witness, because ye have been with me from the beginning."],
        ["These things have I spoken unto you, that ye should not be offended.", "They shall put you out of the synagogues: yea, the time cometh, that whosoever killeth you will think that he doeth God service.", "And these things will they do unto you, because they have not known the Father, nor me.", "But these things have I told you, that when the time shall come, ye may remember that I told you of them. And these things I said not unto you at the beginning, because I was with you.", "But now I go my way to him that sent me; and none of you asketh me, Whither goest thou?", "But because I have said these things unto you, sorrow hath filled your heart.", "Nevertheless I tell you the truth; It is expedient for you that I go away: for if I go not away, the Comforter will not come unto you; but if I depart, I will send him unto you.", "And when he is come, he will reprove the world of sin, and of righteousness, and of judgment:", "Of sin, because they believe not on me;", "Of righteousness, because I go to my Father, and ye see me no more;", "Of judgment, because the prince of this world is judged.", "I have yet many things to say unto you, but ye cannot bear them now.", "Howbeit when he, the Spirit of truth, is come, he will guide you into all truth: for he shall not speak of himself; but whatsoever he shall hear, that shall he speak: and he will shew you things to come.", "He shall glorify me: for he shall receive of mine, and shall shew it unto you.", "All things that the Father hath are mine: therefore said I, that he shall take of mine, and shall shew it unto you.", "A little while, and ye shall not see me: and again, a little while, and ye shall see me, because I go to the Father.", "Then said some of his disciples among themselves, What is this that he saith unto us, A little while, and ye shall not see me: and again, a little while, and ye shall see me: and, Because I go to the Father?", "They said therefore, What is this that he saith, A little while? we cannot tell what he saith.", "Now Jesus knew that they were desirous to ask him, and said unto them, Do ye enquire among yourselves of that I said, A little while, and ye shall not see me: and again, a little while, and ye shall see me?", "Verily, verily, I say unto you, That ye shall weep and lament, but the world shall rejoice: and ye shall be sorrowful, but your sorrow shall be turned into joy.", "A woman when she is in travail hath sorrow, because her hour is come: but as soon as she is delivered of the child, she remembereth no more the anguish, for joy that a man is born into the world.", "And ye now therefore have sorrow: but I will see you again, and your heart shall rejoice, and your joy no man taketh from you.", "And in that day ye shall ask me nothing. Verily, verily, I say unto you, Whatsoever ye shall ask the Father in my name, he will give it you.", "Hitherto have ye asked nothing in my name: ask, and ye shall receive, that your joy may be full.", "These things have I spoken unto you in proverbs: but the time cometh, when I shall no more speak unto you in proverbs, but I shall shew you plainly of the Father.", "At that day ye shall ask in my name: and I say not unto you, that I will pray the Father for you:", "For the Father himself loveth you, because ye have loved me, and have believed that I came out from God.", "I came forth from the Father, and am come into the world: again, I leave the world, and go to the Father.", "His disciples said unto him, Lo, now speakest thou plainly, and speakest no proverb.", "Now are we sure that thou knowest all things, and needest not that any man should ask thee: by this we believe that thou camest forth from God.", "Jesus answered them, Do ye now believe?", "Behold, the hour cometh, yea, is now come, that ye shall be scattered, every man to his own, and shall leave me alone: and yet I am not alone, because the Father is with me.", "These things I have spoken unto you, that in me ye might have peace. In the world ye shall have tribulation: but be of good cheer; I have overcome the world."],
        ["These words spake Jesus, and lifted up his eyes to heaven, and said, Father, the hour is come; glorify thy Son, that thy Son also may glorify thee:", "As thou hast given him power over all flesh, that he should give eternal life to as many as thou hast given him.", "And this is life eternal, that they might know thee the only true God, and Jesus Christ, whom thou hast sent.", "I have glorified thee on the earth: I have finished the work which thou gavest me to do.", "And now, O Father, glorify thou me with thine own self with the glory which I had with thee before the world was.", "I have manifested thy name unto the men which thou gavest me out of the world: thine they were, and thou gavest them me; and they have kept thy word.", "Now they have known that all things whatsoever thou hast given me are of thee.", "For I have given unto them the words which thou gavest me; and they have received them, and have known surely that I came out from thee, and they have believed that thou didst send me.", "I pray for them: I pray not for the world, but for them which thou hast given me; for they are thine.", "And all mine are thine, and thine are mine; and I am glorified in them.", "And now I am no more in the world, but these are in the world, and I come to thee. Holy Father, keep through thine own name those whom thou hast given me, that they may be one, as we are.", "While I was with them in the world, I kept them in thy name: those that thou gavest me I have kept, and none of them is lost, but the son of perdition; that the scripture might be fulfilled.", "And now come I to thee; and these things I speak in the world, that they might have my joy fulfilled in themselves.", "I have given them thy word; and the world hath hated them, because they are not of the world, even as I am not of the world.", "I pray not that thou shouldest take them out of the world, but that thou shouldest keep them from the evil.", "They are not of the world, even as I am not of the world.", "Sanctify them through thy truth: thy word is truth.", "As thou hast sent me into the world, even so have I also sent them into the world.", "And for their sakes I sanctify myself, that they also might be sanctified through the truth.", "Neither pray I for these alone, but for them also which shall believe on me through their word;", "That they all may be one; as thou, Father, art in me, and I in thee, that they also may be one in us: that the world may believe that thou hast sent me.", "And the glory which thou gavest me I have given them; that they may be one, even as we are one:", "I in them, and thou in me, that they may be made perfect in one; and that the world may know that thou hast sent me, and hast loved them, as thou hast loved me.", "Father, I will that they also, whom thou hast given me, be with me where I am; that they may behold my glory, which thou hast given me: for thou lovedst me before the foundation of the world.", "O righteous Father, the world hath not known thee: but I have known thee, and these have known that thou hast sent me.", "And I have declared unto them thy name, and will declare it: that the love wherewith thou hast loved me may be in them, and I in them."],
        ["The first day of the week cometh Mary Magdalene early, when it was yet dark, unto the sepulchre, and seeth the stone taken away from the sepulchre.", "Then she runneth, and cometh to Simon Peter, and to the other disciple, whom Jesus loved, and saith unto them, They have taken away the Lord out of the sepulchre, and we know not where they have laid him.", "Peter therefore went forth, and that other disciple, and came to the sepulchre.", "So they ran both together: and the other disciple did outrun Peter, and came first to the sepulchre.", "And he stooping down, and looking in, saw the linen clothes lying; yet went he not in.", "Then cometh Simon Peter following him, and went into the sepulchre, and seeth the linen clothes lie,", "And the napkin, that was about his head, not lying with the linen clothes, but wrapped together in a place by itself.", "Then went in also that other disciple, which came first to the sepulchre, and he saw, and believed.", "For as yet they knew not the scripture, that he must rise again from the dead.", "Then the disciples went away again unto their own home.", "But Mary stood without at the sepulchre weeping: and as she wept, she stooped down, and looked into the sepulchre,", "And seeth two angels in white sitting, the one at the head, and the other at the feet, where the body of Jesus had lain.", "And they say unto her, Woman, why weepest thou? She saith unto them, Because they have taken away my Lord, and I know not where they have laid him.", "And when she had thus said, she turned herself back, and saw Jesus standing, and knew not that it was Jesus.", "Jesus saith unto her, Woman, why weepest thou? whom seekest thou? She, supposing him to be the gardener, saith unto him, Sir, if thou have borne him hence, tell me where thou hast laid him, and I will take him away.", "Jesus saith unto her, Mary. She turned herself, and saith unto him, Rabboni; which is to say, Master.", "Jesus saith unto her, Touch me not; for I am not yet ascended to my Father: but go to my brethren, and say unto them, I ascend unto my Father, and your Father; and to my God, and your God.", "Mary Magdalene came and told the disciples that she had seen the Lord, and that he had spoken these things unto her.", "Then the same day at evening, being the first day of the week, when the doors were shut where the disciples were assembled for fear of the Jews, came Jesus and stood in the midst, and saith unto them, Peace be unto you.", "And when he had so said, he shewed unto them his hands and his side. Then were the disciples glad, when they saw the Lord.", "Then said Jesus to them again, Peace be unto you: as my Father hath sent me, even so send I you.", "And when he had said this, he breathed on them, and saith unto them, Receive ye the Holy Ghost:", "Whose soever sins ye remit, they are remitted unto them; and whose soever sins ye retain, they are retained.", "But Thomas, one of the twelve, called Didymus, was not with them when Jesus came.", "The other disciples therefore said unto him, We have seen the Lord. But he said unto them, Except I shall see in his hands the print of the nails, and put my finger into the print of the nails, and thrust my hand into his side, I will not believe.", "And after eight days again his disciples were within, and Thomas with them: then came Jesus, the doors being shut, and stood in the midst, and said, Peace be unto you.", "Then saith he to Thomas, Reach hither thy finger, and behold my hands; and reach hither thy hand, and thrust it into my side: and be not faithless, but believing.", "And Thomas answered and said unto him, My Lord and my God.", "Jesus saith unto him, Thomas, because thou hast seen me, thou hast believed: blessed are they that have not seen, and yet have believed.", "And many other signs truly did Jesus in the presence of his disciples, which are not written in this book:", "But these are written, that ye might believe that Jesus is the Christ, the Son of God; and that believing ye might have life through his name."]
    ];
    var chapter = Number(params.chapter) || randInt(1,7);
    var currentRandChapter = 0;
    var curVerse = randVerse();
    var correctAnswer = curVerse[0];
    var missiles = [];
    curVerse = curVerse[1];
    // textDiv.innerHTML = curVerse;
    var fullLevel = false;
    var difficulty = 0.75;
    function randInt(min, max, not) {
        if(max === undefined) {
            max = min
            min = 1
        }
        var num = Math.floor(Math.random() * (max - min + 1)) + min;
        while(num === not && max-min > 0) {
            num = Math.floor(Math.random() * (max - min + 1)) + min;
        }
        return num;
    }
    function weightedRandInt(min,max, not, chapter) {
        var weightedArr = [];
        var sum = 0;
        var maxNum = Number(storeRange.split("-")[1]);
        for(var i = 0; i < maxNum; i++) {
            var score = 1;
            if(verseTracking[getRealChapter(chapter) + "." + (i+1).toString()]) {
                var cur = verseTracking[getRealChapter(chapter) + "." + (i+1).toString()];
                if(cur) {
                    if(cur.correct && cur.incorrect) {
                        score /= cur.correct/cur.incorrect;
                    } else if(cur.correct) {
                        score /= cur.correct;
                    } else {
                        score += cur.incorrect;
                    }
                }
            }
            weightedArr.push(sum+score);
            sum += score;
        }
        var randomNumber = not;
        while(randomNumber === not) {
            var rand = Math.random() * sum;
            for(var i = 0; i < weightedArr.length; i++) {
                if(weightedArr[i] >= rand) {
                    randomNumber = i;
                    i = Infinity;
                }
            }
        }
        return randomNumber;
    }
    function getRealChapter(chapter) {
        if(chapter === 7) {
            return "20";
        } else {
            return (chapter + 11).toString();
        }
    }
    function randVerse() {
        if(chapter) {
            var verseArr = rom18[chapter-1];
            if(mistakeReview) {
                var rand = weightedRandInt((params.min ? Number(params.min)-1 : 0), Number(params.max)-1 || verseArr.length-1, (correctAnswer ? Number(correctAnswer.split(".")[1])-1 : -1), chapter);
            } else {
                var rand = randInt((params.min ? Number(params.min)-1 : 0), Number(params.max)-1 || verseArr.length-1, (correctAnswer ? Number(correctAnswer.split(".")[1])-1 : -1));
            }
            if(chapter === 7) {
                var verseNumber = 20 + "." + (rand+1);
            } else {
                var verseNumber = (chapter + 11) + "." + (rand+1);
            }
            return [verseNumber, verseArr[rand]];
        } else {
            var currentRandChapter = randInt(0,7)
            var verseArr = rom18[currentRandChapter];
            var rand = randInt(0,verseArr.length-1);
            var verseNumber = (currentRandChapter+1) + "." + (rand+1);
            return [verseNumber, verseArr[rand]];
        }
    }
    var verseTracking = {};
    // energyHolder.beginFill();
    var state;
    var keys = {};
    var rocket;
    var enemies = [];
    var explosions = [];
    var mouseX,mouseY;
    var lasers = [];
    var lastFire = 0;
    var reloadTime = 500;
    var energyToFire = 5;
    var healthToHit = 10;
    var emp;
    var enemyEMP;
    var laserGraphics = new PIXI.Graphics();
    laserGraphics.beginFill(0xffffaa);
    laserGraphics.drawRect(-25,0,50, -innerHeight * 2);
    app.stage.addChild(laserGraphics);
    app.stage.sortableChildren = true;
    var scaleFactor = innerWidth/1920;
    function setup() {
        spawnNewEnemy(1,"easy");
        rocket = new Sprite(resources["sprites/rocket.png"].texture);
        app.stage.addChild(rocket);
        rocket.anchor.set(0.5,0.5);
        rocket.scale.set(3*scaleFactor);
        rocket.x = 100;
        rocket.y = 100;

        emp = new Sprite(resources["sprites/emp.png"].texture);
        app.stage.addChild(emp);
        emp.anchor.set(0.5,0.5);
        emp.x = 100;
        emp.y = 100;
        emp.visible = false;

        enemyEMP = new Sprite(resources["sprites/enemyEMP.png"].texture);
        app.stage.addChild(enemyEMP);
        enemyEMP.anchor.set(0.5,0.5);
        enemyEMP.x = 100;
        enemyEMP.y = 100;
        enemyEMP.visible = false;
        enemyEMP.zIndex = 10000;
    }
    function gameLoop(delta) {
      state(delta)
    }
    var level = 1;
    function explode(amount, position, magnitude) {
        for(var i = 0; i < amount; i++) {
            if(magnitude) {
                var rand = magnitude/3-0.1;
            } else {
                var rand = Math.random();
            }
            if(rand < 0.33) {
                var explosion = new Sprite(resources["sprites/exp1.png"].texture);
            } else if(rand < 0.66) {
                var explosion = new Sprite(resources["sprites/exp2.png"].texture);
            } else {
                var explosion = new Sprite(resources["sprites/exp3.png"].texture);
            }
            app.stage.addChild(explosion);
            explosion.x = position.x + randInt(-20,20);
            explosion.y = position.y + randInt(-20,20);
            explosions.push(explosion);
            explosion.scale.set(3*scaleFactor);
        }
    }
    function bigExplosion(amount, position, magnitude) {
        for(var i = 0; i < amount; i++) {
            if(magnitude) {
                var rand = magnitude/3-0.1;
            } else {
                var rand = Math.random();
            }
            if(rand < 0.33) {
                var explosion = new Sprite(resources["sprites/exp1.png"].texture);
            } else if(rand < 0.66) {
                var explosion = new Sprite(resources["sprites/exp2.png"].texture);
            } else {
                var explosion = new Sprite(resources["sprites/exp3.png"].texture);
            }
            app.stage.addChild(explosion);
            explosion.x = position.x + randInt(-150,150);
            explosion.y = position.y + randInt(-150,150);
            explosions.push(explosion);
            explosion.scale.set(3*scaleFactor);
        }
    }
    function win() {
        explode(1,{x:enemies[0].x,y:enemies[0].y});
        for(var i = 0; i < explosions.length; i++) {
            explosions[i].alpha -= 0.05;
            if(explosions[i].alpha <= 0) {
                app.stage.removeChild(explosions[i]);
                explosions.splice(i,1);
                --i;
            }
        }

        for(var i = 0; i < lasers.length; i++) {
            lasers[i].alpha -= 0.05;
            if(lasers[i].alpha <= 0) {
                app.stage.removeChild(lasers[i]);
                lasers.splice(i,1);
                --i;
            }
        }


        for(var i = 0; i < missiles.length; i++) {
            missiles[i].alpha -= 0.05;
            if(missiles[i].alpha <= 0) {
                app.stage.removeChild(missiles[i]);
                missiles.splice(i,1);
                --i;
            }
        }
    }
    function die() {
        explode(1,{x:rocket.x,y:rocket.y});
        for(var i = 0; i < explosions.length; i++) {
            explosions[i].alpha -= 0.05;
            if(explosions[i].alpha <= 0) {
                app.stage.removeChild(explosions[i]);
                explosions.splice(i,1);
                --i;
            }
        }
        for(var i = 0; i < enemies.length; i++) {
            enemies[i].alpha -= 0.05;
            if(enemies[i].alpha <= 0) {
                app.stage.removeChild(enemies[i]);
                enemies.splice(i,1);
                --i;
            }
        }

        for(var i = 0; i < lasers.length; i++) {
            lasers[i].alpha -= 0.05;
            if(lasers[i].alpha <= 0) {
                app.stage.removeChild(lasers[i]);
                lasers.splice(i,1);
                --i;
            }
        }


        for(var i = 0; i < missiles.length; i++) {
            missiles[i].alpha -= 0.05;
            if(missiles[i].alpha <= 0) {
                app.stage.removeChild(missiles[i]);
                missiles.splice(i,1);
                --i;
            }
        }
    }
    function play(){
        if(healthBar.width < 0) {
            state = die;
        }
        rocket.vx = 0;
        rocket.vy = 0;
        if(keys.ArrowUp || keys.w) {
            rocket.vy += -10;
        }
        if(keys.ArrowDown || keys.s) {
            rocket.vy += 10;
        }
        if(keys.ArrowLeft || keys.a) {
            rocket.vx += -10;
        }
        if(keys.ArrowRight || keys.d) {
            rocket.vx += 10;
        }
        if(keys[" "] && Date.now() - reloadTime > lastFire && energyBar.width >= energyToFire) {
            shootLaser("good", {x:rocket.x, y: rocket.y - rocket.height/2}, 0);
            lastFire = Date.now();
            energyBar.width -= energyToFire;
        }
        if(keys.m && energyBar.width >= energyToFire*7 && enemies.length && canUseMissiles) {
            var closestEnemy;
            var closestDist = Infinity;
            for(let i = 0; i < enemies.length; i++) {
                var enemy = enemies[i];
                if(getDistance(rocket.x,rocket.y,enemy.x,enemy.y) < closestDist && enemy.alpha === 1 && enemy.level !== "nursing-mother" && enemy.level !== "bossattack") {
                    closestDist = getDistance(rocket.x,rocket.y,enemy.x,enemy.y)
                    closestEnemy = enemy;
                }
            }
            launchMissile("good",  {x:rocket.x, y: rocket.y - rocket.height/2}, closestEnemy, 10);
            keys.m = false;
            energyBar.width -= energyToFire*7;
        }
        if(keys.e && energyBar.width > 0 && canUseEMP) {
            if(!emp.visible) {
                emp.scale.set(0.5*scaleFactor);
            }
            emp.scale.x += 0.1*scaleFactor;
            emp.scale.y += 0.1*scaleFactor;
            emp.visible = true;
            emp.rotation += 0.1;
            emp.x = rocket.x;
            emp.y = rocket.y;
            energyBar.width -= energyToFire/5;
            for(var i = 0; i < enemies.length; i++) {
                var enemy = enemies[i];
                if(getDistance(enemy.x,enemy.y,emp.x,emp.y) < emp.width/2 && enemy.level !== "nursing-mother" && enemy.level !== "bossattack") {
                    explode(1,{x:enemy.x,y:enemy.y});
                    enemy.health -= 0.1;
                }
            }
        } else {
            emp.visible = false;
        }
        if(keys.l && energyBar.width > 0 && canUseLaser) {
            laserGraphics.visible = true;
            for(var i = 0; i < enemies.length; i++) {
                var enemy = enemies[i];
                var enemyRect = {x: enemy.x - enemy.width/2, y: enemy.y - enemy.height/2, width: enemy.width, height: enemy.height};
                var laserRect = {x:laserGraphics.x-25,y:laserGraphics.y-innerHeight*2,width:50,height:innerHeight*2};
                if(hitTestRectangle(laserRect,enemyRect) && enemy.level !== "nursing-mother" && enemy.level !== "bossattack") {
                    explode(1,{x:enemy.x,y:enemy.y});
                    enemy.health -= 0.1;
                }
            }
            energyBar.width -= energyToFire/4;
        } else {
            laserGraphics.visible = false;
        }
        if(energyBar.width > Math.abs(rocket.vx/100) + Math.abs(rocket.vy/100)) {
            if(rocket.x > rocket.width/2 && rocket.vx < 0) {
                rocket.x += rocket.vx*scaleFactor;
            } else if(rocket.x + rocket.width/2 < innerWidth && rocket.vx > 0) {
                rocket.x += rocket.vx*scaleFactor;
            }

            if(rocket.y > rocket.height/2 && rocket.vy < 0) {
                rocket.y += rocket.vy*scaleFactor;
            } else if(rocket.y + rocket.height/2 < innerHeight && rocket.vy > 0) {
                rocket.y += rocket.vy*scaleFactor;
            }
            energyBar.width -= Math.abs(rocket.vx/100)*(energyToFire/5) + Math.abs(rocket.vy/100)*(energyToFire/5);
            laserGraphics.x = rocket.x;
            laserGraphics.y = rocket.y;
        }

        for(var i = 0; i < missiles.length; i++) {
            var missile = missiles[i];
            if(missile === undefined) {
                break;
            }
            --missile.health;
            if((missile.target ? missile.target.health <= 0 : true) || missile.target.level === "nursing-mother" || missile.target.level === "bossattack") {
                debugger;
                var closestEnemy;
                var closestDist = Infinity;
                for(let i = 0; i < enemies.length; i++) {
                    var enemy = enemies[i];
                    if(getDistance(missile.x,missile.y,enemy.x,enemy.y) < closestDist && enemy.alpha === 1) {
                        closestDist = getDistance(rocket.x,rocket.y,enemy.x,enemy.y)
                        closestEnemy = enemy;
                    }
                }
                if(closestEnemy) {
                    missile.target = closestEnemy;
                } else {
                    explode(1,{x:missile.x,y:missile.y});
                    app.stage.removeChild(missile);
                    missiles.splice(i,1);
                    --i;
                    break;
                }
            }
            if (missile.health <= 0) {
                explode(1,{x:missile.x,y:missile.y});
                app.stage.removeChild(missile);
                missiles.splice(i,1);
                --i;
            }
            missile.rotation = pointTowards(missile.x,missile.y,missile.target.x,missile.target.y) * Math.PI/180;
            missile.rotation *= -1;
            var missileDirection = radDirection(missile.speed, -missile.rotation + Math.PI);
            missile.x += missileDirection.r*scaleFactor;
            missile.y += missileDirection.u*scaleFactor;
            if(missile.y < -10 || missile.y > innerHeight + 10 || missile.x < 10 || missile.x > innerWidth + 10) {
                app.stage.removeChild(missile);
                missiles.splice(i,1);
                --i;
                continue;
            }
            var missileRect = {x: missile.x-missile.width/2, y: missile.y-missile.height/2,width:missile.width,height:missile.height};
            var rocketRect = {x: rocket.x - rocket.width/2, y: rocket.y - rocket.height/2, width: rocket.width, height: rocket.height};
            if(hitTestRectangle(missileRect, rocketRect) && !missile.good) {
                if(!invincible) {
                    healthBar.width -= healthToHit*3;
                }
                explode(20,{x:missile.x - missile.width, y:missile.y + missile.height});
                app.stage.removeChild(missile);
                missiles.splice(i,1);
                --i;
                continue;
            }
            for(var j = 0; j < enemies.length; j++) { 
                var enemy = enemies[j];
                var enemyRect = {x: enemy.x - enemy.width/2, y: enemy.y - enemy.height/2, width: enemy.width, height: enemy.height};
                if(hitTestRectangle(missileRect, enemyRect) && missile.good && enemy.level !== "nursing-mother" && enemy.level !== "bossattack") {
                    enemy.health -= 3;
                    explode(10,{x:missile.x - missile.width, y:missile.y - missile.height});
                    if(enemy.health <= 0) {
                        bigExplosion(100,{x:enemy.x,y:enemy.y});
                    }
                    enemies.forEach(function(enemy){
                        if(getDistance(enemy.x,enemy.y,missile.x,missile.y) < 200) {
                            explode(10,{x:enemy.x, y:enemy.y});
                            enemy.health -= 2;
                        }
                    });
                    app.stage.removeChild(missile);
                    missiles.splice(i,1);
                    --i;
                    j = enemies.length;
                    continue;
                }   
            }
        }

        for(var i = 0; i < lasers.length; i++) {
            var laser = lasers[i];
            var laserDirection = radDirection(20,-laser.rotation + Math.PI);
            laser.x += laserDirection.r*scaleFactor;
            laser.y += laserDirection.u*scaleFactor;
            if(laser.y < -10 || laser.y > innerHeight + 10 || laser.x < 10 || laser.x > innerWidth + 10) {
                app.stage.removeChild(laser);
                lasers.splice(i,1);
                --i;
                continue;
            }
            var laserRect = {x: laser.x-laser.width/2, y: laser.y-laser.height/2,width:laser.width,height:laser.height};
            var rocketRect = {x: rocket.x - rocket.width/2, y: rocket.y - rocket.height/2, width: rocket.width, height: rocket.height};
            if(hitTestRectangle(laserRect, rocketRect) && !laser.good) {
                if(!invincible) {
                    healthBar.width -= healthToHit;
                }
                explode(1,{x:laser.x - laser.width, y:laser.y + laser.height});
                app.stage.removeChild(laser);
                lasers.splice(i,1);
                --i;
                continue;
            }
            for(var j = 0; j < enemies.length; j++) { 
                var enemy = enemies[j];
                var enemyRect = {x: enemy.x - enemy.width/2, y: enemy.y - enemy.height/2, width: enemy.width, height: enemy.height};
                if(hitTestRectangle(laserRect, enemyRect) && laser.good && enemy.level !== "nursing-mother" && enemy.level !== "bossattack") {
                    enemy.health--;
                    explode(1,{x:laser.x - laser.width/2, y:laser.y - laser.height/2});
                    if(enemy.health <= 0) {
                        explode(20,{x:enemy.x,y:enemy.y});
                    }
                    app.stage.removeChild(laser);
                    lasers.splice(i,1);
                    --i;
                    j = enemies.length;
                    continue;
                }   
            }
        }
        for(var i = 0; i < formations.length; i++) {
            var formation = formations[i];
            var inSight = false;
            var closestEnemy;
            var closestDist = Infinity;
            formation.forEach(function(enemy){
                if(enemy.health >= 0) {
                    if(enemy.x + enemy.width/2 < rocket.x) {
                    } else if(enemy.x - enemy.width/2 > rocket.x) {
                    } else {
                        inSight = true;
                    }
                    if(getDistance(rocket.x,rocket.y, enemy.x, enemy.y) < closestDist) {
                        closestDist = getDistance(rocket.x,rocket.y, enemy.x, enemy.y);
                        closestEnemy = enemy;
                    }
                }
            });
            var movement = {x:0, y:0}
            if(!inSight) {
                if(closestEnemy) {
                    if(closestEnemy.x < rocket.x) {
                        movement.x = 3;
                    } else {
                        movement.x = -3;
                    }
                } else {
                    formations.splice(i,1);
                    --i;
                }
            }
            formation.forEach(function(child){
                child.formationMovement = movement;
            })
        }
        for(var i = 0; i < enemies.length; i++) {
            var enemy = enemies[i];
            if(enemy.health > 0) {
                if(enemy.level === "easy") {
                    if(enemy.y < innerHeight + 200) {
                        enemy.y += 1.5 * difficulty*scaleFactor;
                    } else {
                        enemy.y = -400;
                    }
                    if(enemy.x + 5 < rocket.x) {
                        enemy.x += 1.5 * difficulty*scaleFactor;
                    } else if(enemy.x - 5 > rocket.x) {
                        enemy.x -= 1.5 * difficulty*scaleFactor;
                    } else if(Date.now() - enemy.reloadTime > enemy.lastFire) {
                        shootLaser("bad", {x:enemy.x, y: enemy.y}, pointTowards(enemy.x,enemy.y,rocket.x,rocket.y) * Math.PI/180)
                        enemy.lastFire = Date.now();
                    }
                } else if(enemy.level === "boss1") {
                    if(enemy.y < innerHeight + 200) {
                        enemy.y += 1.5 * difficulty*scaleFactor;
                    } else {
                        enemy.y = -400;
                    }
                    if(enemy.x + 15 < rocket.x) {
                        enemy.x += 10*scaleFactor;
                    } else if(enemy.x - 15 > rocket.x) {
                        enemy.x -= 10*scaleFactor;
                    } else if(Date.now() - enemy.reloadTime > enemy.lastFire) {
                        shootLaser("bad", {x:enemy.x, y: enemy.y}, pointTowards(enemy.x,enemy.y,rocket.x,rocket.y) * Math.PI/180)
                        launchMissile("bad", {x:enemy.x + enemy.width/3, y: enemy.y}, rocket, 7.5)
                        launchMissile("bad", {x:enemy.x - enemy.width/3, y: enemy.y}, rocket, 7.5);
                        enemy.lastFire = Date.now();
                    }
                } else if(enemy.level === "medium") {
                    if(enemy.y < 100) {
                        enemy.y += 1.5 * difficulty*scaleFactor;
                    }
                    if(Math.abs(rocket.x - enemy.x) < 300) {
                        if((rocket.x > enemy.x || (innerWidth - rocket.x < 300)) && rocket.x >= 300) {
                            enemy.x -= 3 * difficulty*scaleFactor;
                        } else {
                            enemy.x += 3 * difficulty*scaleFactor;
                        }
                    }
                    if(Date.now() - enemy.reloadTime > enemy.lastFire) {
                        shootLaser("bad", {x:enemy.x - enemy.width / 3, y: enemy.y}, pointTowards(enemy.x,enemy.y,rocket.x,rocket.y) * Math.PI/180)
                        shootLaser("bad", {x:enemy.x + enemy.width / 3, y: enemy.y}, pointTowards(enemy.x,enemy.y,rocket.x,rocket.y) * Math.PI/180)
                        enemy.lastFire = Date.now();
                    }
                } else if(enemy.level === "boss2") {
                    enemy.rotation = (0-pointTowards(enemy.x,enemy.y,rocket.x,rocket.y)) * Math.PI/180;
                    if(enemy.y < innerHeight/2) {
                        enemy.y += 1.5 * difficulty*scaleFactor;
                    }
                    if(Date.now() - enemy.burstRate > enemy.burstFire) {
                        if(Date.now() - enemy.reloadTime > enemy.lastFire) {
                            enemy.bursts--;
                            shootLaser("bad", {x:enemy.x - enemy.width / 3, y: enemy.y}, pointTowards(enemy.x - enemy.width/6,enemy.y,rocket.x,rocket.y) * Math.PI/180);
                            shootLaser("bad", {x:enemy.x + enemy.width / 3, y: enemy.y}, pointTowards(enemy.x + enemy.width/6,enemy.y,rocket.x,rocket.y) * Math.PI/180)
                            enemy.lastFire = Date.now();
                            if(enemy.bursts === 0) {
                                enemy.bursts = 25;
                                enemy.burstFire = Date.now();
                            }
                        }
                    }
                    if(Date.now() - enemy.empRate > enemy.empFire) {
                        --enemy.energy;
                        if(!enemyEMP.visible) {
                            enemyEMP.scale.set(0.5*scaleFactor);
                        }
                        enemyEMP.visible = true;
                        enemyEMP.x = enemy.x;
                        enemyEMP.y = enemy.y;
                        enemyEMP.scale.x += 0.1*scaleFactor;
                        enemyEMP.scale.y += 0.1*scaleFactor;
                        enemyEMP.rotation += 0.1;
                        if(getDistance(rocket.x,rocket.y,enemyEMP.x,enemyEMP.y) < enemyEMP.width/2) {
                            if(!invincible) {
                                healthBar.width -= healthToHit/8;
                            }
                            explode(1,rocket);
                        }
                        if(enemy.energy <= 0) {
                            enemy.energy = innerWidth/10;
                            enemyEMP.visible = false;
                            enemy.empFire = Date.now();
                        }
                    }
                } else if(enemy.level === "drone") {
                    if(enemy.y < innerHeight + 200) {
                        enemy.y += 5 * difficulty*scaleFactor;
                    } else {
                        enemy.y = -400;
                    }
                    if(enemy.formationMovement) {
                        enemy.x += enemy.formationMovement.x*scaleFactor;
                        enemy.y += enemy.formationMovement.y*scaleFactor;
                    }
                    if(Date.now() - enemy.reloadTime > enemy.lastFire) {
                        shootLaser("bad", {x:enemy.x + 10, y: enemy.y}, 180 * Math.PI/180);
                        shootLaser("bad", {x:enemy.x - 10, y: enemy.y}, 180 * Math.PI/180);
                        shootLaser("bad", {x:enemy.x + enemy.width/2, y: enemy.y}, 180 * Math.PI/180);
                        shootLaser("bad", {x:enemy.x - enemy.width/2, y: enemy.y}, 180 * Math.PI/180);
                        enemy.lastFire = Date.now();
                    }
                } else if(enemy.level === "boss3") {
                    if(enemy.y < 100) {
                        enemy.y += 5 * difficulty*scaleFactor;
                    }
                    if(enemy.x + enemy.xOffset + 15 < rocket.x) {
                        enemy.x += 2.5*scaleFactor;
                    } else if(enemy.x + enemy.xOffset - 15 > rocket.x) {
                        enemy.x -= 2.5*scaleFactor;
                    } else if(Date.now() - enemy.reloadTime > enemy.lastFire) {
                        shootLaser("bad", {x:enemy.x + 10, y: enemy.y}, 180 * Math.PI/180);
                        shootLaser("bad", {x:enemy.x - 10, y: enemy.y}, 180 * Math.PI/180);
                        // shootLaser("bad", {x:enemy.x + enemy.width/2, y: enemy.y}, 180 * Math.PI/180);
                        // shootLaser("bad", {x:enemy.x - enemy.width/2, y: enemy.y}, 180 * Math.PI/180);
                        enemy.lastFire = Date.now();
                    }

                    if(Date.now() - enemy.backupRate > enemy.backupFire) {
                        spawnNewFormation("drone", "V", 1);
                        enemy.backupFire = Date.now();
                    }
                    if(Date.now() - enemy.laserRate > enemy.laserFire) {
                        --enemy.energy;
                        enemy.laser.visible = true;
                        enemy.laser.x = enemy.x;
                        enemy.laser.y = enemy.y;
                        var laserRect = {x:enemy.laser.x-25,y:enemy.laser.y,width:50,height:innerHeight*2};
                        var rocketRect = {x: rocket.x - rocket.width/2, y: rocket.y - rocket.height/2, width: rocket.width, height: rocket.height};
                        if(hitTestRectangle(laserRect,rocketRect)) {
                            explode(1,{x:rocket.x,y:rocket.y});
                            if(!invincible) {
                                healthBar.width -= 1;
                            }
                        }
                        if(enemy.energy <= 0) {
                            enemy.laser.visible = false;
                            enemy.energy = 150;
                            enemy.laserFire = Date.now();
                        }
                    }
                } else if(enemy.level === "mothership") {
                    if(enemy.alpha < 1) {
                        enemy.alpha += 0.001;
                    }
                    if(enemy.scale.x < 3) {
                        enemy.scale.x += 0.01*scaleFactor;
                        enemy.scale.y += 0.01*scaleFactor;
                    }
                    if(enemy.health < 10) {
                        enemy.level = "nursing-mother";
                        healthBar.width = 200;
                        energyBar.width = 200;
                        enemy.waitTime = Date.now();
                        enemy.waitRate = 40000 * difficulty;
                        enemy.backupRate = 20000;
                        enemy.backupFire = Date.now() - 150000;
                        enemy.laser.visible = false;
                        enemy.laserRate = 40000 * difficulty;
                        enemy.health = Infinity;
                    }
                    if(enemy.y < 150) {
                        enemy.y += 1*scaleFactor;
                    }
                    if(enemy.x + 15 < rocket.x) {
                        enemy.x += 5*scaleFactor;
                    } else if(enemy.x - 15 > rocket.x) {
                        enemy.x -= 5*scaleFactor;
                    } else if(Date.now() - enemy.reloadTime > enemy.lastFire) {
                        shootLaser("bad", {x:enemy.x, y: enemy.y}, 190 * Math.PI/180);
                        shootLaser("bad", {x:enemy.x, y: enemy.y}, 195 * Math.PI/180);
                        shootLaser("bad", {x:enemy.x, y: enemy.y}, 185 * Math.PI/180);
                        shootLaser("bad", {x:enemy.x, y: enemy.y}, 200 * Math.PI/180);
                        shootLaser("bad", {x:enemy.x, y: enemy.y}, 170 * Math.PI/180);
                        shootLaser("bad", {x:enemy.x, y: enemy.y}, 160 * Math.PI/180);
                        shootLaser("bad", {x:enemy.x, y: enemy.y}, 180 * Math.PI/180);
                        shootLaser("bad", {x:enemy.x, y: enemy.y}, 175 * Math.PI/180);
                        shootLaser("bad", {x:enemy.x, y: enemy.y}, 165 * Math.PI/180);
                        enemy.lastFire = Date.now();
                    }

                    if(Date.now() - enemy.laserRate > enemy.laserFire && enemy.level !== "nursing-mother") {
                        --enemy.energy;
                        enemy.laser.visible = true;
                        enemy.laser.x = enemy.x;
                        enemy.laser.y = enemy.y;
                        var laserRect = {x:enemy.laser.x-25,y:enemy.laser.y,width:50,height:innerHeight*2};
                        var rocketRect = {x: rocket.x - rocket.width/2, y: rocket.y - rocket.height/2, width: rocket.width, height: rocket.height};
                        if(hitTestRectangle(laserRect,rocketRect)) {
                            explode(1,{x:rocket.x,y:rocket.y});
                            if(!invincible) {
                                healthBar.width -= 1;
                            }
                        }
                        if(enemy.energy <= 0) {
                            enemy.laser.visible = false;
                            enemy.energy = 150;
                            enemy.laserFire = Date.now();
                        }
                    }
                } else if(enemy.level === "nursing-mother") {
                    if(enemy.waitTime + enemy.waitRate < Date.now() && enemies.length === 1) {
                        enemy.level = "missileship";
                        healthBar.width = 200;
                        energyBar.width = 200;
                        enemy.health = 250*difficulty;
                        enemy.lastFire = Date.now();
                    }
                    if(enemy.alpha > 0.5) {
                        enemy.alpha -= 0.001;
                    }
                    if(enemy.scale.x > 1*scaleFactor) {
                        enemy.scale.x -= 0.01*scaleFactor;
                        enemy.scale.y -= 0.01*scaleFactor;
                    }
                    // if(enemy.y > -350) {
                        // enemy.y -= 3;
                    // }
                    if(enemy.x + 15 < rocket.x) {
                        enemy.x += 2*scaleFactor;
                    } else if(enemy.x - 15 > rocket.x) {
                        enemy.x -= 2*scaleFactor;
                    } else if(Date.now() - enemy.reloadTime > enemy.lastFire) {
                        // shootLaser("bad", {x:enemy.x, y: enemy.y}, 190 * Math.PI/180);
                        // shootLaser("bad", {x:enemy.x, y: enemy.y}, 195 * Math.PI/180);
                        // shootLaser("bad", {x:enemy.x, y: enemy.y}, 185 * Math.PI/180);
                        // shootLaser("bad", {x:enemy.x, y: enemy.y}, 200 * Math.PI/180);
                        // shootLaser("bad", {x:enemy.x, y: enemy.y}, 170 * Math.PI/180);
                        // shootLaser("bad", {x:enemy.x, y: enemy.y}, 160 * Math.PI/180);
                        // shootLaser("bad", {x:enemy.x, y: enemy.y}, 180 * Math.PI/180);
                        // shootLaser("bad", {x:enemy.x, y: enemy.y}, 175 * Math.PI/180);
                        // shootLaser("bad", {x:enemy.x, y: enemy.y}, 165 * Math.PI/180);
                        // enemy.lastFire = Date.now();
                    }
                    if(Date.now() - enemy.backupRate > enemy.backupFire && (enemy.waitTime + enemy.waitRate > Date.now())) {
                        var formationTypeToSummon = randInt(1,6);
                        if(formationTypeToSummon < 2) {
                            spawnNewFormation("drone", "V", 7);
                        } else if(formationTypeToSummon < 3) {
                            spawnNewFormation("drone", "N", 7);
                        } else if(formationTypeToSummon < 4) {
                            spawnNewEnemy(10, "easy");
                        } else if(formationTypeToSummon < 5) {
                            spawnNewEnemy(4, "medium");
                        } else if(formationTypeToSummon < 6) {
                            spawnNewEnemy(4, "medium");
                            spawnNewEnemy(4, "easy");
                        } else {
                            spawnNewFormation("drone", "V", 5);
                            spawnNewFormation("drone", "N", 5);
                        }
                        enemy.backupFire = Date.now();
                    }
                    if(Date.now() - enemy.laserRate > enemy.laserFire) {
                        // --enemy.energy;
                        // enemy.laser.visible = true;
                        // enemy.laser.x = enemy.x;
                        // enemy.laser.y = enemy.y;
                        // var laserRect = {x:enemy.laser.x-25,y:enemy.laser.y,width:50,height:innerHeight*2};
                        // var rocketRect = {x: rocket.x - rocket.width/2, y: rocket.y - rocket.height/2, width: rocket.width, height: rocket.height};
                        // if(hitTestRectangle(laserRect,rocketRect)) {
                        //     explode(1,{x:rocket.x,y:rocket.y});
                        //     if(!invincible) {
                        //         healthBar.width -= 1;
                        //     }
                        // }
                        // if(enemy.energy <= 0) {
                        //     enemy.laser.visible = false;
                        //     enemy.energy = 150;
                        //     enemy.laserFire = Date.now();
                        // }
                    }
                    
                } else if(enemy.level === "missileship") {
                    if(enemy.alpha < 1) {
                        enemy.alpha += 0.001;
                    }
                    if(enemy.scale.x < 3*scaleFactor) {
                        enemy.scale.x += 0.01*scaleFactor;
                        enemy.scale.y += 0.01*scaleFactor;
                    }
                    if(enemy.health < 10) {
                        healthBar.width = 200;
                        energyBar.width = 200;
                        enemy.level = "bossattack";
                        enemy.waitTime = Date.now();
                        enemy.waitRate = 40000 * difficulty;
                        enemy.backupRate = 20000;
                        enemy.backupFire = Date.now() - 150000;
                        enemy.laser.visible = false;
                        // enemy.laserRate = 40000 * difficulty;
                        enemy.health = Infinity;
                        enemy.bossesToSpawn = 3;

                    }
                    if(enemy.y < 150) {
                        enemy.y += 1*scaleFactor;
                    }
                    if(enemy.x + 15 < rocket.x) {
                        enemy.x += 5*scaleFactor;
                    } else if(enemy.x - 15 > rocket.x) {
                        enemy.x -= 5*scaleFactor;
                    } else if(Date.now() - enemy.reloadTime > enemy.lastFire) {
                        shootLaser("bad", {x:enemy.x, y: enemy.y}, 190 * Math.PI/180);
                        shootLaser("bad", {x:enemy.x, y: enemy.y}, 195 * Math.PI/180);
                        shootLaser("bad", {x:enemy.x, y: enemy.y}, 185 * Math.PI/180);
                        shootLaser("bad", {x:enemy.x, y: enemy.y}, 200 * Math.PI/180);
                        shootLaser("bad", {x:enemy.x, y: enemy.y}, 170 * Math.PI/180);
                        shootLaser("bad", {x:enemy.x, y: enemy.y}, 160 * Math.PI/180);
                        shootLaser("bad", {x:enemy.x, y: enemy.y}, 180 * Math.PI/180);
                        shootLaser("bad", {x:enemy.x, y: enemy.y}, 175 * Math.PI/180);
                        shootLaser("bad", {x:enemy.x, y: enemy.y}, 165 * Math.PI/180);
                        launchMissile("bad", {x: enemy.x - enemy.width/2, y: enemy.y - enemy.height / 2.1}, rocket, 5);
                        launchMissile("bad", {x: enemy.x + enemy.width/2, y: enemy.y - enemy.height / 2.1}, rocket, 5);
                        launchMissile("bad", {x: enemy.x, y: enemy.y + enemy.height / 2.1}, rocket, 5);
                        enemy.lastFire = Date.now();
                    }

                    // if(Date.now() - enemy.laserRate > enemy.laserFire && enemy.level !== "nursing-mother") {
                    //     --enemy.energy;
                    //     enemy.laser.visible = true;
                    //     enemy.laser.x = enemy.x;
                    //     enemy.laser.y = enemy.y;
                    //     var laserRect = {x:enemy.laser.x-25,y:enemy.laser.y,width:50,height:innerHeight*2};
                    //     var rocketRect = {x: rocket.x - rocket.width/2, y: rocket.y - rocket.height/2, width: rocket.width, height: rocket.height};
                    //     if(hitTestRectangle(laserRect,rocketRect)) {
                    //         explode(1,{x:rocket.x,y:rocket.y});
                    //         if(!invincible) {
                    //             healthBar.width -= 1;
                    //         }
                    //     }
                    //     if(enemy.energy <= 0) {
                    //         enemy.laser.visible = false;
                    //         enemy.energy = 150;
                    //         enemy.laserFire = Date.now();
                    //     }
                    } else if(enemy.level === "bossattack") {
                        if(enemy.alpha > 0.5) {
                            enemy.alpha -= 0.001;
                        }
                        if(enemy.scale.x > 1*scaleFactor) {
                            enemy.scale.x -= 0.01*scaleFactor;
                            enemy.scale.y -= 0.01*scaleFactor;
                        }
                        if(enemies.length === 1) {
                            if(enemy.bossesToSpawn === 3) {
                                --enemy.bossesToSpawn;
                                spawnNewEnemy(1, "boss1");
                            } else if(enemy.bossesToSpawn === 2) {
                                spawnNewEnemy(1, "boss2");
                                --enemy.bossesToSpawn;
                            } else if(enemy.bossesToSpawn === 1) {
                                spawnNewEnemy(1, "boss3")[0].xOffset = 200;
                                spawnNewEnemy(1, "boss3")[0].xOffset = -200;
                                spawnNewEnemy(1, "boss3")[0].xOffset = 0;
                                --enemy.bossesToSpawn;
                            } else {
                                healthBar.width = 200;
                                energyBar.width = 200;
                                enemy.level = "maxxforce";
                                enemy.health = 250*difficulty;
                                enemy.lastFire = Date.now();
                                enemy.empFire = Date.now();
                                enemy.empRate = 17500/difficulty;
                                enemy.EMPenergy = innerWidth / 10;
                            }
                        }
                        if(enemy.alpha > 0.5) {
                            enemy.alpha -= 0.001;
                        }
                        if(enemy.scale.x > 1*scaleFactor) {
                            enemy.scale.x -= 0.01*scaleFactor;
                            enemy.scale.y -= 0.01*scaleFactor;
                        }
                        // if(enemy.y > -350) {
                            // enemy.y -= 3;
                        // }
                        if(enemy.x + 15 < rocket.x) {
                            enemy.x += 2*scaleFactor;
                        } else if(enemy.x - 15 > rocket.x) {
                            enemy.x -= 2*scaleFactor;
                        } else if(Date.now() - enemy.reloadTime > enemy.lastFire) {
                            // shootLaser("bad", {x:enemy.x, y: enemy.y}, 190 * Math.PI/180);
                            // shootLaser("bad", {x:enemy.x, y: enemy.y}, 195 * Math.PI/180);
                            // shootLaser("bad", {x:enemy.x, y: enemy.y}, 185 * Math.PI/180);
                            // shootLaser("bad", {x:enemy.x, y: enemy.y}, 200 * Math.PI/180);
                            // shootLaser("bad", {x:enemy.x, y: enemy.y}, 170 * Math.PI/180);
                            // shootLaser("bad", {x:enemy.x, y: enemy.y}, 160 * Math.PI/180);
                            // shootLaser("bad", {x:enemy.x, y: enemy.y}, 180 * Math.PI/180);
                            // shootLaser("bad", {x:enemy.x, y: enemy.y}, 175 * Math.PI/180);
                            // shootLaser("bad", {x:enemy.x, y: enemy.y}, 165 * Math.PI/180);
                            // enemy.lastFire = Date.now();
                        }
                        // if(Date.now() - enemy.backupRate > enemy.backupFire && (enemy.waitTime + enemy.waitRate > Date.now())) {
                        //     var formationTypeToSummon = randInt(1,6);
                        //     if(formationTypeToSummon < 2) {
                        //         spawnNewFormation("drone", "V", 7);
                        //     } else if(formationTypeToSummon < 3) {
                        //         spawnNewFormation("drone", "N", 7);
                        //     } else if(formationTypeToSummon < 4) {
                        //         spawnNewEnemy(10, "easy");
                        //     } else if(formationTypeToSummon < 5) {
                        //         spawnNewEnemy(4, "medium");
                        //     } else if(formationTypeToSummon < 6) {
                        //         spawnNewEnemy(4, "medium");
                        //         spawnNewEnemy(4, "easy");
                        //     } else {
                        //         spawnNewFormation("drone", "V", 5);
                        //         spawnNewFormation("drone", "N", 5);
                        //     }
                        //     enemy.backupFire = Date.now();
                        // }
                        if(Date.now() - enemy.laserRate > enemy.laserFire) {
                            // --enemy.energy;
                            // enemy.laser.visible = true;
                            // enemy.laser.x = enemy.x;
                            // enemy.laser.y = enemy.y;
                            // var laserRect = {x:enemy.laser.x-25,y:enemy.laser.y,width:50,height:innerHeight*2};
                            // var rocketRect = {x: rocket.x - rocket.width/2, y: rocket.y - rocket.height/2, width: rocket.width, height: rocket.height};
                            // if(hitTestRectangle(laserRect,rocketRect)) {
                            //     explode(1,{x:rocket.x,y:rocket.y});
                            //     if(!invincible) {
                            //         healthBar.width -= 1;
                            //     }
                            // }
                            // if(enemy.energy <= 0) {
                            //     enemy.laser.visible = false;
                            //     enemy.energy = 150;
                            //     enemy.laserFire = Date.now();
                            // }
                        }
                    } else if(enemy.level === "maxxforce") {
                        if(enemy.alpha < 1) {
                            enemy.alpha += 0.001;
                        }
                        if(enemy.scale.x < 3*scaleFactor) {
                            enemy.scale.x += 0.01*scaleFactor;
                            enemy.scale.y += 0.01*scaleFactor;
                        }
                        if(enemy.health < 5) {
                            
                            state = win;
                            textDiv.innerHTML = "You win!";
                        }
                        if(enemy.y < 150) {
                            enemy.y += 1*scaleFactor;
                        }
                        if(enemy.x + 15 < rocket.x) {
                            enemy.x += 5*scaleFactor;
                        } else if(enemy.x - 15 > rocket.x) {
                            enemy.x -= 5*scaleFactor;
                        } else if(Date.now() - enemy.reloadTime > enemy.lastFire) {
                            shootLaser("bad", {x:enemy.x, y: enemy.y}, 190 * Math.PI/180);
                            shootLaser("bad", {x:enemy.x, y: enemy.y}, 195 * Math.PI/180);
                            shootLaser("bad", {x:enemy.x, y: enemy.y}, 185 * Math.PI/180);
                            shootLaser("bad", {x:enemy.x, y: enemy.y}, 200 * Math.PI/180);
                            shootLaser("bad", {x:enemy.x, y: enemy.y}, 170 * Math.PI/180);
                            shootLaser("bad", {x:enemy.x, y: enemy.y}, 160 * Math.PI/180);
                            shootLaser("bad", {x:enemy.x, y: enemy.y}, 180 * Math.PI/180);
                            shootLaser("bad", {x:enemy.x, y: enemy.y}, 175 * Math.PI/180);
                            shootLaser("bad", {x:enemy.x, y: enemy.y}, 165 * Math.PI/180);
                            launchMissile("bad", {x: enemy.x - enemy.width/2, y: enemy.y - enemy.height / 2.1}, rocket, 5);
                            launchMissile("bad", {x: enemy.x + enemy.width/2, y: enemy.y - enemy.height / 2.1}, rocket, 5);
                            launchMissile("bad", {x: enemy.x, y: enemy.y + enemy.height / 2.1}, rocket, 5);
                            enemy.lastFire = Date.now();
                        }

                        if(Date.now() - enemy.empRate > enemy.empFire) {
                            --enemy.EMPenergy;
                            if(!enemyEMP.visible) {
                                enemyEMP.scale.set(0.5*scaleFactor);
                            }
                            enemyEMP.visible = true;
                            enemyEMP.x = enemy.x;
                            enemyEMP.y = enemy.y;
                            enemyEMP.scale.x += 0.1*scaleFactor;
                            enemyEMP.scale.y += 0.1*scaleFactor;
                            enemyEMP.rotation += 0.1;
                            if(getDistance(rocket.x,rocket.y,enemyEMP.x,enemyEMP.y) < enemyEMP.width/2) {
                                if(!invincible) {
                                    healthBar.width -= healthToHit/8;
                                }
                                explode(1,rocket);
                            }
                            if(enemy.EMPenergy <= 0) {
                                enemy.EMPenergy = innerWidth/10;
                                enemyEMP.visible = false;
                                enemy.empFire = Date.now();
                            }
                        }
                        if(Date.now() - enemy.laserRate > enemy.laserFire && enemy.level !== "nursing-mother") {
                            --enemy.energy;
                            enemy.laser.visible = true;
                            enemy.laser.x = enemy.x;
                            enemy.laser.y = enemy.y;
                            var laserRect = {x:enemy.laser.x-25,y:enemy.laser.y,width:50,height:innerHeight*2};
                            var rocketRect = {x: rocket.x - rocket.width/2, y: rocket.y - rocket.height/2, width: rocket.width, height: rocket.height};
                            if(hitTestRectangle(laserRect,rocketRect)) {
                                explode(1,{x:rocket.x,y:rocket.y});
                                if(!invincible) {
                                    healthBar.width -= 1;
                                }
                            }
                            if(enemy.energy <= 0) {
                                enemy.laser.visible = false;
                                enemy.energy = 150;
                                enemy.laserFire = Date.now();
                            }
                        }
                    }
            } else {
                enemy.alpha -= 0.05;
                enemyEMP.visible = false;
                if (enemy.alpha <= 0) {
                    if(enemy.level === "boss1" && enemies[0].level !== "bossattack") {
                        healthBar.width = 200;
                        healthToHit -= 2;
                        energyToFire--;
                        energyBar.width = 200;
                        boss1.fade(0.5,0, 3000);
                        setTimeout(function() {
                            music.fade(0, 0.5, 3000);
                        },3000);
                        canUseMissiles = true;
                    }
                    if(enemy.level === "boss2" && enemies[0].level !== "bossattack") {
                        healthBar.width = 200;
                        healthToHit -= 2;
                        energyToFire--;
                        energyBar.width = 200;
                        boss2.fade(0.5,0, 3000);
                        setTimeout(function() {
                            music.fade(0, 0.5, 3000);
                        },3000);
                        canUseEMP = true;
                    } else if(enemy.level === "boss3" && enemy.xOffset === 0 && enemies[0].level !== "bossattack") {
                        var foundEnemy1 = false;
                        var foundEnemy2 = false;
                        enemies.forEach(function(bad) {
                            if(bad.xOffset === -200) {
                                foundEnemy1 = bad;
                            } else if(bad.xOffset === 200) {
                                foundEnemy2 = bad;
                            }
                        });
                        if(foundEnemy1) {
                            foundEnemy1.xOffset = 0;
                        } else if(foundEnemy2) {
                            foundEnemy2.xOffset = 0;
                        } else {
                            healthBar.width = 200;
                            reloadTime /= 2;
                            energyBar.width = 200;
                            boss3.fade(0.5,0, 3000);
                            setTimeout(function() {
                                music.fade(0, 0.5, 3000);
                            },3000);
                        }
                        canUseLaser = true;
                    }
                    if(enemy.laser) {
                        enemy.laser.visible = false;
                    }
                    app.stage.removeChild(enemy);
                    enemies.splice(i,1);
                    --i;
                }
            }
        }
        if(enemies.length === 0) {
            ++level;
            difficulty += 0.05;
            if(level < 6) {
                spawnNewEnemy(level, "easy");
            } else if (level < 6.1) {
                spawnNewEnemy(1, "boss1");
                music.fade(0.5,0,2000);
                setTimeout(function(){
                    boss1.play();
                    boss1.fade(0,0.5,2000);
                }, 2000);
            } else if(level < 8) {
                spawnNewEnemy(2, "medium");
            } else if(level < 10) {
                spawnNewEnemy(3, "medium");
            } else if(level < 11) {
                spawnNewEnemy(4, "medium");
            } else if(level < 11.1) {
                spawnNewEnemy(1, "boss2");
                music.fade(0.5,0,2000);
                setTimeout(function(){
                    boss2.play();
                    boss2.fade(0,0.5,2000);
                }, 2000);
            } else if(level < 12) {
                spawnNewFormation("drone", "V", 4);
            } else if(level < 13) {
                spawnNewFormation("drone", "N", 5);
            } else if(level < 14) {
                spawnNewFormation("drone", "V", 7);
            } else if (level < 15) {
                spawnNewFormation("drone", "N", 9);
            } else if(level < 16) {
                spawnNewFormation("drone", "N", 5);
                spawnNewFormation("drone", "V", 5);
            } else if(level < 16.1) {
                music.fade(0.5,0,2000);
                setTimeout(function(){
                    boss3.play();
                    boss3.fade(0,0.5,2000);
                }, 2000);
                spawnNewEnemy(1, "boss3")[0].xOffset = 200;
                spawnNewEnemy(1, "boss3")[0].xOffset = -200;
                spawnNewEnemy(1, "boss3")[0].xOffset = 0;
            } else if(fullLevel) {
                spawnNewEnemy(1, "mothership");
                if(levelEl.selectedIndex === 0) {
                    difficulty = 1;
                    invincible = true;
                } else if(levelEl.selectedIndex === 1) {
                    difficulty = 0.25;
                } else if(levelEl.selectedIndex === 2) {
                    difficulty = 0.5;
                } else if(levelEl.selectedIndex === 3) {
                    difficulty = 0.75;
                } else if(levelEl.selectedIndex === 4) {
                    difficulty = 1;
                } else if(levelEl.selectedIndex === 5) {
                    difficulty = 1.25;
                }
                music.fade(0.5,0,2000);
                setTimeout(function(){
                    mothership.play();
                    mothership.fade(0,0.5,2000);
                }, 2000);
            } else {
                spawnNewEnemy(level/5, "medium");
                spawnNewEnemy(level/5, "easy");
                if(level > 20) {
                    spawnNewFormation("drone", "N", 5);
                    spawnNewFormation("drone", "V", 5);
                    fullLevel = true;
                }
            }
        }
        for(var i = 0; i < explosions.length; i++) {
            explosions[i].alpha -= 0.05;
            if(explosions[i].alpha <= 0) {
                app.stage.removeChild(explosions[i]);
                explosions.splice(i,1);
                --i;
            }
        }
    }
    var formations = [];
    function spawnNewFormation(type, formation, endSize) {
        var set = [];
        if(formation === "V") {
            var counter = Math.floor((innerWidth/2-100)/100);
            for(var i = ((Math.ceil(innerWidth/200) * 100 ) -endSize*100); i < innerWidth/2; i+=100) {
                set.push(spawnNewEnemy(1, type, {x:i, y: counter*-100-200})[0])
                --counter;
            }
            // i += 100;
            for(i; i < innerWidth/2 + endSize*100; i += 100) {
                set.push(spawnNewEnemy(1, type, {x:i, y: counter*-100-200})[0])
                ++counter;
            }
        } else if(formation === "N") {
            var counter = Math.floor((innerWidth/2-100)/100);
            for(var i = ((Math.ceil(innerWidth/200) * 100 ) -endSize*100); i < innerWidth/2; i+=100) {
                set.push(spawnNewEnemy(1, type, {x:i, y: counter*-100-200})[0])
                ++counter;
            }
            // i += 100;
            for(i; i < innerWidth/2 + endSize*100; i += 100) {
                set.push(spawnNewEnemy(1, type, {x:i, y: counter*-100-200})[0])
                --counter;
            }
        }
        for(let i = 0; i < set.length; i++) {
            set[i].formation = set;
            set[i].formationMovement = {x:0,y:0};
        }
        console.log(set)
        formations.push(set);
    }
    function spawnNewEnemy(amount, type, position) {
        var y = -200;
        var enemiesAdded = [];
        console.log(amount, type, position);
        for(let i = 0; i < amount; i++) {
            if(type === "easy") {
                var enemy = new Sprite(resources["sprites/enemy.png"].texture);
                app.stage.addChild(enemy);
                enemy.scale.set(3*scaleFactor);
                enemy.anchor.set(0.5,0.5);
                if(position) {
                    enemy.x = position.x;
                    enemy.y = position.y;
                } else {
                    enemy.x = randInt(100, innerWidth - 100);
                    enemy.y = y;
                }
                enemy.rotation = Math.PI;
                enemy.health = randInt(0.5,1.5) * difficulty;
                enemy.lastFire = 0;
                enemy.reloadTime = 3000/difficulty;
            } else if (type === "medium") {
                var enemy = new Sprite(resources["sprites/medium.png"].texture);
                app.stage.addChild(enemy);
                enemy.scale.set(3*scaleFactor);
                enemy.anchor.set(0.5,0.5);
                if(position) {
                    enemy.x = position.x;
                    enemy.y = position.y;
                } else {
                    enemy.x = randInt(100, innerWidth - 100);
                    enemy.y = y;
                }
                enemy.rotation = Math.PI;
                enemy.health = randInt(5,7) * difficulty;
                enemy.lastFire = 0;
                enemy.reloadTime = 5000/difficulty;
            } else if(type === "boss1") {
                var enemy = new Sprite(resources["sprites/boss1.png"].texture);
                app.stage.addChild(enemy);
                enemy.scale.set(3*scaleFactor);
                enemy.anchor.set(0.5,0.5);
                if(position) {
                    enemy.x = position.x;
                    enemy.y = position.y;
                } else {
                    enemy.x = randInt(100, innerWidth - 100);
                    enemy.y = -600;
                }
                enemy.rotation = Math.PI;
                enemy.health = 15 * difficulty;
                enemy.lastFire = 0;
                enemy.reloadTime = 5000/difficulty;
                if(enemies[0]) {
                    if(enemies[0].level === "bossattack") {
                        enemy.health *= 3;
                    }
                }
            } else if(type === "boss2") {
                var enemy = new Sprite(resources["sprites/boss2.png"].texture);
                app.stage.addChild(enemy);
                enemy.scale.set(3*scaleFactor);
                enemy.anchor.set(0.5,0.5);
                if(position) {
                    enemy.x = position.x;
                    enemy.y = position.y;
                } else {
                    enemy.x = innerWidth/2;
                    enemy.y = -600;
                }
                enemy.rotation = Math.PI;
                enemy.health = 20 * difficulty;
                enemy.burstFire = 0;
                enemy.burstRate = 10000/difficulty;
                enemy.lastFire = Date.now();
                enemy.reloadTime = 100/difficulty;
                enemy.empFire = Date.now();
                enemy.empRate = 17500/difficulty;
                enemy.bursts = 25;
                enemy.energy = innerWidth/10;
                if(enemies[0]) {
                    if(enemies[0].level === "bossattack") {
                        enemy.health *= 3;
                    }
                }
            } else if(type === "drone") {
                var enemy = new Sprite(resources["sprites/drone.png"].texture);
                app.stage.addChild(enemy);
                enemy.scale.set(3*scaleFactor);
                enemy.anchor.set(0.5,0.5);
                if(position) {
                    enemy.x = position.x;
                    enemy.y = position.y;
                } else {
                    enemy.x = randInt(100, innerWidth - 100);
                    enemy.y = y;
                }
                enemy.rotation = Math.PI;
                enemy.health = randNum(0.1,0.5) * difficulty;
                enemy.lastFire = 0;
                enemy.reloadTime = 3000/difficulty;
            } else if(type === "boss3") {
                var enemy = new Sprite(resources["sprites/boss3.png"].texture);
                app.stage.addChild(enemy);
                enemy.scale.set(3*scaleFactor);
                enemy.anchor.set(0.5,0.5);
                if(position) {
                    enemy.x = position.x;
                    enemy.y = position.y;
                } else {
                    enemy.x = randInt(100, innerWidth - 100);
                    enemy.y = -600;
                }
                enemy.rotation = Math.PI;
                enemy.health = 15 * difficulty;
                enemy.lastFire = 0;
                enemy.reloadTime = 5000/difficulty;
                enemy.laserFire = Date.now();
                enemy.laserRate = 10000/difficulty;
                enemy.energy = 150;
                enemy.backupFire = Date.now() - randInt(0, 30000);
                enemy.backupRate = 55000/difficulty;
                enemy.laser = new PIXI.Graphics();
                enemy.laser.beginFill(0xffaaaa);
                enemy.laser.drawRect(-25,0,50, innerHeight * 2);
                app.stage.addChild(enemy.laser);
                enemy.laser.visible = false;
                if(enemies[0]) {
                    if(enemies[0].level === "bossattack") {
                        enemy.health *= 1.5;
                    }
                }
            } else if(type === "mothership") {
                var enemy = new Sprite(resources["sprites/mothership.png"].texture);
                app.stage.addChild(enemy);
                enemy.scale.set(3*scaleFactor);
                enemy.anchor.set(0.5,0.5);
                if(position) {
                    enemy.x = position.x;
                    enemy.y = position.y;
                } else {
                    enemy.x = randInt(100, innerWidth - 100);
                    enemy.y = -600;
                }
                enemy.rotation = Math.PI;
                enemy.health = 100 * difficulty;
                enemy.lastFire = 0;
                enemy.reloadTime = 2500/difficulty;
                enemy.laserFire = Date.now();
                enemy.laserRate = 5000/difficulty;
                enemy.energy = 200;
                enemy.backupFire = Date.now() - randInt(0, 30000);
                enemy.backupRate = 55000/difficulty;
                enemy.laser = new PIXI.Graphics();
                enemy.laser.beginFill(0xffaaaa);
                enemy.laser.drawRect(-25,0,50, innerHeight * 2);
                app.stage.addChild(enemy.laser);
                enemy.laser.visible = false;
            }
            enemiesAdded.push(enemy);
            enemy.level = type;
            enemies.push(enemy);
            y -= 150 + randInt(25,100);
        }
        return enemiesAdded;
    }
    function launchMissile(type, position, target, speed) {
        if(type === "good") {
            var laser = new Sprite(resources["sprites/missile.png"].texture);
            laser.good = true;
        } else {
            /// TODO: Red
            var laser = new Sprite(resources["sprites/missile.png"].texture);
            laser.good = false;
        }
        laser.speed = speed;
        laser.x = position.x;
        laser.y = position.y;
        laser.anchor.set(0.5,0.5);
        if(type === "good") {
            laser.health = 300;
        } else {
            laser.health = 200;
        }
        laser.target = target;
        missiles.push(laser);
        app.stage.addChild(laser);
    }
    var storeRange;
    function shootLaser(type, position, dir) {
        if(type === "good") {
            var laser = new Sprite(resources["sprites/laser.png"].texture);
            laser.good = true;
        } else {
            /// TODO: Red
            var laser = new Sprite(resources["sprites/enemy-laser.png"].texture);
            laser.good = false;
        }
        laser.x = position.x;
        laser.y = position.y;
        laser.anchor.set(0.5,0.5);
        laser.scale.set(3*scaleFactor);
        laser.rotation = -dir;
        lasers.push(laser);
        app.stage.addChild(laser);
    }
    function press(key){
        if(keys[key]){
            keys[key] = false;
            return true;
        }
        return false;
    }
    addEventListener("mousedown",function(e){
        if(e.button == 0) {
            keys.mouse = true;
        } else if(e.button == 2) {
            keys.rightMouse = true;
        }
        mouseX = e.pageX;
        mouseY = e.pageY;
    });
    addEventListener("mouseup",function(e){
        if(e.button == 0) { 
            keys.mouse = false;
        } else if(e.button == 2) {
            keys.rightMouse = true;
        }
    });
    addEventListener("blur", function (){
        keys = {};
    });
    addEventListener("mousemove",function(e){
        mouseX = e.pageX;
        mouseY = e.pageY;
    });
    var learnSpeed = 2;
    var answersLocked = false;
    var code = ["R", "E", "S", "T", "O", "R", "E"];
    var codeNum = 0;
    var mistakeReview = false;
    addEventListener("keydown", function (e){
        if(code[codeNum] === e.key) {
            ++codeNum;
            if(codeNum === code.length) {
                codeNum = 0;
                healthBar.width = 200;
                energyBar.width = 200;
                if(!invincible) {
                    invincible = true;
                    rocket.alpha = 0.5;
                    setTimeout(function() {
                        invincible = false;
                        rocket.alpha = 1;
                    }, 5000);
                }
            }
        }
        if(!answersLocked && ((Number(e.key) >= 0 && e.key !== " ") || e.key === "." || e.key === ":")) {
            numDiv.innerHTML += e.key;
        }
        if(e.key === "Enter" && !answersLocked) {
            if (numDiv.innerHTML === correctAnswer || (chapter !== false && (correctAnswer.split(".")[1] === numDiv.innerHTML)) || numDiv.innerHTML.replace(" ",".") === correctAnswer || numDiv.innerHTML.replace(":",".") === correctAnswer) { 
                if(energyBar.width + 40 > 200) {
                    healthBar.width += (energyBar.width + 40 - 200)/3;
                    energyBar.width = 200;
                } else {
                    energyBar.width += 40;
                }
                if(healthBar.width > 200) {
                    healthBar.width = 200;
                }
                if(verseTracking[correctAnswer]) {
                    verseTracking[correctAnswer].correct++;
                } else {
                    verseTracking[correctAnswer] = {correct: 1, incorrect: 0};
                }
                numDiv.innerHTML = "";
                --questionsLeft;
                if(questionsLeft <= 0) {
                    if(chapter !== false) {
                        if(rangeDiv.innerHTML !== "Review") {
                            var range = rangeDiv.innerHTML;
                        } else {
                            range = storeRange;
                        }
                        var full = true;
                        if(range.split("-")[0] === "1" && !mistakeReview) {
                            mistakeReview = true;
                            storeRange = range;
                            rangeDiv.innerHTML = "Review"
                        } else if (range.split("-")[0] === "1") {
                            var arr = range.split(/\-|\,/);
                            if(Number(arr[1]) + 3 < rom18[chapter-1].length) {
                                range = (Number(arr[1])) + "-" + (Number(arr[1]) + 3);
                            } else if(Number(arr[1]) < rom18[chapter-1].length) {
                                range = arr[1] + "-" + rom18[chapter-1].length;
                            } else {
                                fullLevel = true;
                            }
                            full = false;
                            rangeDiv.innerHTML = range;
                            mistakeReview = false;
                        } else {
                            var arr = range.split(/\-|\,/);
                            range = "1-" + arr[1];
                            rangeDiv.innerHTML = range;
                            mistakeReview = false;
                        }
                        var cur = range.split(/\-|\,/);
                        if(Number(cur[0]) < Number(cur[1]) && Number(cur[0]) >= 0) {
                            if(Number(cur[1]) <= rom18[chapter-1].length) {
                                params.min = cur[0];
                                params.max = cur[1];
                            }
                        }
                        if(full && !mistakeReview) {
                            questionsLeft = params.max/learnSpeed;
                        } else {
                            questionsLeft = params.max/(2*learnSpeed);
                        }
                    }
                }
            } else {
                if(verseTracking[correctAnswer]) {
                    verseTracking[correctAnswer].incorrect++;
                } else {
                    verseTracking[correctAnswer] = {correct: 0, incorrect: 1};
                }
                answersLocked = true;
                numDiv.style.color = "red";
                var corAns = correctAnswer;
                setTimeout(function() {
                    numDiv.style.color = "green";
                    numDiv.innerHTML = corAns;
                },1000);
                setTimeout(function() {
                    numDiv.style.color = "white";
                    numDiv.innerHTML = "";
                    answersLocked = false;
                },2000);
            }

            curVerse = randVerse();
            correctAnswer = curVerse[0];
            curVerse = curVerse[1];
            textDiv.innerHTML = curVerse;
        }
        if(e.key === "Delete" || e.key === "Backspace") {
            numDiv.innerHTML = "";
        }
        keys[e.key] = true;
    });
    addEventListener("keyup", function (e){
        keys[e.key] = false;
    });
  </script>
</body>
</html>