<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>RA Blaster</title>
</head>
    <style>* {padding: 0; margin: 0}</style>
    <script src="pixi/pixi.min.js"></script>
    <script src="usefulFunctions.js"></script>
    <script src="howler.core.min.js"></script>
    <div id="central"></div>
    <select style="position:absolute", id="chapter">
        <option>John 1</option>
        <option>John 2</option>
        <option>John 3</option>
        <option>John 4</option>
        <option>John 5</option>
        <option>John 6</option>
    </select>
    <select style="position:absolute; top: 20px", id="level">
        <option>Invincible</option>
        <option>Novice</option>
        <option>Easy</option>
        <option>Medium</option>
        <option>Hard</option>
        <option>Insane</option>
    </select>
    <input type="text" value="1-4" style="position:absolute; top: 40px", id="range">
    <button id="start", style="position: absolute; top: 60px">&nbsp;Start&nbsp;</button>
<body>
  <script type="text/javascript">
    "use strict";
    
    var params = getParams();
    function getParams() {
      var params = {};
      location.search.substr(1).split("&").forEach(function(el) {
        var data = el.replace(/\+/g, " ").split("=");
        params[decodeURIComponent(data[0])] = data[1] ? decodeURIComponent(data[1]) : true;
      });
      return params;
    }
    PIXI.utils.skipHello();
    PIXI.settings.SCALE_MODE = PIXI.SCALE_MODES.NEAREST;
    let Application = PIXI.Application,
        Container = PIXI.Container,
        loader = PIXI.loader,
        resources = PIXI.loader.resources,
        TextureCache = PIXI.utils.TextureCache,
        Sprite = PIXI.Sprite,
        Rectangle = PIXI.Rectangle,
        Graphics = PIXI.Graphics;
    let app = new Application({ 
        width: 800,
        height: 800,              
        antialias: true,
        transparent: false,
        resolution: 1
      }
    );
    var chapterEl = document.getElementById("chapter");
    var levelEl = document.getElementById("level");
    var inputEl = document.getElementById("range");
    var buttonStartEl = document.getElementById("start");
    var invincible = false;
    chapterEl.style.zIndex = "100";
    levelEl.style.zIndex = "100";
    inputEl.style.zIndex = "100";
    buttonStartEl.style.zIndex = "100";
    buttonStartEl.addEventListener("click", function() {
        chapter = chapterEl.selectedIndex+1;

        rangeDiv.innerHTML = inputEl.value;
        params.min = inputEl.value.split("-")[0];
        params.max = inputEl.value.split("-")[1];
        questionsLeft = params.max;

        if(levelEl.selectedIndex === 0) {
            difficulty = 1;
            invincible = true;
        } else if(levelEl.selectedIndex === 1) {
            difficulty = 0.25;
        } else if(levelEl.selectedIndex === 2) {
            difficulty = 0.5;
        } else if(levelEl.selectedIndex === 3) {
            difficulty = 0.75;
        } else if(levelEl.selectedIndex === 4) {
            difficulty = 1;
        } else if(levelEl.selectedIndex === 5) {
            difficulty = 1.25;
        }
        chapterEl.remove();
        levelEl.remove();
        inputEl.remove();
        buttonStartEl.remove();

        curVerse = randVerse();
        correctAnswer = curVerse[0];
        curVerse = curVerse[1];
        textDiv.innerHTML = curVerse;

        intro.fade(0.5,0, 3000);
        setTimeout(function() {
            music.play();
            music.fade(0, 0.5, 3000);
        },3000);
        state = play;
        app.ticker.add(delta => gameLoop(delta));
    });
    var central = document.getElementById("central");
    central.style.position = "absolute";
    central.style.zIndex = "100";
    central.style.width = (innerWidth- 200) + "px";
    central.style.display = "flex";
    central.style.left = "100px";
    central.style.alignItems = "center";
    central.style.justifyContent = "center";
    app.renderer.backgroundColor = 0x000015;
    /// Fill the screen 
    app.renderer.view.style.position = "absolute";
    app.renderer.view.style.display = "block";
    app.renderer.autoResize = true;
    app.renderer.resize(window.innerWidth, window.innerHeight);
    document.body.appendChild(app.view);
    loader.add(["sprites/exp1.png","sprites/exp2.png","sprites/exp3.png", "sprites/enemy.png", "sprites/rocket.png", "sprites/laser.png", "sprites/medium.png", "sprites/emp.png", "sprites/enemyEMP.png", "sprites/boss1.png", "sprites/missile.png", "sprites/boss2.png", "sprites/drone.png", "sprites/boss3.png", "sprites/enemy-laser.png"]).load(setup);
    var textDiv = document.createElement("div");
    textDiv.style.position = "relative";
    // textDiv.innerHTML = "In the beginning was the Word."
    textDiv.style.fontSize = "30px";
    textDiv.style.color = "white";
    central.appendChild(textDiv);
    var numDiv = document.createElement("div");
    numDiv.style.position = "absolute";
    numDiv.style.right = "-100px";
    numDiv.innerHTML = "";
    numDiv.style.fontSize = "30px";
    numDiv.style.color = "white";
    central.appendChild(numDiv);

    var rangeDiv = document.createElement("div");
    rangeDiv.style.position = "absolute";
    rangeDiv.style.left = "-100px";
    rangeDiv.style.top = innerHeight-40 + "px";
    rangeDiv.innerHTML = "1-4";
    params.min = 1;
    params.max = 4;
    var questionsLeft = 4;
    rangeDiv.style.fontSize = "30px";
    rangeDiv.style.color = "white";
    central.appendChild(rangeDiv);
    var energyHolder = new PIXI.Graphics();
    energyHolder.lineStyle(5, 0x00AAAA,10);
    energyHolder.beginFill(0x000015);
    energyHolder.drawRect(0,0,200,25)
    app.stage.addChild(energyHolder);
    energyHolder.x = innerWidth - 225;
    energyHolder.y = innerHeight - 50;
    var energyBar = new PIXI.Graphics();
    energyBar.lineStyle(5, 0x00AAAA,10);
    energyBar.beginFill(0x00AAAA, 10);
    energyBar.drawRect(0,0,200,25);
    energyBar.x = innerWidth - 225;
    energyBar.y = innerHeight - 50;
    app.stage.addChild(energyBar);



    var healthHolder = new PIXI.Graphics();
    healthHolder.lineStyle(5, 0xFF0000,10);
    healthHolder.beginFill(0x000015);
    healthHolder.drawRect(0,0,200,25)
    app.stage.addChild(healthHolder);
    healthHolder.x = innerWidth - 225;
    healthHolder.y = innerHeight - 100;
    var healthBar = new PIXI.Graphics();
    healthBar.lineStyle(5, 0xFF0000,10);
    healthBar.beginFill(0xFF0000, 10);
    healthBar.drawRect(0,0,200,25);
    healthBar.x = innerWidth - 225;
    healthBar.y = innerHeight - 100;
    app.stage.addChild(healthBar);

    var intro = new Howl({src: ["music/intro.mp3"], autoplay: true, loop: true, volume: 0.5});
    var music = new Howl({src: ["music/level1.mp3"], autoplay: false, loop: true, volume: 0.5});
    /// TODO: Change intro to intro after we get intro and music to battle after the intro ends.
    var boss1 = new Howl({src: ["music/boss1.mp3"], autoplay: false, loop: true, volume: 0});
    var boss2 = new Howl({src: ["music/boss2.mp3"], autoplay: false, loop: true, volume: 0});
    var boss3 = new Howl({src: ["music/boss3.mp3"], autoplay: false, loop: true, volume: 0});


    var john16 = [["In the beginning was the Word, and the Word was with God, and the Word was God.", "The same was in the beginning with God.", "All things were made by him; and without him was not any thing made that was made.", "In him was life; and the life was the light of men.", "And the light shineth in darkness; and the darkness comprehended it not.", "There was a man sent from God, whose name was John.", "The same came for a witness, to bear witness of the Light, that all men through him might believe.", "He was not that Light, but was sent to bear witness of that Light.", "That was the true Light, which lighteth every man that cometh into the world.", "He was in the world, and the world was made by him, and the world knew him not.", "He came unto his own, and his own received him not.", "But as many as received him, to them gave he power to become the sons of God, even to them that believe on his name:", "Which were born, not of blood, nor of the will of the flesh, nor of the will of man, but of God.", "And the Word was made flesh, and dwelt among us, (and we beheld his glory, the glory as of the only begotten of the Father,) full of grace and truth.", "John bare witness of him, and cried, saying, This was he of whom I spake, He that cometh after me is preferred before me: for he was before me.", "And of his fulness have all we received, and grace for grace.", "For the law was given by Moses, but grace and truth came by Jesus Christ.", "No man hath seen God at any time; the only begotten Son, which is in the bosom of the Father, he hath declared him.", "And this is the record of John, when the Jews sent priests and Levites from Jerusalem to ask him, Who art thou?", "And he confessed, and denied not; but confessed, I am not the Christ.", "And they asked him, What then? Art thou Elias? And he saith, I am not. Art thou that prophet? And he answered, No.", "Then said they unto him, Who art thou? that we may give an answer to them that sent us. What sayest thou of thyself?", "He said, I am the voice of one crying in the wilderness, Make straight the way of the Lord, as said the prophet Esaias.", "And they which were sent were of the Pharisees.", "And they asked him, and said unto him, Why baptizest thou then, if thou be not that Christ, nor Elias, neither that prophet?", "John answered them, saying, I baptize with water: but there standeth one among you, whom ye know not;", "He it is, who coming after me is preferred before me, whose shoe's latchet I am not worthy to unloose.", "These things were done in Bethabara beyond Jordan, where John was baptizing.", "The next day John seeth Jesus coming unto him, and saith, Behold the Lamb of God, which taketh away the sin of the world.", "This is he of whom I said, After me cometh a man which is preferred before me: for he was before me.", "And I knew him not: but that he should be made manifest to Israel, therefore am I come baptizing with water.", "And John bare record, saying, I saw the Spirit descending from heaven like a dove, and it abode upon him.", "And I knew him not: but he that sent me to baptize with water, the same said unto me, Upon whom thou shalt see the Spirit descending, and remaining on him, the same is he which baptizeth with the Holy Ghost.", "And I saw, and bare record that this is the Son of God.", "Again the next day after John stood, and two of his disciples;", "And looking upon Jesus as he walked, he saith, Behold the Lamb of God!", "And the two disciples heard him speak, and they followed Jesus.", "Then Jesus turned, and saw them following, and saith unto them, What seek ye? They said unto him, Rabbi, (which is to say, being interpreted, Master,) where dwellest thou?", "He saith unto them, Come and see. They came and saw where he dwelt, and abode with him that day: for it was about the tenth hour.", "One of the two which heard John speak, and followed him, was Andrew, Simon Peter's brother.", "He first findeth his own brother Simon, and saith unto him, We have found the Messias, which is, being interpreted, the Christ.", "And he brought him to Jesus. And when Jesus beheld him, he said, Thou art Simon the son of Jona: thou shalt be called Cephas, which is by interpretation, A stone.", "The day following Jesus would go forth into Galilee, and findeth Philip, and saith unto him, Follow me.", "Now Philip was of Bethsaida, the city of Andrew and Peter.", "Philip findeth Nathanael, and saith unto him, We have found him, of whom Moses in the law, and the prophets, did write, Jesus of Nazareth, the son of Joseph.", "And Nathanael said unto him, Can there any good thing come out of Nazareth? Philip saith unto him, Come and see.", "Jesus saw Nathanael coming to him, and saith of him, Behold an Israelite indeed, in whom is no guile!", "Nathanael saith unto him, Whence knowest thou me? Jesus answered and said unto him, Before that Philip called thee, when thou wast under the fig tree, I saw thee.", "Nathanael answered and saith unto him, Rabbi, thou art the Son of God; thou art the King of Israel.", "Jesus answered and said unto him, Because I said unto thee, I saw thee under the fig tree, believest thou? thou shalt see greater things than these.", "And he saith unto him, Verily, verily, I say unto you, Hereafter ye shall see heaven open, and the angels of God ascending and descending upon the Son of man."],
        ["And the third day there was a marriage in Cana of Galilee; and the mother of Jesus was there:", "And both Jesus was called, and his disciples, to the marriage.", "And when they wanted wine, the mother of Jesus saith unto him, They have no wine.", "Jesus saith unto her, Woman, what have I to do with thee? mine hour is not yet come.", "His mother saith unto the servants, Whatsoever he saith unto you, do it.", "And there were set there six waterpots of stone, after the manner of the purifying of the Jews, containing two or three firkins apiece.", "Jesus saith unto them, Fill the waterpots with water. And they filled them up to the brim.", "And he saith unto them, Draw out now, and bear unto the governor of the feast. And they bare it.", " When the ruler of the feast had tasted the water that was made wine, and knew not whence it was: (but the servants which drew the water knew;) the governor of the feast called the bridegroom,", "And saith unto him, Every man at the beginning doth set forth good wine; and when men have well drunk, then that which is worse: but thou hast kept the good wine until now.", "This beginning of miracles did Jesus in Cana of Galilee, and manifested forth his glory; and his disciples believed on him.", "After this he went down to Capernaum, he, and his mother, and his brethren, and his disciples: and they continued there not many days.", "And the Jews' passover was at hand, and Jesus went up to Jerusalem,", "And found in the temple those that sold oxen and sheep and doves, and the changers of money sitting:", "And when he had made a scourge of small cords, he drove them all out of the temple, and the sheep, and the oxen; and poured out the changers' money, and overthrew the tables;", "And said unto them that sold doves, Take these things hence; make not my Father's house an house of merchandise.", "And his disciples remembered that it was written, The zeal of thine house hath eaten me up.", "Then answered the Jews and said unto him, What sign shewest thou unto us, seeing that thou doest these things?", "Jesus answered and said unto them, Destroy this temple, and in three days I will raise it up.", "Then said the Jews, Forty and six years was this temple in building, and wilt thou rear it up in three days?", "But he spake of the temple of his body.", "When therefore he was risen from the dead, his disciples remembered that he had said this unto them; and they believed the scripture, and the word which Jesus had said.", "Now when he was in Jerusalem at the passover, in the feast day, many believed in his name, when they saw the miracles which he did.", "But Jesus did not commit himself unto them, because he knew all men,", "And needed not that any should testify of man: for he knew what was in man."],
        ["There was a man of the Pharisees, named Nicodemus, a ruler of the Jews:", "The same came to Jesus by night, and said unto him, Rabbi, we know that thou art a teacher come from God: for no man can do these miracles that thou doest, except God be with him.", "Jesus answered and said unto him, Verily, verily, I say unto thee, Except a man be born again, he cannot see the kingdom of God.", "Nicodemus saith unto him, How can a man be born when he is old? can he enter the second time into his mother's womb, and be born?", "Jesus answered, Verily, verily, I say unto thee, Except a man be born of water and of the Spirit, he cannot enter into the kingdom of God.", "That which is born of the flesh is flesh; and that which is born of the Spirit is spirit.", "Marvel not that I said unto thee, Ye must be born again.", "The wind bloweth where it listeth, and thou hearest the sound thereof, but canst not tell whence it cometh, and whither it goeth: so is every one that is born of the Spirit.", "Nicodemus answered and said unto him, How can these things be?", "Jesus answered and said unto him, Art thou a master of Israel, and knowest not these things?", "Verily, verily, I say unto thee, We speak that we do know, and testify that we have seen; and ye receive not our witness.", "If I have told you earthly things, and ye believe not, how shall ye believe, if I tell you of heavenly things?", "And no man hath ascended up to heaven, but he that came down from heaven, even the Son of man which is in heaven.", "And as Moses lifted up the serpent in the wilderness, even so must the Son of man be lifted up:", "That whosoever believeth in him should not perish, but have eternal life.", "For God so loved the world, that he gave his only begotten Son, that whosoever believeth in him should not perish, but have everlasting life.", "For God sent not his Son into the world to condemn the world; but that the world through him might be saved.", "He that believeth on him is not condemned: but he that believeth not is condemned already, because he hath not believed in the name of the only begotten Son of God.", "And this is the condemnation, that light is come into the world, and men loved darkness rather than light, because their deeds were evil.", "For every one that doeth evil hateth the light, neither cometh to the light, lest his deeds should be reproved.", "But he that doeth truth cometh to the light, that his deeds may be made manifest, that they are wrought in God.", "After these things came Jesus and his disciples into the land of Judaea; and there he tarried with them, and baptized.", "And John also was baptizing in Aenon near to Salim, because there was much water there: and they came, and were baptized.", "For John was not yet cast into prison.", "Then there arose a question between some of John's disciples and the Jews about purifying.", "And they came unto John, and said unto him, Rabbi, he that was with thee beyond Jordan, to whom thou barest witness, behold, the same baptizeth, and all men come to him.", "John answered and said, A man can receive nothing, except it be given him from heaven.", "Ye yourselves bear me witness, that I said, I am not the Christ, but that I am sent before him.", "He that hath the bride is the bridegroom: but the friend of the bridegroom, which standeth and heareth him, rejoiceth greatly because of the bridegroom's voice: this my joy therefore is fulfilled.", "He must increase, but I must decrease.", "He that cometh from above is above all: he that is of the earth is earthly, and speaketh of the earth: he that cometh from heaven is above all.", "And what he hath seen and heard, that he testifieth; and no man receiveth his testimony.", "He that hath received his testimony hath set to his seal that God is true.", "For he whom God hath sent speaketh the words of God: for God giveth not the Spirit by measure unto him.", "The Father loveth the Son, and hath given all things into his hand.", "He that believeth on the Son hath everlasting life: and he that believeth not the Son shall not see life; but the wrath of God abideth on him."],
        ["When therefore the Lord knew how the Pharisees had heard that Jesus made and baptized more disciples than John,", "(Though Jesus himself baptized not, but his disciples,)", "He left Judaea, and departed again into Galilee.", "And he must needs go through Samaria.", "Then cometh he to a city of Samaria, which is called Sychar, near to the parcel of ground that Jacob gave to his son Joseph.", "Now Jacob's well was there. Jesus therefore, being wearied with his journey, sat thus on the well: and it was about the sixth hour.", "There cometh a woman of Samaria to draw water: Jesus saith unto her, Give me to drink.", "(For his disciples were gone away unto the city to buy meat.)", "Then saith the woman of Samaria unto him, How is it that thou, being a Jew, askest drink of me, which am a woman of Samaria? for the Jews have no dealings with the Samaritans.", "Jesus answered and said unto her, If thou knewest the gift of God, and who it is that saith to thee, Give me to drink; thou wouldest have asked of him, and he would have given thee living water.", "The woman saith unto him, Sir, thou hast nothing to draw with, and the well is deep: from whence then hast thou that living water?", " Art thou greater than our father Jacob, which gave us the well, and drank thereof himself, and his children, and his cattle?", "Jesus answered and said unto her, Whosoever drinketh of this water shall thirst again:", "But whosoever drinketh of the water that I shall give him shall never thirst; but the water that I shall give him shall be in him a well of water springing up into everlasting life.", "The woman saith unto him, Sir, give me this water, that I thirst not, neither come hither to draw.", "Jesus saith unto her, Go, call thy husband, and come hither.", "The woman answered and said, I have no husband. Jesus said unto her, Thou hast well said, I have no husband:", "For thou hast had five husbands; and he whom thou now hast is not thy husband: in that saidst thou truly.", "The woman saith unto him, Sir, I perceive that thou art a prophet.", "Our fathers worshipped in this mountain; and ye say, that in Jerusalem is the place where men ought to worship.", "Jesus saith unto her, Woman, believe me, the hour cometh, when ye shall neither in this mountain, nor yet at Jerusalem, worship the Father.", "Ye worship ye know not what: we know what we worship: for salvation is of the Jews.", "But the hour cometh, and now is, when the true worshippers shall worship the Father in spirit and in truth: for the Father seeketh such to worship him.", "God is a Spirit: and they that worship him must worship him in spirit and in truth.", "The woman saith unto him, I know that Messias cometh, which is called Christ: when he is come, he will tell us all things.", "Jesus saith unto her, I that speak unto thee am he.", "And upon this came his disciples, and marvelled that he talked with the woman: yet no man said, What seekest thou? or, Why talkest thou with her?", "The woman then left her waterpot, and went her way into the city, and saith to the men,", "Come, see a man, which told me all things that ever I did: is not this the Christ?", "Then they went out of the city, and came unto him.", " In the mean while his disciples prayed him, saying, Master, eat.", "But he said unto them, I have meat to eat that ye know not of.", "Therefore said the disciples one to another, Hath any man brought him ought to eat?", "Jesus saith unto them, My meat is to do the will of him that sent me, and to finish his work.", "Say not ye, There are yet four months, and then cometh harvest? behold, I say unto you, Lift up your eyes, and look on the fields; for they are white already to harvest.", "And he that reapeth receiveth wages, and gathereth fruit unto life eternal: that both he that soweth and he that reapeth may rejoice together.", "And herein is that saying true, One soweth, and another reapeth.", "I sent you to reap that whereon ye bestowed no labour: other men laboured, and ye are entered into their labours.", "And many of the Samaritans of that city believed on him for the saying of the woman, which testified, He told me all that ever I did.", "So when the Samaritans were come unto him, they besought him that he would tarry with them: and he abode there two days.", "And many more believed because of his own word;", "And said unto the woman, Now we believe, not because of thy saying: for we have heard him ourselves, and know that this is indeed the Christ, the Saviour of the world.", "Now after two days he departed thence, and went into Galilee.", "For Jesus himself testified, that a prophet hath no honour in his own country.", "Then when he was come into Galilee, the Galilaeans received him, having seen all the things that he did at Jerusalem at the feast: for they also went unto the feast.", "So Jesus came again into Cana of Galilee, where he made the water wine. And there was a certain nobleman, whose son was sick at Capernaum.", "When he heard that Jesus was come out of Judaea into Galilee, he went unto him, and besought him that he would come down, and heal his son: for he was at the point of death.", "Then said Jesus unto him, Except ye see signs and wonders, ye will not believe.", "The nobleman saith unto him, Sir, come down ere my child die.", "Jesus saith unto him, Go thy way; thy son liveth. And the man believed the word that Jesus had spoken unto him, and he went his way.", "And as he was now going down, his servants met him, and told him, saying, Thy son liveth.", "Then enquired he of them the hour when he began to amend. And they said unto him, Yesterday at the seventh hour the fever left him.", "So the father knew that it was at the same hour, in the which Jesus said unto him, Thy son liveth: and himself believed, and his whole house.", "This is again the second miracle that Jesus did, when he was come out of Judaea into Galilee."],
        ["After this there was a feast of the Jews; and Jesus went up to Jerusalem.", "Now there is at Jerusalem by the sheep market a pool, which is called in the Hebrew tongue Bethesda, having five porches.", "In these lay a great multitude of impotent folk, of blind, halt, withered, waiting for the moving of the water.", "For an angel went down at a certain season into the pool, and troubled the water: whosoever then first after the troubling of the water stepped in was made whole of whatsoever disease he had.", "And a certain man was there, which had an infirmity thirty and eight years.", "When Jesus saw him lie, and knew that he had been now a long time in that case, he saith unto him, Wilt thou be made whole?", "The impotent man answered him, Sir, I have no man, when the water is troubled, to put me into the pool: but while I am coming, another steppeth down before me.", "Jesus saith unto him, Rise, take up thy bed, and walk.", "And immediately the man was made whole, and took up his bed, and walked: and on the same day was the sabbath.", "The Jews therefore said unto him that was cured, It is the sabbath day: it is not lawful for thee to carry thy bed.", "He answered them, He that made me whole, the same said unto me, Take up thy bed, and walk.", "Then asked they him, What man is that which said unto thee, Take up thy bed, and walk?", "And he that was healed wist not who it was: for Jesus had conveyed himself away, a multitude being in that place.", "Afterward Jesus findeth him in the temple, and said unto him, Behold, thou art made whole: sin no more, lest a worse thing come unto thee.", "The man departed, and told the Jews that it was Jesus, which had made him whole.", "And therefore did the Jews persecute Jesus, and sought to slay him, because he had done these things on the sabbath day.", "But Jesus answered them, My Father worketh hitherto, and I work.", "Therefore the Jews sought the more to kill him, because he not only had broken the sabbath, but said also that God was his Father, making himself equal with God.", "Then answered Jesus and said unto them, Verily, verily, I say unto you, The Son can do nothing of himself, but what he seeth the Father do: for what things soever he doeth, these also doeth the Son likewise.", "For the Father loveth the Son, and sheweth him all things that himself doeth: and he will shew him greater works than these, that ye may marvel.", "For as the Father raiseth up the dead, and quickeneth them; even so the Son quickeneth whom he will.", "For the Father judgeth no man, but hath committed all judgment unto the Son:", "That all men should honour the Son, even as they honour the Father. He that honoureth not the Son honoureth not the Father which hath sent him.", "Verily, verily, I say unto you, He that heareth my word, and believeth on him that sent me, hath everlasting life, and shall not come into condemnation; but is passed from death unto life.", "Verily, verily, I say unto you, The hour is coming, and now is, when the dead shall hear the voice of the Son of God: and they that hear shall live.", "For as the Father hath life in himself; so hath he given to the Son to have life in himself;", "And hath given him authority to execute judgment also, because he is the Son of man.", "Marvel not at this: for the hour is coming, in the which all that are in the graves shall hear his voice,", "And shall come forth; they that have done good, unto the resurrection of life; and they that have done evil, unto the resurrection of damnation.", "I can of mine own self do nothing: as I hear, I judge: and my judgment is just; because I seek not mine own will, but the will of the Father which hath sent me.", "If I bear witness of myself, my witness is not true.", "There is another that beareth witness of me; and I know that the witness which he witnesseth of me is true.", "Ye sent unto John, and he bare witness unto the truth.", "But I receive not testimony from man: but these things I say, that ye might be saved.", "He was a burning and a shining light: and ye were willing for a season to rejoice in his light.", "But I have greater witness than that of John: for the works which the Father hath given me to finish, the same works that I do, bear witness of me, that the Father hath sent me.", "And the Father himself, which hath sent me, hath borne witness of me. Ye have neither heard his voice at any time, nor seen his shape.", "And ye have not his word abiding in you: for whom he hath sent, him ye believe not.", "Search the scriptures; for in them ye think ye have eternal life: and they are they which testify of me.", "And ye will not come to me, that ye might have life.", "I receive not honour from men.", "But I know you, that ye have not the love of God in you.", "I am come in my Father's name, and ye receive me not: if another shall come in his own name, him ye will receive.", "How can ye believe, which receive honour one of another, and seek not the honour that cometh from God only?", "Do not think that I will accuse you to the Father: there is one that accuseth you, even Moses, in whom ye trust.", "For had ye believed Moses, ye would have believed me: for he wrote of me.", "But if ye believe not his writings, how shall ye believe my words?"],
        ["After these things Jesus went over the sea of Galilee, which is the sea of Tiberias.", "And a great multitude followed him, because they saw his miracles which he did on them that were diseased.", "And Jesus went up into a mountain, and there he sat with his disciples.", "And the passover, a feast of the Jews, was nigh.", "When Jesus then lifted up his eyes, and saw a great company come unto him, he saith unto Philip, Whence shall we buy bread, that these may eat?", "And this he said to prove him: for he himself knew what he would do.", "Philip answered him, Two hundred pennyworth of bread is not sufficient for them, that every one of them may take a little.", "One of his disciples, Andrew, Simon Peter's brother, saith unto him,", "There is a lad here, which hath five barley loaves, and two small fishes: but what are they among so many?", "And Jesus said, Make the men sit down. Now there was much grass in the place. So the men sat down, in number about five thousand.", "And Jesus took the loaves; and when he had given thanks, he distributed to the disciples, and the disciples to them that were set down; and likewise of the fishes as much as they would.", "When they were filled, he said unto his disciples, Gather up the fragments that remain, that nothing be lost.", "Therefore they gathered them together, and filled twelve baskets with the fragments of the five barley loaves, which remained over and above unto them that had eaten.", "Then those men, when they had seen the miracle that Jesus did, said, This is of a truth that prophet that should come into the world.", "When Jesus therefore perceived that they would come and take him by force, to make him a king, he departed again into a mountain himself alone.", "And when even was now come, his disciples went down unto the sea,", "And entered into a ship, and went over the sea toward Capernaum. And it was now dark, and Jesus was not come to them.", "And the sea arose by reason of a great wind that blew.", "So when they had rowed about five and twenty or thirty furlongs, they see Jesus walking on the sea, and drawing nigh unto the ship: and they were afraid.", "But he saith unto them, It is I; be not afraid.", "Then they willingly received him into the ship: and immediately the ship was at the land whither they went.", "The day following, when the people which stood on the other side of the sea saw that there was none other boat there, save that one whereinto his disciples were entered, and that Jesus went not with his disciples into the boat, but that his disciples were gone away alone;", "(Howbeit there came other boats from Tiberias nigh unto the place where they did eat bread, after that the Lord had given thanks:)", "When the people therefore saw that Jesus was not there, neither his disciples, they also took shipping, and came to Capernaum, seeking for Jesus.", "And when they had found him on the other side of the sea, they said unto him, Rabbi, when camest thou hither?", "Jesus answered them and said, Verily, verily, I say unto you, Ye seek me, not because ye saw the miracles, but because ye did eat of the loaves, and were filled.", "Labour not for the meat which perisheth, but for that meat which endureth unto everlasting life, which the Son of man shall give unto you: for him hath God the Father sealed.", "Then said they unto him, What shall we do, that we might work the works of God?", "Jesus answered and said unto them, This is the work of God, that ye believe on him whom he hath sent.", "They said therefore unto him, What sign shewest thou then, that we may see, and believe thee? what dost thou work?", "Our fathers did eat manna in the desert; as it is written, He gave them bread from heaven to eat.", "Then Jesus said unto them, Verily, verily, I say unto you, Moses gave you not that bread from heaven; but my Father giveth you the true bread from heaven.", "For the bread of God is he which cometh down from heaven, and giveth life unto the world.", "Then said they unto him, Lord, evermore give us this bread.", "And Jesus said unto them, I am the bread of life: he that cometh to me shall never hunger; and he that believeth on me shall never thirst.", "But I said unto you, That ye also have seen me, and believe not.", "All that the Father giveth me shall come to me; and him that cometh to me I will in no wise cast out.", "For I came down from heaven, not to do mine own will, but the will of him that sent me.", "And this is the Father's will which hath sent me, that of all which he hath given me I should lose nothing, but should raise it up again at the last day.", "And this is the will of him that sent me, that every one which seeth the Son, and believeth on him, may have everlasting life: and I will raise him up at the last day.", "The Jews then murmured at him, because he said, I am the bread which came down from heaven.", "And they said, Is not this Jesus, the son of Joseph, whose father and mother we know? how is it then that he saith, I came down from heaven?", "Jesus therefore answered and said unto them, Murmur not among yourselves.", "No man can come to me, except the Father which hath sent me draw him: and I will raise him up at the last day.", "It is written in the prophets, And they shall be all taught of God. Every man therefore that hath heard, and hath learned of the Father, cometh unto me.", "Not that any man hath seen the Father, save he which is of God, he hath seen the Father.", "Verily, verily, I say unto you, He that believeth on me hath everlasting life.", "I am that bread of life.", "Your fathers did eat manna in the wilderness, and are dead.", "This is the bread which cometh down from heaven, that a man may eat thereof, and not die.", "I am the living bread which came down from heaven: if any man eat of this bread, he shall live for ever: and the bread that I will give is my flesh, which I will give for the life of the world.", "The Jews therefore strove among themselves, saying, How can this man give us his flesh to eat?", "Then Jesus said unto them, Verily, verily, I say unto you, Except ye eat the flesh of the Son of man, and drink his blood, ye have no life in you.", "Whoso eateth my flesh, and drinketh my blood, hath eternal life; and I will raise him up at the last day.", "For my flesh is meat indeed, and my blood is drink indeed.", "He that eateth my flesh, and drinketh my blood, dwelleth in me, and I in him.", "As the living Father hath sent me, and I live by the Father: so he that eateth me, even he shall live by me.", "This is that bread which came down from heaven: not as your fathers did eat manna, and are dead: he that eateth of this bread shall live for ever.", "These things said he in the synagogue, as he taught in Capernaum.", "Many therefore of his disciples, when they had heard this, said, This is an hard saying; who can hear it?", "When Jesus knew in himself that his disciples murmured at it, he said unto them, Doth this offend you?", "What and if ye shall see the Son of man ascend up where he was before?", "It is the spirit that quickeneth; the flesh profiteth nothing: the words that I speak unto you, they are spirit, and they are life.", "But there are some of you that believe not. For Jesus knew from the beginning who they were that believed not, and who should betray him.", "And he said, Therefore said I unto you, that no man can come unto me, except it were given unto him of my Father.", "From that time many of his disciples went back, and walked no more with him.", "Then said Jesus unto the twelve, Will ye also go away?", "Then Simon Peter answered him, Lord, to whom shall we go? thou hast the words of eternal life.", "And we believe and are sure that thou art that Christ, the Son of the living God.", "Jesus answered them, Have not I chosen you twelve, and one of you is a devil?", " He spake of Judas Iscariot the son of Simon: for he it was that should betray him, being one of the twelve."]
    ];
    var chapter = Number(params.chapter) || randInt(1,6);
    var curVerse = randVerse();
    var correctAnswer = curVerse[0];
    var missiles = [];
    curVerse = curVerse[1];
    // textDiv.innerHTML = curVerse;
    var difficulty = 0.75;
    function randInt(min, max, not) {
        if(max === undefined) {
            max = min
            min = 1
        }
        var num = Math.floor(Math.random() * (max - min + 1)) + min;
        while(num === not && max-min > 0) {
            num = Math.floor(Math.random() * (max - min + 1)) + min;
        }
        return num;
    }
    function randVerse() {
        var verseArr = john16[chapter-1];
        var rand = randInt((params.min ? Number(params.min)-1 : 0), Number(params.max)-1 || verseArr.length-1, (correctAnswer ? Number(correctAnswer.split(".")[1])-1 : -1));
        var verseNumber = chapter + "." + (rand+1);
        return [verseNumber, verseArr[rand]];
    }


    // energyHolder.beginFill();
    var state;
    var keys = {};
    var rocket;
    var enemies = [];
    var explosions = [];
    var mouseX,mouseY;
    var lasers = [];
    var lastFire = 0;
    var reloadTime = 500;
    var energyToFire = 5;
    var healthToHit = 10;
    var emp;
    var enemyEMP;
    var laserGraphics = new PIXI.Graphics();
    laserGraphics.beginFill(0xffffaa);
    laserGraphics.drawRect(-25,0,50, -innerHeight * 2);
    app.stage.addChild(laserGraphics);
    app.stage.sortableChildren = true;
    function setup() {
        spawnNewEnemy(1,"easy");
        rocket = new Sprite(resources["sprites/rocket.png"].texture);
        app.stage.addChild(rocket);
        rocket.anchor.set(0.5,0.5);
        rocket.scale.set(3);
        rocket.x = 100;
        rocket.y = 100;

        emp = new Sprite(resources["sprites/emp.png"].texture);
        app.stage.addChild(emp);
        emp.anchor.set(0.5,0.5);
        emp.x = 100;
        emp.y = 100;
        emp.visible = false;

        enemyEMP = new Sprite(resources["sprites/enemyEMP.png"].texture);
        app.stage.addChild(enemyEMP);
        enemyEMP.anchor.set(0.5,0.5);
        enemyEMP.x = 100;
        enemyEMP.y = 100;
        enemyEMP.visible = false;
        enemyEMP.zIndex = 10000;
    }
    function gameLoop(delta) {
      state(delta)
    }
    var level = 1;
    function explode(amount, position, magnitude) {
        for(var i = 0; i < amount; i++) {
            if(magnitude) {
                var rand = magnitude/3-0.1;
            } else {
                var rand = Math.random();
            }
            if(rand < 0.33) {
                var explosion = new Sprite(resources["sprites/exp1.png"].texture);
            } else if(rand < 0.66) {
                var explosion = new Sprite(resources["sprites/exp2.png"].texture);
            } else {
                var explosion = new Sprite(resources["sprites/exp3.png"].texture);
            }
            app.stage.addChild(explosion);
            explosion.x = position.x + randInt(-20,20);
            explosion.y = position.y + randInt(-20,20);
            explosions.push(explosion);
            explosion.scale.set(3);
        }
    }
    function bigExplosion(amount, position, magnitude) {
        for(var i = 0; i < amount; i++) {
            if(magnitude) {
                var rand = magnitude/3-0.1;
            } else {
                var rand = Math.random();
            }
            if(rand < 0.33) {
                var explosion = new Sprite(resources["sprites/exp1.png"].texture);
            } else if(rand < 0.66) {
                var explosion = new Sprite(resources["sprites/exp2.png"].texture);
            } else {
                var explosion = new Sprite(resources["sprites/exp3.png"].texture);
            }
            app.stage.addChild(explosion);
            explosion.x = position.x + randInt(-150,150);
            explosion.y = position.y + randInt(-150,150);
            explosions.push(explosion);
            explosion.scale.set(3);
        }
    }
    function die() {
        explode(1,{x:rocket.x,y:rocket.y});
        for(var i = 0; i < explosions.length; i++) {
            explosions[i].alpha -= 0.05;
            if(explosions[i].alpha <= 0) {
                app.stage.removeChild(explosions[i]);
                explosions.splice(i,1);
                --i;
            }
        }
        for(var i = 0; i < enemies.length; i++) {
            enemies[i].alpha -= 0.05;
            if(enemies[i].alpha <= 0) {
                app.stage.removeChild(enemies[i]);
                enemies.splice(i,1);
                --i;
            }
        }

        for(var i = 0; i < lasers.length; i++) {
            lasers[i].alpha -= 0.05;
            if(lasers[i].alpha <= 0) {
                app.stage.removeChild(lasers[i]);
                lasers.splice(i,1);
                --i;
            }
        }


        for(var i = 0; i < missiles.length; i++) {
            missiles[i].alpha -= 0.05;
            if(missiles[i].alpha <= 0) {
                app.stage.removeChild(missiles[i]);
                missiles.splice(i,1);
                --i;
            }
        }
    }
    function play(){
        if(healthBar.width < 0) {
            state = die;
        }
        rocket.vx = 0;
        rocket.vy = 0;
        if(keys.ArrowUp || keys.w) {
            rocket.vy += -10;
        }
        if(keys.ArrowDown || keys.s) {
            rocket.vy += 10;
        }
        if(keys.ArrowLeft || keys.a) {
            rocket.vx += -10;
        }
        if(keys.ArrowRight || keys.d) {
            rocket.vx += 10;
        }
        if(keys[" "] && Date.now() - reloadTime > lastFire && energyBar.width >= energyToFire) {
            shootLaser("good", {x:rocket.x, y: rocket.y - rocket.height/2}, 0);
            lastFire = Date.now();
            energyBar.width -= energyToFire;
        }
        if(keys.m && energyBar.width >= energyToFire*7 && enemies.length) {
            var closestEnemy;
            var closestDist = Infinity;
            for(let i = 0; i < enemies.length; i++) {
                var enemy = enemies[i];
                if(getDistance(rocket.x,rocket.y,enemy.x,enemy.y) < closestDist) {
                    closestDist = getDistance(rocket.x,rocket.y,enemy.x,enemy.y)
                    closestEnemy = enemy;
                }
            }
            launchMissile("good",  {x:rocket.x, y: rocket.y - rocket.height/2}, closestEnemy, 10);
            keys.m = false;
            energyBar.width -= energyToFire*7;
        }
        if(keys.e && energyBar.width > 0) {
            if(!emp.visible) {
                emp.scale.set(0.5);
            }
            emp.scale.x += 0.1;
            emp.scale.y += 0.1;
            emp.visible = true;
            emp.rotation += 0.1;
            emp.x = rocket.x;
            emp.y = rocket.y;
            energyBar.width -= energyToFire/5;
            for(var i = 0; i < enemies.length; i++) {
                var enemy = enemies[i];
                if(getDistance(enemy.x,enemy.y,emp.x,emp.y) < emp.width/2) {
                    explode(1,{x:enemy.x,y:enemy.y});
                    enemy.health -= 0.1;
                }
            }
        } else {
            emp.visible = false;
        }
        if(keys.l && energyBar.width > 0) {
            laserGraphics.visible = true;
            for(var i = 0; i < enemies.length; i++) {
                var enemy = enemies[i];
                var enemyRect = {x: enemy.x - enemy.width/2, y: enemy.y - enemy.height/2, width: enemy.width, height: enemy.height};
                var laserRect = {x:laserGraphics.x-25,y:laserGraphics.y-innerHeight*2,width:50,height:innerHeight*2};
                if(hitTestRectangle(laserRect,enemyRect)) {
                    explode(1,{x:enemy.x,y:enemy.y});
                    enemy.health -= 0.1;
                }
            }
            energyBar.width -= energyToFire/4;
        } else {
            laserGraphics.visible = false;
        }
        if(energyBar.width > Math.abs(rocket.vx/100) + Math.abs(rocket.vy/100)) {
            rocket.x += rocket.vx;
            rocket.y += rocket.vy;
            energyBar.width -= Math.abs(rocket.vx/100) + Math.abs(rocket.vy/100);
            laserGraphics.x = rocket.x;
            laserGraphics.y = rocket.y;
        }

        for(var i = 0; i < missiles.length; i++) {
            var missile = missiles[i];
            --missile.health;
            if(missile.target.health <= 0 || missile.health <= 0) {
                explode(1,{x:missile.x,y:missile.y});
                app.stage.removeChild(missile);
                missiles.splice(i,1);
                --i;
            }
            missile.rotation = pointTowards(missile.x,missile.y,missile.target.x,missile.target.y) * Math.PI/180;
            missile.rotation *= -1;
            var missileDirection = radDirection(missile.speed, -missile.rotation + Math.PI);
            missile.x += missileDirection.r;
            missile.y += missileDirection.u;
            if(missile.y < -10 || missile.y > innerHeight + 10 || missile.x < 10 || missile.x > innerWidth + 10) {
                app.stage.removeChild(missile);
                missiles.splice(i,1);
                --i;
                continue;
            }
            var missileRect = {x: missile.x-missile.width/2, y: missile.y-missile.height/2,width:missile.width,height:missile.height};
            var rocketRect = {x: rocket.x - rocket.width/2, y: rocket.y - rocket.height/2, width: rocket.width, height: rocket.height};
            if(hitTestRectangle(missileRect, rocketRect) && !missile.good) {
                if(!invincible) {
                    healthBar.width -= healthToHit*3;
                }
                explode(20,{x:missile.x - missile.width, y:missile.y + missile.height});
                app.stage.removeChild(missile);
                missiles.splice(i,1);
                --i;
                continue;
            }
            for(var j = 0; j < enemies.length; j++) { 
                var enemy = enemies[j];
                var enemyRect = {x: enemy.x - enemy.width/2, y: enemy.y - enemy.height/2, width: enemy.width, height: enemy.height};
                if(hitTestRectangle(missileRect, enemyRect) && missile.good) {
                    enemy.health -= 3;
                    explode(10,{x:missile.x - missile.width, y:missile.y - missile.height});
                    if(enemy.health <= 0) {
                        bigExplosion(100,{x:enemy.x,y:enemy.y});
                    }
                    enemies.forEach(function(enemy){
                        if(getDistance(enemy.x,enemy.y,missile.x,missile.y) < 200) {
                            explode(10,{x:enemy.x, y:enemy.y});
                            enemy.health -= 2;
                        }
                    });
                    app.stage.removeChild(missile);
                    missiles.splice(i,1);
                    --i;
                    j = enemies.length;
                    continue;
                }   
            }
        }

        for(var i = 0; i < lasers.length; i++) {
            var laser = lasers[i];
            var laserDirection = radDirection(20,-laser.rotation + Math.PI);
            laser.x += laserDirection.r;
            laser.y += laserDirection.u;
            if(laser.y < -10 || laser.y > innerHeight + 10 || laser.x < 10 || laser.x > innerWidth + 10) {
                app.stage.removeChild(laser);
                lasers.splice(i,1);
                --i;
                continue;
            }
            var laserRect = {x: laser.x-laser.width/2, y: laser.y-laser.height/2,width:laser.width,height:laser.height};
            var rocketRect = {x: rocket.x - rocket.width/2, y: rocket.y - rocket.height/2, width: rocket.width, height: rocket.height};
            if(hitTestRectangle(laserRect, rocketRect) && !laser.good) {
                if(!invincible) {
                    healthBar.width -= healthToHit;
                }
                explode(1,{x:laser.x - laser.width, y:laser.y + laser.height});
                app.stage.removeChild(laser);
                lasers.splice(i,1);
                --i;
                continue;
            }
            for(var j = 0; j < enemies.length; j++) { 
                var enemy = enemies[j];
                var enemyRect = {x: enemy.x - enemy.width/2, y: enemy.y - enemy.height/2, width: enemy.width, height: enemy.height};
                if(hitTestRectangle(laserRect, enemyRect) && laser.good) {
                    enemy.health--;
                    explode(1,{x:laser.x - laser.width/2, y:laser.y - laser.height/2});
                    if(enemy.health <= 0) {
                        explode(20,{x:enemy.x,y:enemy.y});
                    }
                    app.stage.removeChild(laser);
                    lasers.splice(i,1);
                    --i;
                    j = enemies.length;
                    continue;
                }   
            }
        }
        for(var i = 0; i < formations.length; i++) {
            var formation = formations[i];
            var inSight = false;
            var closestEnemy;
            var closestDist = Infinity;
            formation.forEach(function(enemy){
                if(enemy.health >= 0) {
                    if(enemy.x + enemy.width/2 < rocket.x) {
                    } else if(enemy.x - enemy.width/2 > rocket.x) {
                    } else {
                        inSight = true;
                    }
                    if(getDistance(rocket.x,rocket.y, enemy.x, enemy.y) < closestDist) {
                        closestDist = getDistance(rocket.x,rocket.y, enemy.x, enemy.y);
                        closestEnemy = enemy;
                    }
                }
            });
            var movement = {x:0, y:0}
            if(!inSight) {
                if(closestEnemy) {
                    if(closestEnemy.x < rocket.x) {
                        movement.x = 3;
                    } else {
                        movement.x = -3;
                    }
                } else {
                    formations.splice(i,1);
                    --i;
                }
            }
            formation.forEach(function(child){
                child.formationMovement = movement;
            })
        }
        for(var i = 0; i < enemies.length; i++) {
            var enemy = enemies[i];
            if(enemy.health > 0) {
                if(enemy.level === "easy") {
                    if(enemy.y < innerHeight + 200) {
                        enemy.y += 1.5 * difficulty;
                    } else {
                        enemy.y = -400;
                    }
                    if(enemy.x + 5 < rocket.x) {
                        enemy.x += 1.5 * difficulty;
                    } else if(enemy.x - 5 > rocket.x) {
                        enemy.x -= 1.5 * difficulty;
                    } else if(Date.now() - enemy.reloadTime > enemy.lastFire) {
                        shootLaser("bad", {x:enemy.x, y: enemy.y}, pointTowards(enemy.x,enemy.y,rocket.x,rocket.y) * Math.PI/180)
                        enemy.lastFire = Date.now();
                    }
                } else if(enemy.level === "boss1") {
                    if(enemy.y < innerHeight + 200) {
                        enemy.y += 1.5 * difficulty;
                    } else {
                        enemy.y = -400;
                    }
                    if(enemy.x + 15 < rocket.x) {
                        enemy.x += 10;
                    } else if(enemy.x - 15 > rocket.x) {
                        enemy.x -= 10;
                    } else if(Date.now() - enemy.reloadTime > enemy.lastFire) {
                        shootLaser("bad", {x:enemy.x, y: enemy.y}, pointTowards(enemy.x,enemy.y,rocket.x,rocket.y) * Math.PI/180)
                        launchMissile("bad", {x:enemy.x + enemy.width/3, y: enemy.y}, rocket, 7.5)
                        launchMissile("bad", {x:enemy.x - enemy.width/3, y: enemy.y}, rocket, 7.5);
                        enemy.lastFire = Date.now();
                    }
                } else if(enemy.level === "medium") {
                    if(enemy.y < 100) {
                        enemy.y += 1.5 * difficulty;
                    }
                    if(Math.abs(rocket.x - enemy.x) < 300) {
                        if(rocket.x > enemy.x) {
                            enemy.x -= 3 * difficulty;
                        } else {
                            enemy.x += 3 * difficulty;
                        }
                    }
                    if(Date.now() - enemy.reloadTime > enemy.lastFire) {
                        shootLaser("bad", {x:enemy.x - enemy.width / 3, y: enemy.y}, pointTowards(enemy.x,enemy.y,rocket.x,rocket.y) * Math.PI/180)
                        shootLaser("bad", {x:enemy.x + enemy.width / 3, y: enemy.y}, pointTowards(enemy.x,enemy.y,rocket.x,rocket.y) * Math.PI/180)
                        enemy.lastFire = Date.now();
                    }
                } else if(enemy.level === "boss2") {
                    enemy.rotation = (0-pointTowards(enemy.x,enemy.y,rocket.x,rocket.y)) * Math.PI/180;
                    if(enemy.y < innerHeight/2) {
                        enemy.y += 1.5 * difficulty;
                    }
                    if(Date.now() - enemy.burstRate > enemy.burstFire) {
                        if(Date.now() - enemy.reloadTime > enemy.lastFire) {
                            enemy.bursts--;
                            shootLaser("bad", {x:enemy.x - enemy.width / 3, y: enemy.y}, pointTowards(enemy.x - enemy.width/6,enemy.y,rocket.x,rocket.y) * Math.PI/180);
                            shootLaser("bad", {x:enemy.x + enemy.width / 3, y: enemy.y}, pointTowards(enemy.x + enemy.width/6,enemy.y,rocket.x,rocket.y) * Math.PI/180)
                            enemy.lastFire = Date.now();
                            if(enemy.bursts === 0) {
                                enemy.bursts = 25;
                                enemy.burstFire = Date.now();
                            }
                        }
                    }
                    if(Date.now() - enemy.empRate > enemy.empFire) {
                        --enemy.energy;
                        if(!enemyEMP.visible) {
                            enemyEMP.scale.set(0.5);
                        }
                        enemyEMP.visible = true;
                        enemyEMP.x = enemy.x;
                        enemyEMP.y = enemy.y;
                        enemyEMP.scale.x += 0.1;
                        enemyEMP.scale.y += 0.1;
                        enemyEMP.rotation += 0.1;
                        if(getDistance(rocket.x,rocket.y,enemyEMP.x,enemyEMP.y) < enemyEMP.width/2) {
                            if(!invincible) {
                                healthBar.width -= healthToHit/8;
                            }
                            explode(1,rocket);
                        }
                        if(enemy.energy === 0) {
                            enemy.energy = innerWidth/10;
                            enemyEMP.visible = false;
                            enemy.empFire = Date.now();
                        }
                    }
                } else if(enemy.level === "drone") {
                    if(enemy.y < innerHeight + 200) {
                        enemy.y += 5 * difficulty;
                    } else {
                        enemy.y = -400;
                    }
                    if(enemy.formationMovement) {
                        enemy.x += enemy.formationMovement.x;
                        enemy.y += enemy.formationMovement.y;
                    }
                    if(Date.now() - enemy.reloadTime > enemy.lastFire) {
                        shootLaser("bad", {x:enemy.x + 10, y: enemy.y}, 180 * Math.PI/180);
                        shootLaser("bad", {x:enemy.x - 10, y: enemy.y}, 180 * Math.PI/180);
                        shootLaser("bad", {x:enemy.x + enemy.width/2, y: enemy.y}, 180 * Math.PI/180);
                        shootLaser("bad", {x:enemy.x - enemy.width/2, y: enemy.y}, 180 * Math.PI/180);
                        enemy.lastFire = Date.now();
                    }
                } else if(enemy.level === "boss3") {
                    if(enemy.y < 100) {
                        enemy.y += 5 * difficulty;
                    }
                    if(enemy.x + enemy.xOffset + 15 < rocket.x) {
                        enemy.x += 2.5;
                    } else if(enemy.x + enemy.xOffset - 15 > rocket.x) {
                        enemy.x -= 2.5;
                    } else if(Date.now() - enemy.reloadTime > enemy.lastFire) {
                        shootLaser("bad", {x:enemy.x + 10, y: enemy.y}, 180 * Math.PI/180);
                        shootLaser("bad", {x:enemy.x - 10, y: enemy.y}, 180 * Math.PI/180);
                        // shootLaser("bad", {x:enemy.x + enemy.width/2, y: enemy.y}, 180 * Math.PI/180);
                        // shootLaser("bad", {x:enemy.x - enemy.width/2, y: enemy.y}, 180 * Math.PI/180);
                        enemy.lastFire = Date.now();
                    }

                    if(Date.now() - enemy.backupRate > enemy.backupFire) {
                        spawnNewFormation("drone", "V", 1);
                        enemy.backupFire = Date.now();
                    }
                    if(Date.now() - enemy.laserRate > enemy.laserFire) {
                        --enemy.energy;
                        enemy.laser.visible = true;
                        enemy.laser.x = enemy.x;
                        enemy.laser.y = enemy.y;
                        var laserRect = {x:enemy.laser.x-25,y:enemy.laser.y,width:50,height:innerHeight*2};
                        var rocketRect = {x: rocket.x - rocket.width/2, y: rocket.y - rocket.height/2, width: rocket.width, height: rocket.height};
                        if(hitTestRectangle(laserRect,rocketRect)) {
                            explode(1,{x:rocket.x,y:rocket.y});
                            if(!invincible) {
                                healthBar.width -= 1;
                            }
                        }
                        if(enemy.energy <= 0) {
                            enemy.laser.visible = false;
                            enemy.energy = 150;
                            enemy.laserFire = Date.now();
                        }
                    }
                }
            } else {
                enemy.alpha -= 0.05;
                if (enemy.alpha <= 0) {
                    if(enemy.level === "boss1") {
                        healthBar.width = 200;
                        healthToHit -= 2;
                        energyToFire--;
                        energyBar.width = 200;
                        boss1.fade(0.5,0, 3000);
                        setTimeout(function() {
                            music.fade(0, 0.5, 3000);
                        },3000);
                    }
                    if(enemy.level === "boss2") {
                        healthBar.width = 200;
                        healthToHit -= 2;
                        energyToFire--;
                        energyBar.width = 200;
                        boss2.fade(0.5,0, 3000);
                        setTimeout(function() {
                            music.fade(0, 0.5, 3000);
                        },3000);
                    } else if(enemy.level === "boss3") {
                        var foundEnemy1 = false;
                        var foundEnemy2 = false;
                        enemies.forEach(function(bad) {
                            if(bad.xOffset === -200) {
                                foundEnemy1 = bad;
                            } else if(bad.xOffset === 200) {
                                foundEnemy2 = bad;
                            }
                        });
                        if(foundEnemy1) {
                            foundEnemy1.xOffset = 0;
                        } else if(foundEnemy2) {
                            foundEnemy2.xOffset = 0;
                        } else {
                            healthBar.width = 200;
                            healthToHit -= 2;
                            energyToFire--;
                            energyBar.width = 200;
                            boss3.fade(0.5,0, 3000);
                            setTimeout(function() {
                                music.fade(0, 0.5, 3000);
                            },3000);
                        }
                    }
                    app.stage.removeChild(enemy);
                    enemies.splice(i,1);
                    --i;
                }
            }
        }
        if(enemies.length === 0) {
            ++level;
            difficulty += 0.05;
            if(level < 6) {
                spawnNewEnemy(level, "easy");
            } else if (level < 6.1) {
                spawnNewEnemy(1, "boss1");
                music.fade(0.5,0,2000);
                setTimeout(function(){
                    boss1.play();
                    boss1.fade(0,0.5,2000);
                }, 2000);
            } else if(level < 11) {
                spawnNewEnemy(level/3.5, "medium");
            } else if(level < 11.1) {
                spawnNewEnemy(1, "boss2");
                music.fade(0.5,0,2000);
                setTimeout(function(){
                    boss2.play();
                    boss2.fade(0,0.5,2000);
                }, 2000);
            } else if(level < 12) {
                spawnNewFormation("drone", "V", 4);
            } else if(level < 13) {
                spawnNewFormation("drone", "N", 5);
            } else if(level < 14) {
                spawnNewFormation("drone", "V", 7);
            } else if (level < 15) {
                spawnNewFormation("drone", "N", 9);
            } else if(level < 16) {
                spawnNewFormation("drone", "N", 5);
                spawnNewFormation("drone", "V", 5);
            } else if(level < 16.1) {
                music.fade(0.5,0,2000);
                setTimeout(function(){
                    boss3.play();
                    boss3.fade(0,0.5,2000);
                }, 2000);
                spawnNewEnemy(1, "boss3")[0].xOffset = 200;
                spawnNewEnemy(1, "boss3")[0].xOffset = -200;
                spawnNewEnemy(1, "boss3")[0].xOffset = 0;
            } else {
                spawnNewEnemy(level/3.5, "medium");
                spawnNewEnemy(level/3.5, "easy");
            }
        }
        for(var i = 0; i < explosions.length; i++) {
            explosions[i].alpha -= 0.05;
            if(explosions[i].alpha <= 0) {
                app.stage.removeChild(explosions[i]);
                explosions.splice(i,1);
                --i;
            }
        }
    }
    var formations = [];
    function spawnNewFormation(type, formation, endSize) {
        var set = [];
        if(formation === "V") {
            var counter = Math.floor((innerWidth/2-100)/100);
            for(var i = ((Math.ceil(innerWidth/200) * 100 ) -endSize*100); i < innerWidth/2; i+=100) {
                set.push(spawnNewEnemy(1, type, {x:i, y: counter*-100-200})[0])
                --counter;
            }
            // i += 100;
            for(i; i < innerWidth/2 + endSize*100 + endSize*100; i += 100) {
                set.push(spawnNewEnemy(1, type, {x:i, y: counter*-100-200})[0])
                ++counter;
            }
        } else if(formation === "N") {
            var counter = Math.floor((innerWidth/2-100)/100);
            for(var i = ((Math.ceil(innerWidth/200) * 100 ) -endSize*100); i < innerWidth/2; i+=100) {
                set.push(spawnNewEnemy(1, type, {x:i, y: counter*-100-200})[0])
                ++counter;
            }
            // i += 100;
            for(i; i < innerWidth/2 + endSize*100; i += 100) {
                set.push(spawnNewEnemy(1, type, {x:i, y: counter*-100-200})[0])
                --counter;
            }
        }
        for(let i = 0; i < set.length; i++) {
            set[i].formation = set;
            set[i].formationMovement = {x:0,y:0};
        }
        console.log(set)
        formations.push(set);
    }
    function spawnNewEnemy(amount, type, position) {
        var y = -200;
        var enemiesAdded = [];
        console.log(amount, type, position);
        for(let i = 0; i < amount; i++) {
            if(type === "easy") {
                var enemy = new Sprite(resources["sprites/enemy.png"].texture);
                app.stage.addChild(enemy);
                enemy.scale.set(3);
                enemy.anchor.set(0.5,0.5);
                if(position) {
                    enemy.x = position.x;
                    enemy.y = position.y;
                } else {
                    enemy.x = randInt(100, innerWidth - 100);
                    enemy.y = y;
                }
                enemy.rotation = Math.PI;
                enemy.health = randInt(0.5,1.5) * difficulty;
                enemy.lastFire = 0;
                enemy.reloadTime = 3000/difficulty;
            } else if (type === "medium") {
                var enemy = new Sprite(resources["sprites/medium.png"].texture);
                app.stage.addChild(enemy);
                enemy.scale.set(3);
                enemy.anchor.set(0.5,0.5);
                if(position) {
                    enemy.x = position.x;
                    enemy.y = position.y;
                } else {
                    enemy.x = randInt(100, innerWidth - 100);
                    enemy.y = y;
                }
                enemy.rotation = Math.PI;
                enemy.health = randInt(5,7) * difficulty;
                enemy.lastFire = 0;
                enemy.reloadTime = 5000/difficulty;
            } else if(type === "boss1") {
                var enemy = new Sprite(resources["sprites/boss1.png"].texture);
                app.stage.addChild(enemy);
                enemy.scale.set(3);
                enemy.anchor.set(0.5,0.5);
                if(position) {
                    enemy.x = position.x;
                    enemy.y = position.y;
                } else {
                    enemy.x = randInt(100, innerWidth - 100);
                    enemy.y = -600;
                }
                enemy.rotation = Math.PI;
                enemy.health = 15 * difficulty;
                enemy.lastFire = 0;
                enemy.reloadTime = 5000/difficulty;
            } else if(type === "boss2") {
                var enemy = new Sprite(resources["sprites/boss2.png"].texture);
                app.stage.addChild(enemy);
                enemy.scale.set(3);
                enemy.anchor.set(0.5,0.5);
                if(position) {
                    enemy.x = position.x;
                    enemy.y = position.y;
                } else {
                    enemy.x = innerWidth/2;
                    enemy.y = -600;
                }
                enemy.rotation = Math.PI;
                enemy.health = 20 * difficulty;
                enemy.burstFire = 0;
                enemy.burstRate = 10000/difficulty;
                enemy.lastFire = Date.now();
                enemy.reloadTime = 100/difficulty;
                enemy.empFire = Date.now();
                enemy.empRate = 17500/difficulty;
                enemy.bursts = 25;
                enemy.energy = innerWidth/10;
            } else if(type === "drone") {
                var enemy = new Sprite(resources["sprites/drone.png"].texture);
                app.stage.addChild(enemy);
                enemy.scale.set(3);
                enemy.anchor.set(0.5,0.5);
                if(position) {
                    enemy.x = position.x;
                    enemy.y = position.y;
                } else {
                    enemy.x = randInt(100, innerWidth - 100);
                    enemy.y = y;
                }
                enemy.rotation = Math.PI;
                enemy.health = randNum(0.1,0.5) * difficulty;
                enemy.lastFire = 0;
                enemy.reloadTime = 3000/difficulty;
            } else if(type === "boss3") {
                var enemy = new Sprite(resources["sprites/boss3.png"].texture);
                app.stage.addChild(enemy);
                enemy.scale.set(3);
                enemy.anchor.set(0.5,0.5);
                if(position) {
                    enemy.x = position.x;
                    enemy.y = position.y;
                } else {
                    enemy.x = randInt(100, innerWidth - 100);
                    enemy.y = -600;
                }
                enemy.rotation = Math.PI;
                enemy.health = 20 * difficulty;
                enemy.lastFire = 0;
                enemy.reloadTime = 5000/difficulty;
                enemy.laserFire = Date.now();
                enemy.laserRate = 10000/difficulty;
                enemy.energy = 150;
                enemy.backupFire = Date.now();
                enemy.backupRate = 20000/difficulty;
                enemy.laser = new PIXI.Graphics();
                enemy.laser.beginFill(0xffaaaa);
                enemy.laser.drawRect(-25,0,50, innerHeight * 2);
                app.stage.addChild(enemy.laser);
                enemy.laser.visible = false;
            }
            enemiesAdded.push(enemy);
            enemy.level = type;
            enemies.push(enemy);
            y -= 150 + randInt(25,100);
        }
        return enemiesAdded;
    }
    function launchMissile(type, position, target, speed) {
        if(type === "good") {
            var laser = new Sprite(resources["sprites/missile.png"].texture);
            laser.good = true;
        } else {
            /// TODO: Red
            var laser = new Sprite(resources["sprites/missile.png"].texture);
            laser.good = false;
        }
        laser.speed = speed;
        laser.x = position.x;
        laser.y = position.y;
        laser.anchor.set(0.5,0.5);
        if(type === "good") {
            laser.health = 300;
        } else {
            laser.health = 200;
        }
        laser.target = target;
        missiles.push(laser);
        app.stage.addChild(laser);
    }
    function shootLaser(type, position, dir) {
        if(type === "good") {
            var laser = new Sprite(resources["sprites/laser.png"].texture);
            laser.good = true;
        } else {
            /// TODO: Red
            var laser = new Sprite(resources["sprites/enemy-laser.png"].texture);
            laser.good = false;
        }
        laser.x = position.x;
        laser.y = position.y;
        laser.anchor.set(0.5,0.5);
        laser.scale.set(3);
        laser.rotation = -dir;
        lasers.push(laser);
        app.stage.addChild(laser);
    }
    function press(key){
        if(keys[key]){
            keys[key] = false;
            return true;
        }
        return false;
    }
    addEventListener("mousedown",function(e){
        if(e.button == 0) {
            keys.mouse = true;
        } else if(e.button == 2) {
            keys.rightMouse = true;
        }
        mouseX = e.pageX;
        mouseY = e.pageY;
    });
    addEventListener("mouseup",function(e){
        if(e.button == 0) { 
            keys.mouse = false;
        } else if(e.button == 2) {
            keys.rightMouse = true;
        }
    });
    addEventListener("blur", function (){
        keys = {};
    });
    addEventListener("mousemove",function(e){
        mouseX = e.pageX;
        mouseY = e.pageY;
    });
    var learnSpeed = 2;
    var answersLocked = false;
    addEventListener("keydown", function (e){
        if(!answersLocked && ((Number(e.key) >= 0 && e.key !== " ") || e.key === "." || e.key === ":")) {
            numDiv.innerHTML += e.key;
        }
        if(e.key === "Enter" && !answersLocked) {
            if (numDiv.innerHTML === correctAnswer || (correctAnswer.split(".")[1] === numDiv.innerHTML) || numDiv.innerHTML.replace(" ",".") === correctAnswer || numDiv.innerHTML.replace(":",".") === correctAnswer) { 
                if(energyBar.width + 40 > 200) {
                    healthBar.width += (energyBar.width + 40 - 200)/3;
                    energyBar.width = 200;
                } else {
                    energyBar.width += 40;
                }
                if(healthBar.width > 200) {
                    healthBar.width = 200;
                }
                numDiv.innerHTML = "";
                --questionsLeft;
                if(questionsLeft <= 0) {
                    var range = rangeDiv.innerHTML;
                    var full = true;
                    if(range.split("-")[0] === "1") {
                        var arr = range.split(/\-|\,/);
                        if(Number(arr[1]) + 3 < john16[chapter-1].length) {
                            range = (Number(arr[1])) + "-" + (Number(arr[1]) + 3);
                        } else if(Number(arr[1]) < john16[chapter-1].length) {
                            range = arr[1] + "-" + john16[chapter-1].length;
                        } else {
                            range = "";
                        }
                        full = false;
                    } else {
                        var arr = range.split(/\-|\,/);
                        range = "1-" + arr[1];
                    }
                    rangeDiv.innerHTML = range;
                    var cur = range.split(/\-|\,/);
                    if(Number(cur[0]) < Number(cur[1]) && Number(cur[0]) >= 0) {
                        if(Number(cur[1]) <= john16[chapter-1].length) {
                            params.min = cur[0];
                            params.max = cur[1];
                        }
                    }
                    if(full) {
                        questionsLeft = params.max/learnSpeed;
                    } else {
                        questionsLeft = params.max/(2*learnSpeed);
                    }
                }
            } else {
                answersLocked = true;
                numDiv.style.color = "red";
                var corAns = correctAnswer;
                setTimeout(function() {
                    numDiv.style.color = "green";
                    numDiv.innerHTML = corAns;
                },1000);
                setTimeout(function() {
                    numDiv.style.color = "white";
                    numDiv.innerHTML = "";
                    answersLocked = false;
                },2000);
            }

            curVerse = randVerse();
            correctAnswer = curVerse[0];
            curVerse = curVerse[1];
            textDiv.innerHTML = curVerse;
        }
        if(e.key === "Delete" || e.key === "Backspace") {
            numDiv.innerHTML = "";
        }
        keys[e.key] = true;
    });
    addEventListener("keyup", function (e){
        keys[e.key] = false;
    });
  </script>
</body>
</html>