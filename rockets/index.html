<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>RA Blaster</title>
</head>
    <style>* {padding: 0; margin: 0}</style>
    <script src="pixi/pixi.min.js"></script>
    <script src="usefulFunctions.js"></script>
    <script src="howler.core.min.js"></script>
    <div id="central"></div>
    <select style="position:absolute", id="chapter">
        <option>Romans 1</option>
        <option>Romans 2</option>
        <option>Romans 3</option>
        <option>Romans 4</option>
        <option>Romans 5</option>
        <option>Romans 6</option>
        <option>Romans 7</option>
        <option>Romans 8</option>
    </select>
    <select style="position:absolute; top: 20px", id="level">
        <option>Invincible</option>
        <option>Novice</option>
        <option>Easy</option>
        <option>Medium</option>
        <option>Hard</option>
        <option>Insane</option>
    </select>
    <input type="text" value="1-4" style="position:absolute; top: 40px", id="range">
    <button id="start", style="position: absolute; top: 60px">&nbsp;Start&nbsp;</button>
<body>
  <script type="text/javascript">
    "use strict";
    
    var params = getParams();
    function getParams() {
      var params = {};
      location.search.substr(1).split("&").forEach(function(el) {
        var data = el.replace(/\+/g, " ").split("=");
        params[decodeURIComponent(data[0])] = data[1] ? decodeURIComponent(data[1]) : true;
      });
      return params;
    }
    PIXI.utils.skipHello();
    PIXI.settings.SCALE_MODE = PIXI.SCALE_MODES.NEAREST;
    let Application = PIXI.Application,
        Container = PIXI.Container,
        loader = PIXI.loader,
        resources = PIXI.loader.resources,
        TextureCache = PIXI.utils.TextureCache,
        Sprite = PIXI.Sprite,
        Rectangle = PIXI.Rectangle,
        Graphics = PIXI.Graphics;
    let app = new Application({ 
        width: 800,
        height: 800,              
        antialias: true,
        transparent: false,
        resolution: 1
      }
    );
    var chapterEl = document.getElementById("chapter");
    var levelEl = document.getElementById("level");
    levelEl.selectedIndex = 3;
    var inputEl = document.getElementById("range");
    var buttonStartEl = document.getElementById("start");
    var invincible = false;
    chapterEl.style.zIndex = "100";
    levelEl.style.zIndex = "100";
    inputEl.style.zIndex = "100";
    buttonStartEl.style.zIndex = "100";
    buttonStartEl.addEventListener("click", function() {
        chapter = chapterEl.selectedIndex+1;

        rangeDiv.innerHTML = inputEl.value;
        params.min = inputEl.value.split("-")[0];
        params.max = inputEl.value.split("-")[1];
        questionsLeft = params.max;

        if(levelEl.selectedIndex === 0) {
            difficulty = 1;
            invincible = true;
        } else if(levelEl.selectedIndex === 1) {
            difficulty = 0.25;
        } else if(levelEl.selectedIndex === 2) {
            difficulty = 0.5;
        } else if(levelEl.selectedIndex === 3) {
            difficulty = 0.75;
        } else if(levelEl.selectedIndex === 4) {
            difficulty = 1;
        } else if(levelEl.selectedIndex === 5) {
            difficulty = 1.25;
        }
        chapterEl.remove();
        levelEl.remove();
        inputEl.remove();
        buttonStartEl.remove();

        curVerse = randVerse();
        correctAnswer = curVerse[0];
        curVerse = curVerse[1];
        textDiv.innerHTML = curVerse;

        intro.fade(0.5,0, 3000);
        setTimeout(function() {
            music.play();
            music.fade(0, 0.5, 3000);
        },3000);
        state = play;
        app.ticker.add(delta => gameLoop(delta));
    });
    var central = document.getElementById("central");
    central.style.position = "absolute";
    central.style.zIndex = "100";
    central.style.width = (innerWidth- 200) + "px";
    central.style.display = "flex";
    central.style.left = "100px";
    central.style.alignItems = "center";
    central.style.justifyContent = "center";
    app.renderer.backgroundColor = 0x000015;
    /// Fill the screen 
    app.renderer.view.style.position = "absolute";
    app.renderer.view.style.display = "block";
    app.renderer.autoResize = true;
    app.renderer.resize(window.innerWidth, window.innerHeight);
    document.body.appendChild(app.view);
    loader.add(["sprites/exp1.png","sprites/exp2.png","sprites/exp3.png", "sprites/enemy.png", "sprites/rocket.png", "sprites/laser.png", "sprites/medium.png", "sprites/emp.png", "sprites/enemyEMP.png", "sprites/boss1.png", "sprites/missile.png", "sprites/boss2.png", "sprites/drone.png", "sprites/boss3.png", "sprites/enemy-laser.png"]).load(setup);
    var textDiv = document.createElement("div");
    textDiv.style.position = "relative";
    // textDiv.innerHTML = "In the beginning was the Word."
    textDiv.style.fontSize = "30px";
    textDiv.style.color = "white";
    central.appendChild(textDiv);
    var numDiv = document.createElement("div");
    numDiv.style.position = "absolute";
    numDiv.style.right = "-100px";
    numDiv.innerHTML = "";
    numDiv.style.fontSize = "30px";
    numDiv.style.color = "white";
    central.appendChild(numDiv);

    var rangeDiv = document.createElement("div");
    rangeDiv.style.position = "absolute";
    rangeDiv.style.left = "-100px";
    rangeDiv.style.top = innerHeight-40 + "px";
    rangeDiv.innerHTML = "1-4";
    params.min = 1;
    params.max = 4;
    var questionsLeft = 4;
    rangeDiv.style.fontSize = "30px";
    rangeDiv.style.color = "white";
    central.appendChild(rangeDiv);
    var energyHolder = new PIXI.Graphics();
    energyHolder.lineStyle(5, 0x00AAAA,10);
    energyHolder.beginFill(0x000015);
    energyHolder.drawRect(0,0,200,25)
    app.stage.addChild(energyHolder);
    energyHolder.x = innerWidth - 225;
    energyHolder.y = innerHeight - 50;
    var energyBar = new PIXI.Graphics();
    energyBar.lineStyle(5, 0x00AAAA,10);
    energyBar.beginFill(0x00AAAA, 10);
    energyBar.drawRect(0,0,200,25);
    energyBar.x = innerWidth - 225;
    energyBar.y = innerHeight - 50;
    app.stage.addChild(energyBar);



    var healthHolder = new PIXI.Graphics();
    healthHolder.lineStyle(5, 0xFF0000,10);
    healthHolder.beginFill(0x000015);
    healthHolder.drawRect(0,0,200,25)
    app.stage.addChild(healthHolder);
    healthHolder.x = innerWidth - 225;
    healthHolder.y = innerHeight - 100;
    var healthBar = new PIXI.Graphics();
    healthBar.lineStyle(5, 0xFF0000,10);
    healthBar.beginFill(0xFF0000, 10);
    healthBar.drawRect(0,0,200,25);
    healthBar.x = innerWidth - 225;
    healthBar.y = innerHeight - 100;
    app.stage.addChild(healthBar);

    var intro = new Howl({src: ["music/intro.mp3"], autoplay: true, loop: true, volume: 0.5});
    var music = new Howl({src: ["music/level1.mp3"], autoplay: false, loop: true, volume: 0.5});
    /// TODO: Change intro to intro after we get intro and music to battle after the intro ends.
    var boss1 = new Howl({src: ["music/boss1.mp3"], autoplay: false, loop: true, volume: 0});
    var boss2 = new Howl({src: ["music/boss2.mp3"], autoplay: false, loop: true, volume: 0});
    var boss3 = new Howl({src: ["music/boss3.mp3"], autoplay: false, loop: true, volume: 0});


    var rom18 = [["Paul, a servant of Jesus Christ, called to be an apostle, separated unto the gospel of God,", "(Which he had promised afore by his prophets in the holy scriptures,)", "Concerning his Son Jesus Christ our Lord, which was made of the seed of David according to the flesh;", "And declared to be the Son of God with power, according to the spirit of holiness, by the resurrection from the dead:", "By whom we have received grace and apostleship, for obedience to the faith among all nations, for his name:", "Among whom are ye also the called of Jesus Christ:", "To all that be in Rome, beloved of God, called to be saints: Grace to you and peace from God our Father, and the Lord Jesus Christ.", "First, I thank my God through Jesus Christ for you all, that your faith is spoken of throughout the whole world.", "For God is my witness, whom I serve with my spirit in the gospel of his Son, that without ceasing I make mention of you always in my prayers;", "Making request, if by any means now at length I might have a prosperous journey by the will of God to come unto you.", "For I long to see you, that I may impart unto you some spiritual gift, to the end ye may be established;", "That is, that I may be comforted together with you by the mutual faith both of you and me.", "Now I would not have you ignorant, brethren, that oftentimes I purposed to come unto you, (but was let hitherto,) that I might have some fruit among you also, even as among other Gentiles.", "I am debtor both to the Greeks, and to the Barbarians; both to the wise, and to the unwise.", "So, as much as in me is, I am ready to preach the gospel to you that are at Rome also.", "For I am not ashamed of the gospel of Christ: for it is the power of God unto salvation to every one that believeth; to the Jew first, and also to the Greek.", "For therein is the righteousness of God revealed from faith to faith: as it is written, The just shall live by faith.", "For the wrath of God is revealed from heaven against all ungodliness and unrighteousness of men, who hold the truth in unrighteousness;", "Because that which may be known of God is manifest in them; for God hath shewed it unto them.", "For the invisible things of him from the creation of the world are clearly seen, being understood by the things that are made, even his eternal power and Godhead; so that they are without excuse:", "Because that, when they knew God, they glorified him not as God, neither were thankful; but became vain in their imaginations, and their foolish heart was darkened.", "Professing themselves to be wise, they became fools,", "And changed the glory of the uncorruptible God into an image made like to corruptible man, and to birds, and fourfooted beasts, and creeping things.", "Wherefore God also gave them up to uncleanness through the lusts of their own hearts, to dishonour their own bodies between themselves:", "Who changed the truth of God into a lie, and worshipped and served the creature more than the Creator, who is blessed for ever. Amen.", "For this cause God gave them up unto vile affections: for even their women did change the natural use into that which is against nature:", "And likewise also the men, leaving the natural use of the woman, burned in their lust one toward another; men with men working that which is unseemly, and receiving in themselves that recompence of their error which was meet.", "And even as they did not like to retain God in their knowledge, God gave them over to a reprobate mind, to do those things which are not convenient;", "Being filled with all unrighteousness, fornication, wickedness, covetousness, maliciousness; full of envy, murder, debate, deceit, malignity; whisperers,", "Backbiters, haters of God, despiteful, proud, boasters, inventors of evil things, disobedient to parents,", "Without understanding, covenantbreakers, without natural affection, implacable, unmerciful:", "Who knowing the judgment of God, that they which commit such things are worthy of death, not only do the same, but have pleasure in them that do them."],
        ["Therefore thou art inexcusable, O man, whosoever thou art that judgest: for wherein thou judgest another, thou condemnest thyself; for thou that judgest doest the same things.", "But we are sure that the judgment of God is according to truth against them which commit such things.", "And thinkest thou this, O man, that judgest them which do such things, and doest the same, that thou shalt escape the judgment of God?", "Or despisest thou the riches of his goodness and forbearance and longsuffering; not knowing that the goodness of God leadeth thee to repentance?", "But after thy hardness and impenitent heart treasurest up unto thyself wrath against the day of wrath and revelation of the righteous judgment of God;", "Who will render to every man according to his deeds:", "To them who by patient continuance in well doing seek for glory and honour and immortality, eternal life:", "But unto them that are contentious, and do not obey the truth, but obey unrighteousness, indignation and wrath,", "Tribulation and anguish, upon every soul of man that doeth evil, of the Jew first, and also of the Gentile;", "But glory, honour, and peace, to every man that worketh good, to the Jew first, and also to the Gentile:", "For there is no respect of persons with God.", "For as many as have sinned without law shall also perish without law: and as many as have sinned in the law shall be judged by the law;", "(For not the hearers of the law are just before God, but the doers of the law shall be justified.", "For when the Gentiles, which have not the law, do by nature the things contained in the law, these, having not the law, are a law unto themselves:", "Which shew the work of the law written in their hearts, their conscience also bearing witness, and their thoughts the mean while accusing or else excusing one another;)", "In the day when God shall judge the secrets of men by Jesus Christ according to my gospel.", "Behold, thou art called a Jew, and restest in the law, and makest thy boast of God,", "And knowest his will, and approvest the things that are more excellent, being instructed out of the law;", "And art confident that thou thyself art a guide of the blind, a light of them which are in darkness,", "An instructor of the foolish, a teacher of babes, which hast the form of knowledge and of the truth in the law.", "Thou therefore which teachest another, teachest thou not thyself? thou that preachest a man should not steal, dost thou steal?", "Thou that sayest a man should not commit adultery, dost thou commit adultery? thou that abhorrest idols, dost thou commit sacrilege?", "Thou that makest thy boast of the law, through breaking the law dishonourest thou God?", "For the name of God is blasphemed among the Gentiles through you, as it is written.", "For circumcision verily profiteth, if thou keep the law: but if thou be a breaker of the law, thy circumcision is made uncircumcision.", "Therefore if the uncircumcision keep the righteousness of the law, shall not his uncircumcision be counted for circumcision?", "And shall not uncircumcision which is by nature, if it fulfil the law, judge thee, who by the letter and circumcision dost transgress the law?", "For he is not a Jew, which is one outwardly; neither is that circumcision, which is outward in the flesh:", "But he is a Jew, which is one inwardly; and circumcision is that of the heart, in the spirit, and not in the letter; whose praise is not of men, but of God."],
        ["What advantage then hath the Jew? or what profit is there of circumcision?", "Much every way: chiefly, because that unto them were committed the oracles of God.", "For what if some did not believe? shall their unbelief make the faith of God without effect?", "God forbid: yea, let God be true, but every man a liar; as it is written, That thou mightest be justified in thy sayings, and mightest overcome when thou art judged.", "But if our unrighteousness commend the righteousness of God, what shall we say? Is God unrighteous who taketh vengeance? (I speak as a man)", "God forbid: for then how shall God judge the world?", "For if the truth of God hath more abounded through my lie unto his glory; why yet am I also judged as a sinner?", "And not rather, (as we be slanderously reported, and as some affirm that we say,) Let us do evil, that good may come? whose damnation is just.", "What then? are we better than they? No, in no wise: for we have before proved both Jews and Gentiles, that they are all under sin;", "As it is written, There is none righteous, no, not one:", "There is none that understandeth, there is none that seeketh after God.", "They are all gone out of the way, they are together become unprofitable; there is none that doeth good, no, not one.", "Their throat is an open sepulchre; with their tongues they have used deceit; the poison of asps is under their lips:", "Whose mouth is full of cursing and bitterness:", "Their feet are swift to shed blood:", "Destruction and misery are in their ways:", "And the way of peace have they not known:", "There is no fear of God before their eyes.", "Now we know that what things soever the law saith, it saith to them who are under the law: that every mouth may be stopped, and all the world may become guilty before God.", "Therefore by the deeds of the law there shall no flesh be justified in his sight: for by the law is the knowledge of sin.", "But now the righteousness of God without the law is manifested, being witnessed by the law and the prophets;", "Even the righteousness of God which is by faith of Jesus Christ unto all and upon all them that believe: for there is no difference:", "For all have sinned, and come short of the glory of God;", "Being justified freely by his grace through the redemption that is in Christ Jesus:", "Whom God hath set forth to be a propitiation through faith in his blood, to declare his righteousness for the remission of sins that are past, through the forbearance of God;", "To declare, I say, at this time his righteousness: that he might be just, and the justifier of him which believeth in Jesus.", "Where is boasting then? It is excluded. By what law? of works? Nay: but by the law of faith.", "Therefore we conclude that a man is justified by faith without the deeds of the law.", "Is he the God of the Jews only? is he not also of the Gentiles? Yes, of the Gentiles also:", "Seeing it is one God, which shall justify the circumcision by faith, and uncircumcision through faith.", "Do we then make void the law through faith? God forbid: yea, we establish the law."],
        ["What shall we say then that Abraham our father, as pertaining to the flesh, hath found?", "For if Abraham were justified by works, he hath whereof to glory; but not before God.", "For what saith the scripture? Abraham believed God, and it was counted unto him for righteousness.", "Now to him that worketh is the reward not reckoned of grace, but of debt.", "But to him that worketh not, but believeth on him that justifieth the ungodly, his faith is counted for righteousness.", "Even as David also describeth the blessedness of the man, unto whom God imputeth righteousness without works,", "Saying, Blessed are they whose iniquities are forgiven, and whose sins are covered.", "Blessed is the man to whom the Lord will not impute sin.", "Cometh this blessedness then upon the circumcision only, or upon the uncircumcision also? for we say that faith was reckoned to Abraham for righteousness.", "How was it then reckoned? when he was in circumcision, or in uncircumcision? Not in circumcision, but in uncircumcision.", "And he received the sign of circumcision, a seal of the righteousness of the faith which he had yet being uncircumcised: that he might be the father of all them that believe, though they be not circumcised; that righteousness might be imputed unto them also:", "And the father of circumcision to them who are not of the circumcision only, but who also walk in the steps of that faith of our father Abraham, which he had being yet uncircumcised.", "For the promise, that he should be the heir of the world, was not to Abraham, or to his seed, through the law, but through the righteousness of faith.", "For if they which are of the law be heirs, faith is made void, and the promise made of none effect:", "Because the law worketh wrath: for where no law is, there is no transgression.", "Therefore it is of faith, that it might be by grace; to the end the promise might be sure to all the seed; not to that only which is of the law, but to that also which is of the faith of Abraham; who is the father of us all,", "(As it is written, I have made thee a father of many nations,) before him whom he believed, even God, who quickeneth the dead, and calleth those things which be not as though they were.", "Who against hope believed in hope, that he might become the father of many nations, according to that which was spoken, So shall thy seed be.", "And being not weak in faith, he considered not his own body now dead, when he was about an hundred years old, neither yet the deadness of Sara's womb:", " He staggered not at the promise of God through unbelief; but was strong in faith, giving glory to God;", "And being fully persuaded that, what he had promised, he was able also to perform.", "And therefore it was imputed to him for righteousness.", "Now it was not written for his sake alone, that it was imputed to him;", "But for us also, to whom it shall be imputed, if we believe on him that raised up Jesus our Lord from the dead;", "Who was delivered for our offences, and was raised again for our justification."],
        ["Therefore being justified by faith, we have peace with God through our Lord Jesus Christ:", "By whom also we have access by faith into this grace wherein we stand, and rejoice in hope of the glory of God.", "And not only so, but we glory in tribulations also: knowing that tribulation worketh patience;", "And patience, experience; and experience, hope:", "And hope maketh not ashamed; because the love of God is shed abroad in our hearts by the Holy Ghost which is given unto us.", "For when we were yet without strength, in due time Christ died for the ungodly.", "For scarcely for a righteous man will one die: yet peradventure for a good man some would even dare to die.", "But God commendeth his love toward us, in that, while we were yet sinners, Christ died for us.", "Much more then, being now justified by his blood, we shall be saved from wrath through him.", "For if, when we were enemies, we were reconciled to God by the death of his Son, much more, being reconciled, we shall be saved by his life.", "And not only so, but we also joy in God through our Lord Jesus Christ, by whom we have now received the atonement.", "Wherefore, as by one man sin entered into the world, and death by sin; and so death passed upon all men, for that all have sinned:", "(For until the law sin was in the world: but sin is not imputed when there is no law.", "Nevertheless death reigned from Adam to Moses, even over them that had not sinned after the similitude of Adam's transgression, who is the figure of him that was to come.", "But not as the offence, so also is the free gift. For if through the offence of one many be dead, much more the grace of God, and the gift by grace, which is by one man, Jesus Christ, hath abounded unto many.", "And not as it was by one that sinned, so is the gift: for the judgment was by one to condemnation, but the free gift is of many offences unto justification.", "For if by one man's offence death reigned by one; much more they which receive abundance of grace and of the gift of righteousness shall reign in life by one, Jesus Christ.)", "Therefore as by the offence of one judgment came upon all men to condemnation; even so by the righteousness of one the free gift came upon all men unto justification of life.", "For as by one man's disobedience many were made sinners, so by the obedience of one shall many be made righteous.", "Moreover the law entered, that the offence might abound. But where sin abounded, grace did much more abound:", "That as sin hath reigned unto death, even so might grace reign through righteousness unto eternal life by Jesus Christ our Lord."],
        ["What shall we say then? Shall we continue in sin, that grace may abound?", "God forbid. How shall we, that are dead to sin, live any longer therein?", " Know ye not, that so many of us as were baptized into Jesus Christ were baptized into his death?", "Therefore we are buried with him by baptism into death: that like as Christ was raised up from the dead by the glory of the Father, even so we also should walk in newness of life.", "For if we have been planted together in the likeness of his death, we shall be also in the likeness of his resurrection:", "Knowing this, that our old man is crucified with him, that the body of sin might be destroyed, that henceforth we should not serve sin.", "For he that is dead is freed from sin.", "Now if we be dead with Christ, we believe that we shall also live with him:", "Knowing that Christ being raised from the dead dieth no more; death hath no more dominion over him.", "For in that he died, he died unto sin once: but in that he liveth, he liveth unto God.", "Likewise reckon ye also yourselves to be dead indeed unto sin, but alive unto God through Jesus Christ our Lord.", "Let not sin therefore reign in your mortal body, that ye should obey it in the lusts thereof.", "Neither yield ye your members as instruments of unrighteousness unto sin: but yield yourselves unto God, as those that are alive from the dead, and your members as instruments of righteousness unto God.", "For sin shall not have dominion over you: for ye are not under the law, but under grace.", "What then? shall we sin, because we are not under the law, but under grace? God forbid.", "Know ye not, that to whom ye yield yourselves servants to obey, his servants ye are to whom ye obey; whether of sin unto death, or of obedience unto righteousness?", "But God be thanked, that ye were the servants of sin, but ye have obeyed from the heart that form of doctrine which was delivered you.", "Being then made free from sin, ye became the servants of righteousness.", "I speak after the manner of men because of the infirmity of your flesh: for as ye have yielded your members servants to uncleanness and to iniquity unto iniquity; even so now yield your members servants to righteousness unto holiness.", "For when ye were the servants of sin, ye were free from righteousness.", "What fruit had ye then in those things whereof ye are now ashamed? for the end of those things is death.", "But now being made free from sin, and become servants to God, ye have your fruit unto holiness, and the end everlasting life.", "For the wages of sin is death; but the gift of God is eternal life through Jesus Christ our Lord."],
        ["Know ye not, brethren, (for I speak to them that know the law,) how that the law hath dominion over a man as long as he liveth?", "For the woman which hath an husband is bound by the law to her husband so long as he liveth; but if the husband be dead, she is loosed from the law of her husband.", "So then if, while her husband liveth, she be married to another man, she shall be called an adulteress: but if her husband be dead, she is free from that law; so that she is no adulteress, though she be married to another man.", "Wherefore, my brethren, ye also are become dead to the law by the body of Christ; that ye should be married to another, even to him who is raised from the dead, that we should bring forth fruit unto God.", "For when we were in the flesh, the motions of sins, which were by the law, did work in our members to bring forth fruit unto death.", "But now we are delivered from the law, that being dead wherein we were held; that we should serve in newness of spirit, and not in the oldness of the letter.", "What shall we say then? Is the law sin? God forbid. Nay, I had not known sin, but by the law: for I had not known lust, except the law had said, Thou shalt not covet.", "But sin, taking occasion by the commandment, wrought in me all manner of concupiscence. For without the law sin was dead.", "For I was alive without the law once: but when the commandment came, sin revived, and I died.", "And the commandment, which was ordained to life, I found to be unto death.", "For sin, taking occasion by the commandment, deceived me, and by it slew me.", "Wherefore the law is holy, and the commandment holy, and just, and good.", "Was then that which is good made death unto me? God forbid. But sin, that it might appear sin, working death in me by that which is good; that sin by the commandment might become exceeding sinful.", "For we know that the law is spiritual: but I am carnal, sold under sin.", "For that which I do I allow not: for what I would, that do I not; but what I hate, that do I.", "If then I do that which I would not, I consent unto the law that it is good.", "Now then it is no more I that do it, but sin that dwelleth in me.", "For I know that in me (that is, in my flesh,) dwelleth no good thing: for to will is present with me; but how to perform that which is good I find not.", "For the good that I would I do not: but the evil which I would not, that I do.", "Now if I do that I would not, it is no more I that do it, but sin that dwelleth in me.", "I find then a law, that, when I would do good, evil is present with me.", "For I delight in the law of God after the inward man:", "But I see another law in my members, warring against the law of my mind, and bringing me into captivity to the law of sin which is in my members.", "O wretched man that I am! who shall deliver me from the body of this death?", "I thank God through Jesus Christ our Lord. So then with the mind I myself serve the law of God; but with the flesh the law of sin."],
        ["There is therefore now no condemnation to them which are in Christ Jesus, who walk not after the flesh, but after the Spirit.", "For the law of the Spirit of life in Christ Jesus hath made me free from the law of sin and death.", "For what the law could not do, in that it was weak through the flesh, God sending his own Son in the likeness of sinful flesh, and for sin, condemned sin in the flesh:", "That the righteousness of the law might be fulfilled in us, who walk not after the flesh, but after the Spirit.", "For they that are after the flesh do mind the things of the flesh; but they that are after the Spirit the things of the Spirit.", "For to be carnally minded is death; but to be spiritually minded is life and peace.", "Because the carnal mind is enmity against God: for it is not subject to the law of God, neither indeed can be.", "So then they that are in the flesh cannot please God.", "But ye are not in the flesh, but in the Spirit, if so be that the Spirit of God dwell in you. Now if any man have not the Spirit of Christ, he is none of his.", "And if Christ be in you, the body is dead because of sin; but the Spirit is life because of righteousness.", "But if the Spirit of him that raised up Jesus from the dead dwell in you, he that raised up Christ from the dead shall also quicken your mortal bodies by his Spirit that dwelleth in you.", "Therefore, brethren, we are debtors, not to the flesh, to live after the flesh.", "For if ye live after the flesh, ye shall die: but if ye through the Spirit do mortify the deeds of the body, ye shall live.", "For as many as are led by the Spirit of God, they are the sons of God.", "For ye have not received the spirit of bondage again to fear; but ye have received the Spirit of adoption, whereby we cry, Abba, Father.", "The Spirit itself beareth witness with our spirit, that we are the children of God:", "And if children, then heirs; heirs of God, and joint-heirs with Christ; if so be that we suffer with him, that we may be also glorified together.", "For I reckon that the sufferings of this present time are not worthy to be compared with the glory which shall be revealed in us.", "For the earnest expectation of the creature waiteth for the manifestation of the sons of God.", "For the creature was made subject to vanity, not willingly, but by reason of him who hath subjected the same in hope,", "Because the creature itself also shall be delivered from the bondage of corruption into the glorious liberty of the children of God.", "For we know that the whole creation groaneth and travaileth in pain together until now.", "And not only they, but ourselves also, which have the firstfruits of the Spirit, even we ourselves groan within ourselves, waiting for the adoption, to wit, the redemption of our body.", "For we are saved by hope: but hope that is seen is not hope: for what a man seeth, why doth he yet hope for?", "But if we hope for that we see not, then do we with patience wait for it.", " Likewise the Spirit also helpeth our infirmities: for we know not what we should pray for as we ought: but the Spirit itself maketh intercession for us with groanings which cannot be uttered.", "And he that searcheth the hearts knoweth what is the mind of the Spirit, because he maketh intercession for the saints according to the will of God.", "And we know that all things work together for good to them that love God, to them who are the called according to his purpose.", "For whom he did foreknow, he also did predestinate to be conformed to the image of his Son, that he might be the firstborn among many brethren.", "Moreover whom he did predestinate, them he also called: and whom he called, them he also justified: and whom he justified, them he also glorified.", "What shall we then say to these things? If God be for us, who can be against us?", "He that spared not his own Son, but delivered him up for us all, how shall he not with him also freely give us all things?", "Who shall lay any thing to the charge of God's elect? It is God that justifieth.", "Who is he that condemneth? It is Christ that died, yea rather, that is risen again, who is even at the right hand of God, who also maketh intercession for us.", "Who shall separate us from the love of Christ? shall tribulation, or distress, or persecution, or famine, or nakedness, or peril, or sword?", "As it is written, For thy sake we are killed all the day long; we are accounted as sheep for the slaughter.", "Nay, in all these things we are more than conquerors through him that loved us.", "For I am persuaded, that neither death, nor life, nor angels, nor principalities, nor powers, nor things present, nor things to come,", "Nor height, nor depth, nor any other creature, shall be able to separate us from the love of God, which is in Christ Jesus our Lord."],
    ];
    var chapter = Number(params.chapter) || randInt(1,8);
    var curVerse = randVerse();
    var correctAnswer = curVerse[0];
    var missiles = [];
    curVerse = curVerse[1];
    // textDiv.innerHTML = curVerse;
    var difficulty = 0.75;
    function randInt(min, max, not) {
        if(max === undefined) {
            max = min
            min = 1
        }
        var num = Math.floor(Math.random() * (max - min + 1)) + min;
        while(num === not && max-min > 0) {
            num = Math.floor(Math.random() * (max - min + 1)) + min;
        }
        return num;
    }
    function randVerse() {
        var verseArr = rom18[chapter-1];
        var rand = randInt((params.min ? Number(params.min)-1 : 0), Number(params.max)-1 || verseArr.length-1, (correctAnswer ? Number(correctAnswer.split(".")[1])-1 : -1));
        var verseNumber = chapter + "." + (rand+1);
        return [verseNumber, verseArr[rand]];
    }


    // energyHolder.beginFill();
    var state;
    var keys = {};
    var rocket;
    var enemies = [];
    var explosions = [];
    var mouseX,mouseY;
    var lasers = [];
    var lastFire = 0;
    var reloadTime = 500;
    var energyToFire = 5;
    var healthToHit = 10;
    var emp;
    var enemyEMP;
    var laserGraphics = new PIXI.Graphics();
    laserGraphics.beginFill(0xffffaa);
    laserGraphics.drawRect(-25,0,50, -innerHeight * 2);
    app.stage.addChild(laserGraphics);
    app.stage.sortableChildren = true;
    function setup() {
        spawnNewEnemy(1,"easy");
        rocket = new Sprite(resources["sprites/rocket.png"].texture);
        app.stage.addChild(rocket);
        rocket.anchor.set(0.5,0.5);
        rocket.scale.set(3);
        rocket.x = 100;
        rocket.y = 100;

        emp = new Sprite(resources["sprites/emp.png"].texture);
        app.stage.addChild(emp);
        emp.anchor.set(0.5,0.5);
        emp.x = 100;
        emp.y = 100;
        emp.visible = false;

        enemyEMP = new Sprite(resources["sprites/enemyEMP.png"].texture);
        app.stage.addChild(enemyEMP);
        enemyEMP.anchor.set(0.5,0.5);
        enemyEMP.x = 100;
        enemyEMP.y = 100;
        enemyEMP.visible = false;
        enemyEMP.zIndex = 10000;
    }
    function gameLoop(delta) {
      state(delta)
    }
    var level = 1;
    function explode(amount, position, magnitude) {
        for(var i = 0; i < amount; i++) {
            if(magnitude) {
                var rand = magnitude/3-0.1;
            } else {
                var rand = Math.random();
            }
            if(rand < 0.33) {
                var explosion = new Sprite(resources["sprites/exp1.png"].texture);
            } else if(rand < 0.66) {
                var explosion = new Sprite(resources["sprites/exp2.png"].texture);
            } else {
                var explosion = new Sprite(resources["sprites/exp3.png"].texture);
            }
            app.stage.addChild(explosion);
            explosion.x = position.x + randInt(-20,20);
            explosion.y = position.y + randInt(-20,20);
            explosions.push(explosion);
            explosion.scale.set(3);
        }
    }
    function bigExplosion(amount, position, magnitude) {
        for(var i = 0; i < amount; i++) {
            if(magnitude) {
                var rand = magnitude/3-0.1;
            } else {
                var rand = Math.random();
            }
            if(rand < 0.33) {
                var explosion = new Sprite(resources["sprites/exp1.png"].texture);
            } else if(rand < 0.66) {
                var explosion = new Sprite(resources["sprites/exp2.png"].texture);
            } else {
                var explosion = new Sprite(resources["sprites/exp3.png"].texture);
            }
            app.stage.addChild(explosion);
            explosion.x = position.x + randInt(-150,150);
            explosion.y = position.y + randInt(-150,150);
            explosions.push(explosion);
            explosion.scale.set(3);
        }
    }
    function die() {
        explode(1,{x:rocket.x,y:rocket.y});
        for(var i = 0; i < explosions.length; i++) {
            explosions[i].alpha -= 0.05;
            if(explosions[i].alpha <= 0) {
                app.stage.removeChild(explosions[i]);
                explosions.splice(i,1);
                --i;
            }
        }
        for(var i = 0; i < enemies.length; i++) {
            enemies[i].alpha -= 0.05;
            if(enemies[i].alpha <= 0) {
                app.stage.removeChild(enemies[i]);
                enemies.splice(i,1);
                --i;
            }
        }

        for(var i = 0; i < lasers.length; i++) {
            lasers[i].alpha -= 0.05;
            if(lasers[i].alpha <= 0) {
                app.stage.removeChild(lasers[i]);
                lasers.splice(i,1);
                --i;
            }
        }


        for(var i = 0; i < missiles.length; i++) {
            missiles[i].alpha -= 0.05;
            if(missiles[i].alpha <= 0) {
                app.stage.removeChild(missiles[i]);
                missiles.splice(i,1);
                --i;
            }
        }
    }
    function play(){
        if(healthBar.width < 0) {
            state = die;
        }
        rocket.vx = 0;
        rocket.vy = 0;
        if(keys.ArrowUp || keys.w) {
            rocket.vy += -10;
        }
        if(keys.ArrowDown || keys.s) {
            rocket.vy += 10;
        }
        if(keys.ArrowLeft || keys.a) {
            rocket.vx += -10;
        }
        if(keys.ArrowRight || keys.d) {
            rocket.vx += 10;
        }
        if(keys[" "] && Date.now() - reloadTime > lastFire && energyBar.width >= energyToFire) {
            shootLaser("good", {x:rocket.x, y: rocket.y - rocket.height/2}, 0);
            lastFire = Date.now();
            energyBar.width -= energyToFire;
        }
        if(keys.m && energyBar.width >= energyToFire*7 && enemies.length) {
            var closestEnemy;
            var closestDist = Infinity;
            for(let i = 0; i < enemies.length; i++) {
                var enemy = enemies[i];
                if(getDistance(rocket.x,rocket.y,enemy.x,enemy.y) < closestDist && enemy.alpha === 1) {
                    closestDist = getDistance(rocket.x,rocket.y,enemy.x,enemy.y)
                    closestEnemy = enemy;
                }
            }
            launchMissile("good",  {x:rocket.x, y: rocket.y - rocket.height/2}, closestEnemy, 10);
            keys.m = false;
            energyBar.width -= energyToFire*7;
        }
        if(keys.e && energyBar.width > 0) {
            if(!emp.visible) {
                emp.scale.set(0.5);
            }
            emp.scale.x += 0.1;
            emp.scale.y += 0.1;
            emp.visible = true;
            emp.rotation += 0.1;
            emp.x = rocket.x;
            emp.y = rocket.y;
            energyBar.width -= energyToFire/5;
            for(var i = 0; i < enemies.length; i++) {
                var enemy = enemies[i];
                if(getDistance(enemy.x,enemy.y,emp.x,emp.y) < emp.width/2) {
                    explode(1,{x:enemy.x,y:enemy.y});
                    enemy.health -= 0.1;
                }
            }
        } else {
            emp.visible = false;
        }
        if(keys.l && energyBar.width > 0) {
            laserGraphics.visible = true;
            for(var i = 0; i < enemies.length; i++) {
                var enemy = enemies[i];
                var enemyRect = {x: enemy.x - enemy.width/2, y: enemy.y - enemy.height/2, width: enemy.width, height: enemy.height};
                var laserRect = {x:laserGraphics.x-25,y:laserGraphics.y-innerHeight*2,width:50,height:innerHeight*2};
                if(hitTestRectangle(laserRect,enemyRect)) {
                    explode(1,{x:enemy.x,y:enemy.y});
                    enemy.health -= 0.1;
                }
            }
            energyBar.width -= energyToFire/4;
        } else {
            laserGraphics.visible = false;
        }
        if(energyBar.width > Math.abs(rocket.vx/100) + Math.abs(rocket.vy/100)) {
            if(rocket.x > rocket.width/2 && rocket.vx < 0) {
                rocket.x += rocket.vx;
            } else if(rocket.x + rocket.width/2 < innerWidth && rocket.vx > 0) {
                rocket.x += rocket.vx;
            }

            if(rocket.y > rocket.height/2 && rocket.vy < 0) {
                rocket.y += rocket.vy;
            } else if(rocket.y + rocket.height/2 < innerHeight && rocket.vy > 0) {
                rocket.y += rocket.vy;
            }
            energyBar.width -= Math.abs(rocket.vx/100) + Math.abs(rocket.vy/100);
            laserGraphics.x = rocket.x;
            laserGraphics.y = rocket.y;
        }

        for(var i = 0; i < missiles.length; i++) {
            var missile = missiles[i];
            if(missile === undefined) {
                break;
            }
            --missile.health;
            if((missile.target ? missile.target.health <= 0 : true)) {
                debugger;
                var closestEnemy;
                var closestDist = Infinity;
                for(let i = 0; i < enemies.length; i++) {
                    var enemy = enemies[i];
                    if(getDistance(missile.x,missile.y,enemy.x,enemy.y) < closestDist && enemy.alpha === 1) {
                        closestDist = getDistance(rocket.x,rocket.y,enemy.x,enemy.y)
                        closestEnemy = enemy;
                    }
                }
                if(closestEnemy) {
                    missile.target = closestEnemy;
                } else {
                    explode(1,{x:missile.x,y:missile.y});
                    app.stage.removeChild(missile);
                    missiles.splice(i,1);
                    --i;
                    break;
                }
            }
            if (missile.health <= 0) {
                explode(1,{x:missile.x,y:missile.y});
                app.stage.removeChild(missile);
                missiles.splice(i,1);
                --i;
            }
            missile.rotation = pointTowards(missile.x,missile.y,missile.target.x,missile.target.y) * Math.PI/180;
            missile.rotation *= -1;
            var missileDirection = radDirection(missile.speed, -missile.rotation + Math.PI);
            missile.x += missileDirection.r;
            missile.y += missileDirection.u;
            if(missile.y < -10 || missile.y > innerHeight + 10 || missile.x < 10 || missile.x > innerWidth + 10) {
                app.stage.removeChild(missile);
                missiles.splice(i,1);
                --i;
                continue;
            }
            var missileRect = {x: missile.x-missile.width/2, y: missile.y-missile.height/2,width:missile.width,height:missile.height};
            var rocketRect = {x: rocket.x - rocket.width/2, y: rocket.y - rocket.height/2, width: rocket.width, height: rocket.height};
            if(hitTestRectangle(missileRect, rocketRect) && !missile.good) {
                if(!invincible) {
                    healthBar.width -= healthToHit*3;
                }
                explode(20,{x:missile.x - missile.width, y:missile.y + missile.height});
                app.stage.removeChild(missile);
                missiles.splice(i,1);
                --i;
                continue;
            }
            for(var j = 0; j < enemies.length; j++) { 
                var enemy = enemies[j];
                var enemyRect = {x: enemy.x - enemy.width/2, y: enemy.y - enemy.height/2, width: enemy.width, height: enemy.height};
                if(hitTestRectangle(missileRect, enemyRect) && missile.good) {
                    enemy.health -= 3;
                    explode(10,{x:missile.x - missile.width, y:missile.y - missile.height});
                    if(enemy.health <= 0) {
                        bigExplosion(100,{x:enemy.x,y:enemy.y});
                    }
                    enemies.forEach(function(enemy){
                        if(getDistance(enemy.x,enemy.y,missile.x,missile.y) < 200) {
                            explode(10,{x:enemy.x, y:enemy.y});
                            enemy.health -= 2;
                        }
                    });
                    app.stage.removeChild(missile);
                    missiles.splice(i,1);
                    --i;
                    j = enemies.length;
                    continue;
                }   
            }
        }

        for(var i = 0; i < lasers.length; i++) {
            var laser = lasers[i];
            var laserDirection = radDirection(20,-laser.rotation + Math.PI);
            laser.x += laserDirection.r;
            laser.y += laserDirection.u;
            if(laser.y < -10 || laser.y > innerHeight + 10 || laser.x < 10 || laser.x > innerWidth + 10) {
                app.stage.removeChild(laser);
                lasers.splice(i,1);
                --i;
                continue;
            }
            var laserRect = {x: laser.x-laser.width/2, y: laser.y-laser.height/2,width:laser.width,height:laser.height};
            var rocketRect = {x: rocket.x - rocket.width/2, y: rocket.y - rocket.height/2, width: rocket.width, height: rocket.height};
            if(hitTestRectangle(laserRect, rocketRect) && !laser.good) {
                if(!invincible) {
                    healthBar.width -= healthToHit;
                }
                explode(1,{x:laser.x - laser.width, y:laser.y + laser.height});
                app.stage.removeChild(laser);
                lasers.splice(i,1);
                --i;
                continue;
            }
            for(var j = 0; j < enemies.length; j++) { 
                var enemy = enemies[j];
                var enemyRect = {x: enemy.x - enemy.width/2, y: enemy.y - enemy.height/2, width: enemy.width, height: enemy.height};
                if(hitTestRectangle(laserRect, enemyRect) && laser.good) {
                    enemy.health--;
                    explode(1,{x:laser.x - laser.width/2, y:laser.y - laser.height/2});
                    if(enemy.health <= 0) {
                        explode(20,{x:enemy.x,y:enemy.y});
                    }
                    app.stage.removeChild(laser);
                    lasers.splice(i,1);
                    --i;
                    j = enemies.length;
                    continue;
                }   
            }
        }
        for(var i = 0; i < formations.length; i++) {
            var formation = formations[i];
            var inSight = false;
            var closestEnemy;
            var closestDist = Infinity;
            formation.forEach(function(enemy){
                if(enemy.health >= 0) {
                    if(enemy.x + enemy.width/2 < rocket.x) {
                    } else if(enemy.x - enemy.width/2 > rocket.x) {
                    } else {
                        inSight = true;
                    }
                    if(getDistance(rocket.x,rocket.y, enemy.x, enemy.y) < closestDist) {
                        closestDist = getDistance(rocket.x,rocket.y, enemy.x, enemy.y);
                        closestEnemy = enemy;
                    }
                }
            });
            var movement = {x:0, y:0}
            if(!inSight) {
                if(closestEnemy) {
                    if(closestEnemy.x < rocket.x) {
                        movement.x = 3;
                    } else {
                        movement.x = -3;
                    }
                } else {
                    formations.splice(i,1);
                    --i;
                }
            }
            formation.forEach(function(child){
                child.formationMovement = movement;
            })
        }
        for(var i = 0; i < enemies.length; i++) {
            var enemy = enemies[i];
            if(enemy.health > 0) {
                if(enemy.level === "easy") {
                    if(enemy.y < innerHeight + 200) {
                        enemy.y += 1.5 * difficulty;
                    } else {
                        enemy.y = -400;
                    }
                    if(enemy.x + 5 < rocket.x) {
                        enemy.x += 1.5 * difficulty;
                    } else if(enemy.x - 5 > rocket.x) {
                        enemy.x -= 1.5 * difficulty;
                    } else if(Date.now() - enemy.reloadTime > enemy.lastFire) {
                        shootLaser("bad", {x:enemy.x, y: enemy.y}, pointTowards(enemy.x,enemy.y,rocket.x,rocket.y) * Math.PI/180)
                        enemy.lastFire = Date.now();
                    }
                } else if(enemy.level === "boss1") {
                    if(enemy.y < innerHeight + 200) {
                        enemy.y += 1.5 * difficulty;
                    } else {
                        enemy.y = -400;
                    }
                    if(enemy.x + 15 < rocket.x) {
                        enemy.x += 10;
                    } else if(enemy.x - 15 > rocket.x) {
                        enemy.x -= 10;
                    } else if(Date.now() - enemy.reloadTime > enemy.lastFire) {
                        shootLaser("bad", {x:enemy.x, y: enemy.y}, pointTowards(enemy.x,enemy.y,rocket.x,rocket.y) * Math.PI/180)
                        launchMissile("bad", {x:enemy.x + enemy.width/3, y: enemy.y}, rocket, 7.5)
                        launchMissile("bad", {x:enemy.x - enemy.width/3, y: enemy.y}, rocket, 7.5);
                        enemy.lastFire = Date.now();
                    }
                } else if(enemy.level === "medium") {
                    if(enemy.y < 100) {
                        enemy.y += 1.5 * difficulty;
                    }
                    if(Math.abs(rocket.x - enemy.x) < 300) {
                        if((rocket.x > enemy.x || (innerWidth - rocket.x < 300)) && rocket.x >= 300) {
                            enemy.x -= 3 * difficulty;
                        } else {
                            enemy.x += 3 * difficulty;
                        }
                    }
                    if(Date.now() - enemy.reloadTime > enemy.lastFire) {
                        shootLaser("bad", {x:enemy.x - enemy.width / 3, y: enemy.y}, pointTowards(enemy.x,enemy.y,rocket.x,rocket.y) * Math.PI/180)
                        shootLaser("bad", {x:enemy.x + enemy.width / 3, y: enemy.y}, pointTowards(enemy.x,enemy.y,rocket.x,rocket.y) * Math.PI/180)
                        enemy.lastFire = Date.now();
                    }
                } else if(enemy.level === "boss2") {
                    enemy.rotation = (0-pointTowards(enemy.x,enemy.y,rocket.x,rocket.y)) * Math.PI/180;
                    if(enemy.y < innerHeight/2) {
                        enemy.y += 1.5 * difficulty;
                    }
                    if(Date.now() - enemy.burstRate > enemy.burstFire) {
                        if(Date.now() - enemy.reloadTime > enemy.lastFire) {
                            enemy.bursts--;
                            shootLaser("bad", {x:enemy.x - enemy.width / 3, y: enemy.y}, pointTowards(enemy.x - enemy.width/6,enemy.y,rocket.x,rocket.y) * Math.PI/180);
                            shootLaser("bad", {x:enemy.x + enemy.width / 3, y: enemy.y}, pointTowards(enemy.x + enemy.width/6,enemy.y,rocket.x,rocket.y) * Math.PI/180)
                            enemy.lastFire = Date.now();
                            if(enemy.bursts === 0) {
                                enemy.bursts = 25;
                                enemy.burstFire = Date.now();
                            }
                        }
                    }
                    if(Date.now() - enemy.empRate > enemy.empFire) {
                        --enemy.energy;
                        if(!enemyEMP.visible) {
                            enemyEMP.scale.set(0.5);
                        }
                        enemyEMP.visible = true;
                        enemyEMP.x = enemy.x;
                        enemyEMP.y = enemy.y;
                        enemyEMP.scale.x += 0.1;
                        enemyEMP.scale.y += 0.1;
                        enemyEMP.rotation += 0.1;
                        if(getDistance(rocket.x,rocket.y,enemyEMP.x,enemyEMP.y) < enemyEMP.width/2) {
                            if(!invincible) {
                                healthBar.width -= healthToHit/8;
                            }
                            explode(1,rocket);
                        }
                        if(enemy.energy <= 0) {
                            enemy.energy = innerWidth/10;
                            enemyEMP.visible = false;
                            enemy.empFire = Date.now();
                        }
                    }
                } else if(enemy.level === "drone") {
                    if(enemy.y < innerHeight + 200) {
                        enemy.y += 5 * difficulty;
                    } else {
                        enemy.y = -400;
                    }
                    if(enemy.formationMovement) {
                        enemy.x += enemy.formationMovement.x;
                        enemy.y += enemy.formationMovement.y;
                    }
                    if(Date.now() - enemy.reloadTime > enemy.lastFire) {
                        shootLaser("bad", {x:enemy.x + 10, y: enemy.y}, 180 * Math.PI/180);
                        shootLaser("bad", {x:enemy.x - 10, y: enemy.y}, 180 * Math.PI/180);
                        shootLaser("bad", {x:enemy.x + enemy.width/2, y: enemy.y}, 180 * Math.PI/180);
                        shootLaser("bad", {x:enemy.x - enemy.width/2, y: enemy.y}, 180 * Math.PI/180);
                        enemy.lastFire = Date.now();
                    }
                } else if(enemy.level === "boss3") {
                    if(enemy.y < 100) {
                        enemy.y += 5 * difficulty;
                    }
                    if(enemy.x + enemy.xOffset + 15 < rocket.x) {
                        enemy.x += 2.5;
                    } else if(enemy.x + enemy.xOffset - 15 > rocket.x) {
                        enemy.x -= 2.5;
                    } else if(Date.now() - enemy.reloadTime > enemy.lastFire) {
                        shootLaser("bad", {x:enemy.x + 10, y: enemy.y}, 180 * Math.PI/180);
                        shootLaser("bad", {x:enemy.x - 10, y: enemy.y}, 180 * Math.PI/180);
                        // shootLaser("bad", {x:enemy.x + enemy.width/2, y: enemy.y}, 180 * Math.PI/180);
                        // shootLaser("bad", {x:enemy.x - enemy.width/2, y: enemy.y}, 180 * Math.PI/180);
                        enemy.lastFire = Date.now();
                    }

                    if(Date.now() - enemy.backupRate > enemy.backupFire) {
                        spawnNewFormation("drone", "V", 1);
                        enemy.backupFire = Date.now();
                    }
                    if(Date.now() - enemy.laserRate > enemy.laserFire) {
                        --enemy.energy;
                        enemy.laser.visible = true;
                        enemy.laser.x = enemy.x;
                        enemy.laser.y = enemy.y;
                        var laserRect = {x:enemy.laser.x-25,y:enemy.laser.y,width:50,height:innerHeight*2};
                        var rocketRect = {x: rocket.x - rocket.width/2, y: rocket.y - rocket.height/2, width: rocket.width, height: rocket.height};
                        if(hitTestRectangle(laserRect,rocketRect)) {
                            explode(1,{x:rocket.x,y:rocket.y});
                            if(!invincible) {
                                healthBar.width -= 1;
                            }
                        }
                        if(enemy.energy <= 0) {
                            enemy.laser.visible = false;
                            enemy.energy = 150;
                            enemy.laserFire = Date.now();
                        }
                    }
                }
            } else {
                enemy.alpha -= 0.05;
                enemyEMP.visible = false;
                if (enemy.alpha <= 0) {
                    if(enemy.level === "boss1") {
                        healthBar.width = 200;
                        healthToHit -= 2;
                        energyToFire--;
                        energyBar.width = 200;
                        boss1.fade(0.5,0, 3000);
                        setTimeout(function() {
                            music.fade(0, 0.5, 3000);
                        },3000);
                    }
                    if(enemy.level === "boss2") {
                        healthBar.width = 200;
                        healthToHit -= 2;
                        energyToFire--;
                        energyBar.width = 200;
                        boss2.fade(0.5,0, 3000);
                        setTimeout(function() {
                            music.fade(0, 0.5, 3000);
                        },3000);
                    } else if(enemy.level === "boss3" && enemy.xOffset === 0) {
                        var foundEnemy1 = false;
                        var foundEnemy2 = false;
                        enemies.forEach(function(bad) {
                            if(bad.xOffset === -200) {
                                foundEnemy1 = bad;
                            } else if(bad.xOffset === 200) {
                                foundEnemy2 = bad;
                            }
                        });
                        if(foundEnemy1) {
                            foundEnemy1.xOffset = 0;
                        } else if(foundEnemy2) {
                            foundEnemy2.xOffset = 0;
                        } else {
                            healthBar.width = 200;
                            healthToHit -= 2;
                            energyToFire--;
                            energyBar.width = 200;
                            boss3.fade(0.5,0, 3000);
                            setTimeout(function() {
                                music.fade(0, 0.5, 3000);
                            },3000);
                        }
                    }
                    if(enemy.laser) {
                        enemy.laser.visible = false;
                    }
                    app.stage.removeChild(enemy);
                    enemies.splice(i,1);
                    --i;
                }
            }
        }
        if(enemies.length === 0) {
            ++level;
            difficulty += 0.05;
            if(level < 6) {
                spawnNewEnemy(level, "easy");
            } else if (level < 6.1) {
                spawnNewEnemy(1, "boss1");
                music.fade(0.5,0,2000);
                setTimeout(function(){
                    boss1.play();
                    boss1.fade(0,0.5,2000);
                }, 2000);
            } else if(level < 8) {
                spawnNewEnemy(2, "medium");
            } else if(level < 10) {
                spawnNewEnemy(3, "medium");
            } else if(level < 11) {
                spawnNewEnemy(4, "medium");
            } else if(level < 11.1) {
                spawnNewEnemy(1, "boss2");
                music.fade(0.5,0,2000);
                setTimeout(function(){
                    boss2.play();
                    boss2.fade(0,0.5,2000);
                }, 2000);
            } else if(level < 12) {
                spawnNewFormation("drone", "V", 4);
            } else if(level < 13) {
                spawnNewFormation("drone", "N", 5);
            } else if(level < 14) {
                spawnNewFormation("drone", "V", 7);
            } else if (level < 15) {
                spawnNewFormation("drone", "N", 9);
            } else if(level < 16) {
                spawnNewFormation("drone", "N", 5);
                spawnNewFormation("drone", "V", 5);
            } else if(level < 16.1) {
                music.fade(0.5,0,2000);
                setTimeout(function(){
                    boss3.play();
                    boss3.fade(0,0.5,2000);
                }, 2000);
                spawnNewEnemy(1, "boss3")[0].xOffset = 200;
                spawnNewEnemy(1, "boss3")[0].xOffset = -200;
                spawnNewEnemy(1, "boss3")[0].xOffset = 0;
            } else {
                spawnNewEnemy(level/3.5, "medium");
                spawnNewEnemy(level/3.5, "easy");
            }
        }
        for(var i = 0; i < explosions.length; i++) {
            explosions[i].alpha -= 0.05;
            if(explosions[i].alpha <= 0) {
                app.stage.removeChild(explosions[i]);
                explosions.splice(i,1);
                --i;
            }
        }
    }
    var formations = [];
    function spawnNewFormation(type, formation, endSize) {
        var set = [];
        if(formation === "V") {
            var counter = Math.floor((innerWidth/2-100)/100);
            for(var i = ((Math.ceil(innerWidth/200) * 100 ) -endSize*100); i < innerWidth/2; i+=100) {
                set.push(spawnNewEnemy(1, type, {x:i, y: counter*-100-200})[0])
                --counter;
            }
            // i += 100;
            for(i; i < innerWidth/2 + endSize*100; i += 100) {
                set.push(spawnNewEnemy(1, type, {x:i, y: counter*-100-200})[0])
                ++counter;
            }
        } else if(formation === "N") {
            var counter = Math.floor((innerWidth/2-100)/100);
            for(var i = ((Math.ceil(innerWidth/200) * 100 ) -endSize*100); i < innerWidth/2; i+=100) {
                set.push(spawnNewEnemy(1, type, {x:i, y: counter*-100-200})[0])
                ++counter;
            }
            // i += 100;
            for(i; i < innerWidth/2 + endSize*100; i += 100) {
                set.push(spawnNewEnemy(1, type, {x:i, y: counter*-100-200})[0])
                --counter;
            }
        }
        for(let i = 0; i < set.length; i++) {
            set[i].formation = set;
            set[i].formationMovement = {x:0,y:0};
        }
        console.log(set)
        formations.push(set);
    }
    function spawnNewEnemy(amount, type, position) {
        var y = -200;
        var enemiesAdded = [];
        console.log(amount, type, position);
        for(let i = 0; i < amount; i++) {
            if(type === "easy") {
                var enemy = new Sprite(resources["sprites/enemy.png"].texture);
                app.stage.addChild(enemy);
                enemy.scale.set(3);
                enemy.anchor.set(0.5,0.5);
                if(position) {
                    enemy.x = position.x;
                    enemy.y = position.y;
                } else {
                    enemy.x = randInt(100, innerWidth - 100);
                    enemy.y = y;
                }
                enemy.rotation = Math.PI;
                enemy.health = randInt(0.5,1.5) * difficulty;
                enemy.lastFire = 0;
                enemy.reloadTime = 3000/difficulty;
            } else if (type === "medium") {
                var enemy = new Sprite(resources["sprites/medium.png"].texture);
                app.stage.addChild(enemy);
                enemy.scale.set(3);
                enemy.anchor.set(0.5,0.5);
                if(position) {
                    enemy.x = position.x;
                    enemy.y = position.y;
                } else {
                    enemy.x = randInt(100, innerWidth - 100);
                    enemy.y = y;
                }
                enemy.rotation = Math.PI;
                enemy.health = randInt(5,7) * difficulty;
                enemy.lastFire = 0;
                enemy.reloadTime = 5000/difficulty;
            } else if(type === "boss1") {
                var enemy = new Sprite(resources["sprites/boss1.png"].texture);
                app.stage.addChild(enemy);
                enemy.scale.set(3);
                enemy.anchor.set(0.5,0.5);
                if(position) {
                    enemy.x = position.x;
                    enemy.y = position.y;
                } else {
                    enemy.x = randInt(100, innerWidth - 100);
                    enemy.y = -600;
                }
                enemy.rotation = Math.PI;
                enemy.health = 15 * difficulty;
                enemy.lastFire = 0;
                enemy.reloadTime = 5000/difficulty;
            } else if(type === "boss2") {
                var enemy = new Sprite(resources["sprites/boss2.png"].texture);
                app.stage.addChild(enemy);
                enemy.scale.set(3);
                enemy.anchor.set(0.5,0.5);
                if(position) {
                    enemy.x = position.x;
                    enemy.y = position.y;
                } else {
                    enemy.x = innerWidth/2;
                    enemy.y = -600;
                }
                enemy.rotation = Math.PI;
                enemy.health = 20 * difficulty;
                enemy.burstFire = 0;
                enemy.burstRate = 10000/difficulty;
                enemy.lastFire = Date.now();
                enemy.reloadTime = 100/difficulty;
                enemy.empFire = Date.now();
                enemy.empRate = 17500/difficulty;
                enemy.bursts = 25;
                enemy.energy = innerWidth/10;
            } else if(type === "drone") {
                var enemy = new Sprite(resources["sprites/drone.png"].texture);
                app.stage.addChild(enemy);
                enemy.scale.set(3);
                enemy.anchor.set(0.5,0.5);
                if(position) {
                    enemy.x = position.x;
                    enemy.y = position.y;
                } else {
                    enemy.x = randInt(100, innerWidth - 100);
                    enemy.y = y;
                }
                enemy.rotation = Math.PI;
                enemy.health = randNum(0.1,0.5) * difficulty;
                enemy.lastFire = 0;
                enemy.reloadTime = 3000/difficulty;
            } else if(type === "boss3") {
                var enemy = new Sprite(resources["sprites/boss3.png"].texture);
                app.stage.addChild(enemy);
                enemy.scale.set(3);
                enemy.anchor.set(0.5,0.5);
                if(position) {
                    enemy.x = position.x;
                    enemy.y = position.y;
                } else {
                    enemy.x = randInt(100, innerWidth - 100);
                    enemy.y = -600;
                }
                enemy.rotation = Math.PI;
                enemy.health = 15 * difficulty;
                enemy.lastFire = 0;
                enemy.reloadTime = 5000/difficulty;
                enemy.laserFire = Date.now();
                enemy.laserRate = 10000/difficulty;
                enemy.energy = 150;
                enemy.backupFire = Date.now() - randInt(0, 30000);
                enemy.backupRate = 55000/difficulty;
                enemy.laser = new PIXI.Graphics();
                enemy.laser.beginFill(0xffaaaa);
                enemy.laser.drawRect(-25,0,50, innerHeight * 2);
                app.stage.addChild(enemy.laser);
                enemy.laser.visible = false;
            }
            enemiesAdded.push(enemy);
            enemy.level = type;
            enemies.push(enemy);
            y -= 150 + randInt(25,100);
        }
        return enemiesAdded;
    }
    function launchMissile(type, position, target, speed) {
        if(type === "good") {
            var laser = new Sprite(resources["sprites/missile.png"].texture);
            laser.good = true;
        } else {
            /// TODO: Red
            var laser = new Sprite(resources["sprites/missile.png"].texture);
            laser.good = false;
        }
        laser.speed = speed;
        laser.x = position.x;
        laser.y = position.y;
        laser.anchor.set(0.5,0.5);
        if(type === "good") {
            laser.health = 300;
        } else {
            laser.health = 200;
        }
        laser.target = target;
        missiles.push(laser);
        app.stage.addChild(laser);
    }
    function shootLaser(type, position, dir) {
        if(type === "good") {
            var laser = new Sprite(resources["sprites/laser.png"].texture);
            laser.good = true;
        } else {
            /// TODO: Red
            var laser = new Sprite(resources["sprites/enemy-laser.png"].texture);
            laser.good = false;
        }
        laser.x = position.x;
        laser.y = position.y;
        laser.anchor.set(0.5,0.5);
        laser.scale.set(3);
        laser.rotation = -dir;
        lasers.push(laser);
        app.stage.addChild(laser);
    }
    function press(key){
        if(keys[key]){
            keys[key] = false;
            return true;
        }
        return false;
    }
    addEventListener("mousedown",function(e){
        if(e.button == 0) {
            keys.mouse = true;
        } else if(e.button == 2) {
            keys.rightMouse = true;
        }
        mouseX = e.pageX;
        mouseY = e.pageY;
    });
    addEventListener("mouseup",function(e){
        if(e.button == 0) { 
            keys.mouse = false;
        } else if(e.button == 2) {
            keys.rightMouse = true;
        }
    });
    addEventListener("blur", function (){
        keys = {};
    });
    addEventListener("mousemove",function(e){
        mouseX = e.pageX;
        mouseY = e.pageY;
    });
    var learnSpeed = 2;
    var answersLocked = false;
    var code = ["R", "E", "S", "T", "O", "R", "E"];
    var codeNum = 0;
    addEventListener("keydown", function (e){
        if(code[codeNum] === e.key) {
            ++codeNum;
            if(codeNum === code.length) {
                codeNum = 0;
                healthBar.width = 200;
                energyBar.width = 200;
                if(!invincible) {
                    invincible = true;
                    rocket.alpha = 0.5;
                    setTimeout(function() {
                        invincible = false;
                        rocket.alpha = 1;
                    }, 5000);
                }
            }
        }
        if(!answersLocked && ((Number(e.key) >= 0 && e.key !== " ") || e.key === "." || e.key === ":")) {
            numDiv.innerHTML += e.key;
        }
        if(e.key === "Enter" && !answersLocked) {
            if (numDiv.innerHTML === correctAnswer || (correctAnswer.split(".")[1] === numDiv.innerHTML) || numDiv.innerHTML.replace(" ",".") === correctAnswer || numDiv.innerHTML.replace(":",".") === correctAnswer) { 
                if(energyBar.width + 40 > 200) {
                    healthBar.width += (energyBar.width + 40 - 200)/3;
                    energyBar.width = 200;
                } else {
                    energyBar.width += 40;
                }
                if(healthBar.width > 200) {
                    healthBar.width = 200;
                }
                numDiv.innerHTML = "";
                --questionsLeft;
                if(questionsLeft <= 0) {
                    var range = rangeDiv.innerHTML;
                    var full = true;
                    if(range.split("-")[0] === "1") {
                        var arr = range.split(/\-|\,/);
                        if(Number(arr[1]) + 3 < rom18[chapter-1].length) {
                            range = (Number(arr[1])) + "-" + (Number(arr[1]) + 3);
                        } else if(Number(arr[1]) < rom18[chapter-1].length) {
                            range = arr[1] + "-" + rom18[chapter-1].length;
                        } else {
                            range = "";
                        }
                        full = false;
                    } else {
                        var arr = range.split(/\-|\,/);
                        range = "1-" + arr[1];
                    }
                    rangeDiv.innerHTML = range;
                    var cur = range.split(/\-|\,/);
                    if(Number(cur[0]) < Number(cur[1]) && Number(cur[0]) >= 0) {
                        if(Number(cur[1]) <= rom18[chapter-1].length) {
                            params.min = cur[0];
                            params.max = cur[1];
                        }
                    }
                    if(full) {
                        questionsLeft = params.max/learnSpeed;
                    } else {
                        questionsLeft = params.max/(2*learnSpeed);
                    }
                }
            } else {
                answersLocked = true;
                numDiv.style.color = "red";
                var corAns = correctAnswer;
                setTimeout(function() {
                    numDiv.style.color = "green";
                    numDiv.innerHTML = corAns;
                },1000);
                setTimeout(function() {
                    numDiv.style.color = "white";
                    numDiv.innerHTML = "";
                    answersLocked = false;
                },2000);
            }

            curVerse = randVerse();
            correctAnswer = curVerse[0];
            curVerse = curVerse[1];
            textDiv.innerHTML = curVerse;
        }
        if(e.key === "Delete" || e.key === "Backspace") {
            numDiv.innerHTML = "";
        }
        keys[e.key] = true;
    });
    addEventListener("keyup", function (e){
        keys[e.key] = false;
    });
  </script>
</body>
</html>