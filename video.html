<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>Blob Adventures 3</title>
</head>
<style>
    * {
        padding: 0;
        margin: 0
    }
</style>
<script src="pixi/pixi.min.js"></script>
<script src="usefulFunctions.js"></script>
<body>
    <script type="text/javascript">
        PIXI.utils.skipHello();
        PIXI.settings.SCALE_MODE = PIXI.SCALE_MODES.NEAREST;
        let Application = PIXI.Application,
            Container = PIXI.Container,
            loader = PIXI.loader,
            resources = PIXI.loader.resources,
            TextureCache = PIXI.utils.TextureCache,
            Sprite = PIXI.Sprite,
            Rectangle = PIXI.Rectangle,
            Graphics = PIXI.Graphics;
        let app = new Application({
            width: 800,
            height: 800,
            antialias: true,
            transparent: false,
            resolution: 1
        }
        );
        app.renderer.backgroundColor = 0x55DD55;
        /// Fill the screen 
        app.renderer.view.style.position = "absolute";
        app.renderer.view.style.display = "block";
        app.renderer.autoResize = true;
        app.renderer.resize(window.innerWidth, window.innerHeight);
        document.body.appendChild(app.view);
        loader.add("sprites/redeye.png").add("sprites/horns.png")
        loader.add("sprites/sword.png").add("sprites/helmet.png").add("sprites/breastplate.png").add("sprites/misc.png").add("sprites/spear.png").add("sprites/mace.png").add("sprites/axe.png");
        loader.add("sprites/treasureHunter.json").add("sprites/house1.png").add("sprites/house2.png").add("sprites/house3.png").add("sprites/arrow.png").add("sprites/brownarrow.png").load(setup);
        var params = getParams();
        var mapScene, battleScene;
        function getParams() {
            var params = {};
            location.search.substr(1).split("&").forEach(function (el) {
                var data = el.replace(/\+/g, " ").split("=");
                params[decodeURIComponent(data[0])] = data[1] ? decodeURIComponent(data[1]) : true;
            });
            return params;
        }
        var chosenTown = {};
        var blue = new PIXI.TextStyle({ stroke: "blue", fill: "blue" });
        var state;
        var newText;
        var keys = {};
        var id;
        var battleThisTurn = false;
        var blobs = [];
        var soldiers = [];
        var arrows = [];
        var chosenBlobArmy;
        var knightHp = 2;
        var knightDmg = 2;
        var blobHp = 5;
        var boulders = 0;
        var blobDmg = 2;
        var calendar = 1;
        var calText;
        var inputs = {};
        var waves = [function(){
            spawnBlobArmy(0, -1, "very large");
            spawnBlobArmy(3,-1,"vv large");
            spawnBlobArmy(7,-1, 120,9);
            spawnBlobArmy(1, -1, "very large");
            spawnBlobArmy(4,-1,"vv large");
            spawnBlobArmy(6,-1, 120,0,10);
            spawnBlobArmy(2, -1, "vv large");
            spawnBlobArmy(5,-1, 120,15);
        },
        function(){
            spawnBlobArmy(0, -1, "small",100);
            spawnBlobArmy(3,-1,"medium",15);
            spawnBlobArmy(7,-1, 40,26,4);
            spawnBlobArmy(1, -1, "small",7);
            spawnBlobArmy(4,-1,"medium",100);
            spawnBlobArmy(6,-1, 40,10,10);
            spawnBlobArmy(2, -1, "small",100);
            spawnBlobArmy(5,-1, 40,29);
        },
        function(){
            spawnBlobArmy(0, -1, "very large",50,10);
            spawnBlobArmy(3,-1,"vv large",50,20);
            spawnBlobArmy(7,-1, 100,54,8);
            spawnBlobArmy(1, -1, "very large",100);
            spawnBlobArmy(4,-1,"vv large",100);
            spawnBlobArmy(6,-1, 100,40,10);
            spawnBlobArmy(2, -1, "very large",50,20);
            spawnBlobArmy(5,-1, 100,78,30);
        },
        function(){
            spawnBlobArmy(0, -1, "small",0,100);
            spawnBlobArmy(3,-1,"medium",15,10);
            spawnBlobArmy(7,-1, 40,4,26);
            spawnBlobArmy(1, -1, "small",0,100);
            spawnBlobArmy(4,-1,"medium",0,100);
            spawnBlobArmy(6,-1, 40,10,30);
            spawnBlobArmy(2, -1, "small",0,200);
            spawnBlobArmy(5,-1, 40,5,29);
        },
        function(){
            spawnBlobArmy(0, -1, "very large",0,1000);
            spawnBlobArmy(3,-1,"vv large",15,100);
            spawnBlobArmy(7,-1, 120,30,50);
            spawnBlobArmy(1, -1, "very large",0,1000);
            spawnBlobArmy(4,-1,"vv large",0,100);
            spawnBlobArmy(6,-1, 120,10,100);
            spawnBlobArmy(2, -1, "very large",0,2000);
            spawnBlobArmy(5,-1, 120,5,100);
        },
        ];
        function mapIncludes(x, y) {
            v = false;
            blobArmies.forEach(function (blob) {
                if (blob.mapX === x && blob.mapY === y) {
                    v = true;
                }
            });
            return v;
        }
        var taxButton, recruitButton, leaveButton, buyButton;
        var mouseModes = [{ name: "Volley", effect: function () { fireArrows() } }, { name: "Targeted Fire", effect: function () { guideArrows() } }, {
            name: "Fire Catapult", effect: function () {
                if (boulders > 0) {
                    --boulders;
                    let blobsKilled = 0;
                    noFireCatapult = false;
                    // console.log("Went off 1")
                    blobs.forEach(function (blob) {
                        if (blobsKilled < 50 && getDistance(blob.x, blob.y, mouseX, mouseY) <= 100) {
                            blob.health = 0;
                            // console.log("Went off 2");
                            ++blobsKilled;
                        }
                    });
                }
            }
        }];
        if (params.slowTick === true || params.slowTick === "true") {
            params.slowTick = 1;
        }
        var mouseMode = 1;
        var eventText;
        var knightNum = 0;
        var archerNum = 0;
        var arrows = 0;
        var firedArrows = [];
        var blobNum = 2;
        var catapult;
        var cooldown = 0;
        var catapultSize = 100;
        var lastSec = 0;
        var myArmy;
        var blobArmySplice = false;
        var townSplice = false;
        var makeTowns = [{ x: 0, y: 2, pop: 125 * 2, name: "Thrugsford"}, { x: 6, y: 6, pop: 125 * 2, name: "Bronsburg"},{ x: 4, y: 3, pop: 100 * 2, name: "Villsville"}, { x: 2, y: 4, pop: 125 * 2, name: "Fordstone"},{ x: 3, y: 7, pop: 400 * 2, name: "Kingsville"},{ x: 3, y: 0, pop: 300 * 2, name: "Royal Guard"},{ x: 0, y: 6, pop: 500 * 2, name: "Merchant's lair"},{ x: 7, y: 2, pop: 200 * 2, name: "Xitown"}];
        var towns = [];
        var gold = 750;
        var blobArmies = [];
        var updateStats = true;
        var helmets = 0;
        var breastplates = 0;
        var misc = 0;
        var spears = 0;//randInt(10,15);
        var swords = 0;//randInt(23,30);
        var maces = 0;//randInt(13,20);
        var axes = 0;//randInt(13,20);
        var mouseX = 0;
        var mouseY = 0;
        var rallyButton;
        var prices = {
            sword:25,
            mace:20,
            axe:15,
            spear:10,
            helmet:30,
            breastplate:50,
            misc:20
        };
        var leftReady = true;
        var rightReady = true;
        var turn = 0;
        var maxSpacing = (innerWidth - 400) / 8;
        var textInfo = 2;
        var reputation = 0;
        var soldierRep = 0;
        maxSpacing = maxSpacing < (innerHeight) / 8 ? maxSpacing : (innerHeight - 100) / 8;
        var neededSpacing;
        var slowTickSec = Date.now();
        var townScene;
        var merchant = true;
        var market = true;
        var textStyle = new PIXI.TextStyle({ stroke: "white", fill: "white" });
        var townIn;
        if(params.health || params.dmg || params.damage) {
            params.debug = true;
        }
        var noFireCatapult = true;
        function setup() {
            mapScene = new Container();
            battleScene = new Container();
            townScene = new Container();
            townScene.visible = false;
            app.stage.addChild(townScene)
            app.stage.addChild(mapScene);
            app.stage.addChild(battleScene);
            calText = new PIXI.Text(calendar);
            mapScene.addChild(calText);
            calText.x = innerWidth - 100;
            battleScene.visible = true;
            catapult = new Graphics();
            battleScene.addChild(catapult);
            taxButton = new PIXI.Text("TAX",textStyle);
            taxButton.y = 500;
            townScene.addChild(taxButton);
            recruitButton = new PIXI.Text("Recruit",textStyle);
            recruitButton.y = 500;
            recruitButton.x = 150;
            townScene.addChild(recruitButton);
            rallyButton = new PIXI.Text("Hire 10 Mercenaries",textStyle);
            rallyButton.y = 500;
            rallyButton.x = 700;
            townScene.addChild(rallyButton);
            leaveButton = new PIXI.Text("Leave Town",textStyle);
            leaveButton.y = 500;
            leaveButton.x = 300;
            townScene.addChild(leaveButton);
            buyButton = new PIXI.Text("To Market",textStyle);
            buyButton.y = 500;
            buyButton.x = 550;
            townScene.addChild(buyButton);
            id = resources["sprites/treasureHunter.json"].textures;
            myArmy = new Sprite(id["explorer.png"]);
            mapScene.addChild(myArmy);
            myArmy.visible = false;
            eventText = new PIXI.Text("", textStyle);
            app.stage.addChild(eventText);
            state = intro;
            app.ticker.add(delta => gameLoop(delta));
        }
        function intro() {
            app.renderer.backgroundColor = 0x00000;
            eventText.text = "Press Enter to start. Press S to speed up. Press D to slow down.\nAh, Sir Knight! The king has chosen you for a very important mission.\nRemember Blob Adventures 2, and how you captured back 5 treasures?\nWell, it turns out that the blob's weren't so happy about that. Who would have thought?\nApparently, they had just found someone that would sell them stinky socks.\nSo, can you guess what happened? Yep, they attacked.\nRemember all those frigates that held the treasure? Now they hold blobs and are sending out their armies.\nIt wouldn't have been so bad if we had any scouts to keep watch. They were caught in a traffic jam.\nThe POINT is, now we are under attack by the blobs. You will have to save the countryside.\nThe king quickly gave the command of all the forces he had on had to you.\nUnfortunately, there was a big battle and there were only a few left.\nYou have 20 knights, 1 archer, and 1 catapult. You also have 24 arrows, but no ammo for the catapult.\nI have to teach you how to command your army. Unless you know, of course, in which case hit Enter or click.\nYou move your small character representing your army around the map by clicking in a direction.\nYou can move left, right, up, down, or diagonally, but only 1, so don't go on a detour.\nThe small blob figures represent blob armies. They will have blobs that you must fight.\nYour knights are much, much weaker than the blobs. 3 knights perhaps could beat 1 blob.\nHowever, don't despair. The knights can equip weapons and armor. This makes their damage and health go up.\nYou can buy weapons and armor at a town. If you have more weapons or armor than soldiers, it will be saved.\nHowever, if you don't have enough weapons or armor for all of your soldiers, the front line will take them.\nYou can expect to get back at least half of the loot of your fallen. Armor won't be lost unless its bearer dies.\nIf blob armies have armor, you may get that if you defeat them. You may also loot off blobs too sometimes.\n\nIf you move into a blob army, you will immediately do battle. Your knights will deploy to fight the blobs.\nYou are powerless to control the knights, but the archers and the catapults you may by clicking.\nThere are certain actions you may do. You may issue a volley, where the arrows go straight...\n or a targeted fire, where the archers fire towards your mouse. This of course costs arrows.\nYou can also fire your catapult if you have a boulder, and that destroys many blobs within a certain radius.\nTo do this, you must select a mode by pressing Left and Right or scrolling up and down.\nThen click to fire off the event. Arrows will fire if you have any, or a catapult will launch if you have boulders.\nProtect the towns, represented by houses. They may have a small local militia, but are unable to stand on their own.\nYou can buy arrows and boulders there with gold you gained from the blobs, and you can try to raise militia too.\nIf the blobs destroy all the towns or make it to the bottom, all is lost. Don't let that happen.\nGo forth, and save the kingdom!";
            eventText.y = innerHeight;
            state = introWait;
        }
        function introWait() {
            if (keys["d"]) {
                eventText.y -= 0.5;
            } else if (keys["s"]) {
                eventText.y -= 5;
            } else {
                eventText.y -= 2.5;
            }
            if (keys.Enter || keys.mouse) {
                keys.mouse = false;
                state = mapSetup;
                eventText.y = 0;
                app.renderer.backgroundColor = 0x55DD55;
            }
        }
        function numberOfBlobs() {
            var v = 0;
            for (let i = 0; i < blobs.length; i++) {
                if (blobs[i].state) {
                    ++v;
                }
            }
            return v;
        }
        function numberOfKnights() {
            var v = 0;
            for (let i = 0; i < soldiers.length; i++) {
                if (soldiers[i].state) {
                    ++v;
                }
            }
            return v;
        }
        function mapSetup() {
            myArmy.mapX = 7;
            myArmy.mapY = 7;
            myArmy.x = (myArmy.mapX * maxSpacing) + 400;
            myArmy.y = (myArmy.mapY * maxSpacing) + 100;
            myArmy.visible = true;
            spawnBlobArmy(0, -1, "small");
            spawnBlobArmy(3,-1,"medium");
            spawnBlobArmy(7,-1, 40,3);
            spawnBlobArmy(1, -1, "small",1);
            spawnBlobArmy(4,-1,"medium",5);
            spawnBlobArmy(6,-1, 40,0,5);
            spawnBlobArmy(2, -1, "small");
            spawnBlobArmy(5,-1, 40,3);
            spawnTowns();
            state = map;
        }
        function spawnBlobArmy(x, y, num,redeye,horns) {
            if (num === "small") {
                num = randInt(10, 20);
            } else if (num === "medium") {
                num = randInt(21, 40);
            } else if (num === "large") {
                num = randInt(41, 60);
            } else if (num === "very large") {
                num = randInt(61,80);
            } else if (num === "vv large") {
                num = randInt(81,100)
            }
            var newBlobArmy = new Sprite(id["blob.png"]);
            mapScene.addChild(newBlobArmy);
            newBlobArmy.mapX = x;
            newBlobArmy.mapY = y;
            newBlobArmy.x = (newBlobArmy.mapX * maxSpacing) + 400;
            newBlobArmy.y = (newBlobArmy.mapY * maxSpacing) + 100;
            newBlobArmy.num = num;
            newBlobArmy.scale.set(1 + num / 100);
            if(horns) {
                newBlobArmy.horns = horns;
            }
            if(redeye) {
                newBlobArmy.redeye = redeye;
            }
            blobArmies.push(newBlobArmy);
        }
        function map() {
            battleThisTurn = false;
            /// Update stats if mouse down
            if(blobArmies.length < 1 && calendar > 15*5) {
                state = winning;
            }
            if(keys.mouse) {
                updateStats = true;
            }
            /// Place towns
            towns.forEach(function (town) {
                // console.log(town.mapX,town.mapY);
                town.x = (town.mapX * maxSpacing) + 400;
                town.y = (town.mapY * maxSpacing) + 100;
            });
            /// Turns
            if (turn > 9) {
                calText.text = calendar.toString();
                updateStats = false;
                if (Date.now() - 1000 > lastSec) {
                    turn -= 10;
                    updateStats = true;
                }
            }
            /// Stats
            if(updateStats) {
                updateStats = false;
                if(textInfo === 1) {
                    eventText.text = "Soldiers: "+knightNum.toString() + "\nSwords: "+swords.toString()+"\nMaces: "+maces.toString() + "\nLight Axes: "+axes.toString() + "\nSpears: "+spears.toString()+"\nHelmets: "+helmets.toString()+"\nBreastplates: "+breastplates.toString()+"\nOther:"+misc.toString()+"\nArchers: "+archerNum.toString()+"\nArrows: "+arrows.toString()+"\nBoulders: "+boulders.toString()+"\nGold:"+gold.toString()+"\nArmies left: " +blobArmies.length.toString();
                    if(keys.mouse && mouseX < 150 && mouseY < 365) {
                        keys.mouse = false;
                        ++textInfo;
                    }
                } else if(textInfo === 0){
                    if(keys.mouse && mouseX < 150 && mouseY < 75) {
                        keys.mouse = false;
                        ++textInfo;
                    }
                    eventText.text = "Soldiers: "+knightNum.toString() + "\nArmies left: " + blobArmies.length.toString() + "\nGold: " + gold.toString();
                } else if(textInfo === 2) {
                    var fullClad = Math.min(knightNum,helmets,breastplates,misc,(spears+swords+maces+axes));
                    var avgHealth = 0;
                    var avgDmg = 0;
                    let countSwords = swords;
                    let countAxes = axes;
                    let countMaces = maces;
                    let countSpears = spears;
                    for(let i = 0; i < knightNum; i++) {
                        let curHp = 2;
                        if(i < breastplates) {
                            curHp += 6;
                        }
                        if(i < helmets) {
                            curHp += 3;
                        }
                        if(i < misc) {
                            curHp += 4;
                        }
                        avgHealth += curHp;
                        let curDmg = 2;
                        if(i < swords) {
                            curDmg += 2;
                        } else if(i < swords + maces) {
                            curDmg += 3;
                        } else if(i < swords + maces + axes) {
                            curDmg += 4;
                        } else if(i < swords + maces + axes + spears) {
                            curDmg += 2;
                        }
                        avgDmg += curDmg;
                    }
                    avgHealth /= knightNum;
                    avgHealth *= 100;
                    avgHealth = Math.round(avgHealth);
                    avgHealth /= 100;
                    avgDmg /= knightNum;
                    avgDmg *= 100;
                    avgDmg = Math.round(avgDmg);
                    avgDmg /= 100;
                    var blobKnightRatio = 0;
                    /// Simulate a knight battling blobs
                    let simKnight = {health:avgHealth,dmg:avgDmg};
                    let simBlob = {health:blobHp,dmg:blobDmg};
                    let blobsKilled = 0;
                    while(simKnight.health > 0) {
                        simBlob.health -= simKnight.dmg;
                        simKnight.health -= simBlob.dmg;
                        if(simBlob.health < 0.001) {
                            simBlob = {health:blobHp,dmg:blobDmg};
                            ++blobsKilled;
                        }
                    }
                    Math.round2 = function(decimal,toPlace){
                        // console.log("1",decimal);
                        toPlace = toPlace || 100;
                        decimal *= toPlace;
                        decimal = Math.round(decimal);
                        decimal /= toPlace;
                        // console.log("2",decimal);
                        return decimal;
                    }
                    if(simBlob.health < 5) {
                        blobsKilled += (5-simBlob.health)/5;
                    }
                    let gangUpKilled = 0;
                    for(let i = 1; i < 10; i++) {
                        simKnight = {health:avgHealth,dmg:avgDmg};
                        simBlob = {health:blobHp * i,dmg:blobDmg * i};
                        while(simKnight.health > 0) {
                            simKnight.health -= simBlob.dmg;
                            simBlob.health -= simKnight.dmg;
                            if(simBlob.health <= 0) {
                                gangUpKilled = i;
                            }
                        }
                    }
                    if(simBlob.health > 0) {
                        gangUpKilled += 0.5;
                    }
                    var maxBlobNum = 0;
                    maxBlobNum += boulders > 0?25:0;
                    maxBlobNum += arrows / 2.5;
                    eventText.text = "Soldiers: "+knightNum.toString() + "\nArchers: " + archerNum.toString() + "\nFull clad: " + fullClad.toString() + "\nAverage health: " + Math.round2(avgHealth,100).toString() + "\nAverage damage: " + Math.round2(avgDmg,100).toString() + "\nKnight-blob-ratios:\nOne-by-one: " + Math.round2(blobsKilled).toString() + "\nGang-up: " + Math.round2(gangUpKilled,100).toString() + "\nMax Blobs Killed:\n1: " + Math.round2((maxBlobNum + (knightNum * blobsKilled)),100).toString() + "\n2: "+Math.round2((maxBlobNum + (knightNum * gangUpKilled))).toString();
                    if(keys.mouse && mouseX < 150 && mouseY < 365) {
                        keys.mouse = false;
                        textInfo = 3;
                    }
                } else if(textInfo === 3) {
                    eventText.text = "";
                    for(let i = 0; i < towns.length; i++) {
                        eventText.text += towns[i].name + ":" + " " + towns[i].militia + "\n";
                    }
                    // eventText.text = "Reputation:" + "\nSoldier:" + soldierRep.toString() + "\nVillager:" + reputation.toString();
                    if(keys.mouse && mouseX < 150 && mouseY < 365) {
                        keys.mouse = false;
                        textInfo = 0;
                    }
                }
            }
            /// Blob's turn
            if (turn === 1) {
                blobArmies.forEach(function (blobArmy) {
                    /// Chose a random action
                    var action = randInt(0, 5);
                    if (action === 0) {
                        /// Move straight down
                        /// If we are gonna fight
                        if((blobArmy.mapX == myArmy.mapX && blobArmy.mapY + 1 === myArmy.mapY) || coordOnTown(blobArmy.mapX,blobArmy.mapY+1)) {
                            if(battleThisTurn == false) {
                                if (!mapIncludes(blobArmy.mapX, blobArmy.mapY + 1)) {
                                    blobArmy.mapY++;
                                }
                            }
                        } else {
                            if (!mapIncludes(blobArmy.mapX, blobArmy.mapY + 1)) {
                                blobArmy.mapY++;
                            }
                        }
                    } else if (action === 1) {
                        var moveX = myArmy.mapX > blobArmy.mapX ? 1 : myArmy.mapX < blobArmy.mapX ? -1 : 0;
                        var moveY = myArmy.mapY > blobArmy.mapY ? 1 : myArmy.mapY < blobArmy.mapY ? -1 : 0;
                        if(!coordOnTown(blobArmy.mapX + moveX,blobArmy.moveY + moveY) || battleThisTurn == false) {
                            if (!mapIncludes(blobArmy.mapX + moveX, blobArmy.mapY + moveY)) {
                                blobArmy.mapX += moveX;
                                blobArmy.mapY += moveY;
                            }
                        }
                    } else if((action === 2 || (action < 4 && calendar > 15 && calendar < 30)) && battleThisTurn === false) {
                        /// Move towards the nearest town
                        var town = getNearestTown(blobArmy.mapX,blobArmy.mapY);
                        var moveX = town.mapX > blobArmy.mapX ? 1 : myArmy.mapX < blobArmy.mapX ? -1 : 0;
                        var moveY = town.mapY > blobArmy.mapY ? 1 : myArmy.mapY < blobArmy.mapY ? -1 : 0;
                        if (!mapIncludes(blobArmy.mapX + moveX, blobArmy.mapY + moveY) && (!coordOnTown(blobArmy.mapX + moveX,blobArmy.mapY + moveY) || battleThisTurn == false)) {
                            blobArmy.mapX += moveX;
                            blobArmy.mapY += moveY;
                        }
                        keys.mouse = false;
                    }
                    if(coordOnTown(blobArmy.mapX,blobArmy.mapY)) {
                        battleThisTurn = true;
                    }
                    blobArmy.x = (blobArmy.mapX * maxSpacing) + 400;
                    blobArmy.y = (blobArmy.mapY * maxSpacing) + 100;
                });
                blobArmies.forEach(function (blobArmy, I) {
                    var saveI = I;
                    if (blobArmy.mapX == myArmy.mapX && blobArmy.mapY === myArmy.mapY) {
                        // console.log("1")
                        state = videoStartup;
                        mapScene.visible = false;
                        battleScene.visible = true;
                        blobArmySplice = I;
                        blobNum = blobArmy.num;
                    } else {
                        towns.forEach(function(town,i){
                            if (blobArmy.mapX == town.mapX && blobArmy.mapY === town.mapY) {
                                // console.log(2)
                                state = townBattleStartup;
                                mapScene.visible = false;
                                battleScene.visible = true;
                                blobArmySplice = I;
                                blobNum = blobArmy.num;
                                townNum = town.militia;
                                townSplice = i;
                                chosenTown = town;
                                chosenBlobArmy = blobArmy;
                            } 
                        });
                    }
                });
                function coordOnTown(x,y){
                    towns.forEach(function(town,i){
                        if (x == town.mapX && y === town.mapY) {
                            return true;
                        } 
                    });
                    return false;
                }
                turn = 10;
            }
            if (keys.mouse) {
                keys.mouse = false;
                if (turn === 0) {
                    ++calendar;
                    if(calendar % 15 == 0 && (calendar/15)-1 < waves.length) {
                        // console.log(waves[calendar/10],calendar,calendar/10)
                        waves[(calendar/15)-1]();
                        for(let i = 0; i < towns.length; i++) {
                            if(towns[i].name == "Royal Guard") {
                                towns[i].militia += 50;
                            }
                        }
                    }
                    turn = 11;
                    eventText.text = "Blob's turn";
                    let luck = randInt(1,50);
                    if(luck < 5) {
                        if(luck === 1) {
                            gold += 100;
                        } else if(luck === 2) {
                            arrows += 24*4;
                        } else if(luck === 3) {
                            swords += 3;
                            spears += 3;
                            maces += 3;
                            axes += 3;
                        } else if(luck === 4) {
                            helmets += 3;
                            breastplates += 3;
                            misc += 3;
                        } else if(luck === 5) {
                            boulders += 5;
                        }
                    }
                    lastSec = Date.now();
                    /// What direction are we closest to? 0,45,90,135,180,225,270,315, or 360, which is 0.
                    var closestDir = 0;
                    var pointingDir = pointTowards(myArmy.x, myArmy.y, mouseX, mouseY);
                    if (pointingDir < 0) {
                        pointingDir += 360;
                    }
                    var closestDiff = Infinity;
                    var directions = [0, 45, 90, 135, 180, 225, 270, 315, 360];
                    for (let i = 0; i < directions.length; i++) {
                        if (Math.abs(pointingDir - directions[i]) < closestDiff) {
                            closestDiff = Math.abs(pointingDir - directions[i]);
                            closestDir = directions[i];
                        }
                    }
                    if (closestDir === 270) {
                        myArmy.mapX++;
                    } else if (closestDir === 315) {
                        myArmy.mapX++;
                        myArmy.mapY--
                    } else if (closestDir === 360 || closestDir === 0) {
                        myArmy.mapY--;
                    } else if (closestDir === 45) {
                        myArmy.mapX--;
                        myArmy.mapY--;
                    } else if (closestDir === 90) {
                        myArmy.mapX--;
                    } else if (closestDir === 135) {
                        myArmy.mapX--;
                        myArmy.mapY++;
                    } else if (closestDir === 180) {
                        myArmy.mapY++;
                    } else if (closestDir === 225) {
                        myArmy.mapX++;
                        myArmy.mapY++;
                    }
                    myArmy.x = (myArmy.mapX * maxSpacing) + 400;
                    myArmy.y = (myArmy.mapY * maxSpacing) + 100;
                    blobArmies.forEach(function (blobArmy, i) {
                        if (blobArmy.mapX == myArmy.mapX && blobArmy.mapY === myArmy.mapY) {
                            state = videoStartup;
                            mapScene.visible = false;
                            battleScene.visible = true;
                            blobArmySplice = i;
                            blobNum = blobArmy.num;
                        }
                    });
                    if(state === map) {
                        towns.forEach(function (town, i) {
                            if (town.mapX == myArmy.mapX && town.mapY === myArmy.mapY) {
                                state = townSetup;
                                townIn = town;
                                mapScene.visible = false;
                                townScene.visible = true;
                            }
                        });
                    }
                }
            }
        }
        function spawnTownSoldiers() {
            var lineMax = Math.floor(innerWidth / 50);
            /// Any amount less than lineMax will work.
            var linesNeeded = Math.ceil(chosenTown.militia / lineMax);
            for (let i = linesNeeded - 1; i >= 0; i--) {
                if (chosenTown.militia >= lineMax) {
                    spawnSoldiers(lineMax, innerHeight - ((i + 1) * neededSpacing),true);
                    chosenTown.militia -= lineMax;
                } else {
                    spawnSoldiers(chosenTown.militia, innerHeight - ((i + 1) * neededSpacing),true);
                    chosenTown.militia = 0;
                }
            }
            keys.mouse = false;
        }
        function townBattleStartup() {
            let blobLineMax = Math.floor(innerWidth / 50);
            let blobLinesNeeded = Math.ceil(blobNum / blobLineMax);
            let knightLineMax = Math.floor(innerWidth / 50);
            let knightLinesNeeded = Math.ceil(chosenTown.militia / knightLineMax);
            let totalLinesNeeded = knightLinesNeeded + blobLinesNeeded + 5;
            neededSpacing = innerHeight / totalLinesNeeded;
            if (neededSpacing > 100) {
                neededSpacing = 100;
            }
            spawnAllBlobs();
            spawnTownSoldiers();
            // state = play
            state = townBattle;
        }
        function getNearestTown(x,y) {
            var dist = Infinity;
            var id;
            towns.forEach(function(town){
                if(getDistance(town.mapX,town.mapY,x,y) < dist) {
                    dist = getDistance(town.mapX,town.mapY,x,y);
                    id = town;
                }
            });
            return id;
        }
        function townSetup() {
            taxButton.visible = true;
            leaveButton.visible = true;
            recruitButton.visible = true;
            rallyButton.visible = true;
            eventText.x = innerWidth / 2;
            eventText.anchor.set(0.5,0);
            eventText.text = "You are in the town of " + townIn.name + ", population " + townIn.pop.toString() + ".";
            eventText.text += "\nMilitia in the town is " + townIn.militia.toString() + " at the moment. May be attacked.";
            eventText.text += "\nYou can recruit some of the fighting men, and possibly some eager others.";
            eventText.text += "\nRecruit by hitting the " + '"Recruit"' + " button or the Hire 10 Mercenaries button."
            eventText.text += "\nYou will get soldiers based on reputation. Hire 10 Mercenaries makes it be more likely that they have weapons.";
            eventText.text += "\nReputation helps you get recruits and get goods. High reputation means people favor you.";
            eventText.text += "\nBuy goods for gold too. Boulders and arrows are projectiles, swords and helmets are knight equippables.";
            eventText.text += "\nGet gold from looting blobs OR hitting the TAX button. TAX decreases your reputation.";
            eventText.text += "\nProtect towns too. They will be targeted by blobs and destroyed if the militia fail.";
            eventText.text += "\nLeave the town by hitting the Leave Town button. Have fun in " + townIn.name.toString() + "!";
            app.renderer.backgroundColor = 0x777700;
            state = townEntered;
        }
        function townEntered() {
            if(keys.mouse) {
                if(townIn.name == "Merchant's lair") {
                    merchant = false;
                }
                /// Mouse has been pressed
                if(mouseX < 50 && mouseY < 525 && mouseY > 500 && taxButton.visible) {
                    /// TAX
                    reputation--;
                    let taxed = townIn.pop + (townIn.pop * reputation * 0.4)>0?townIn.pop + (townIn.pop * reputation * 0.4):0; 
                    gold += taxed;
                    if(taxed > 0) {
                        newText = new PIXI.Text("You taxed the people of " +townIn.name+" for " + ((townIn.pop + (townIn.pop * reputation * 0.4))>0?(townIn.pop + (townIn.pop * reputation * 0.4)):0).toString(),textStyle);
                    } else {
                        newText = new PIXI.Text("The people of " + townIn.name + " hold you in disdain. They gave you NOTHING!",textStyle);
                    }
                    newText.y = 450;
                    //setTimeout(1000, function(){app.stage.removeChild(newText)});
                    app.stage.addChild(newText);
                    taxButton.visible = false;
                    setTimeout(function(){app.stage.removeChild(newText)},1000);
                }
                if(mouseX > 300 && mouseX < 450 && mouseY < 525 && mouseY > 500) {
                    state = map;
                    townScene.visible = false;
                    mapScene.visible = true;
                    app.renderer.backgroundColor = 0x55DD55;
                    eventText.position.set(0,0);
                    eventText.anchor.set(0,0);
                }
                if(mouseX > 150 && mouseX < 235 && mouseY < 525 && mouseY > 500 && recruitButton.visible) {
                    /// Recruit based on reputation
                    let popNum = Math.floor(townIn.pop * (0.25 + (0.125 * reputation))) || 0;
                    knightNum += Math.round(popNum * 0.75);
                    townIn.pop -= popNum;
                    archerNum += Math.round(popNum * 0.10 * 1/3);
                    recruitButton.visible = false;
                    for(let i = 0; i < popNum; i++) {
                            var gain = randInt(0,100);
                            if(gain === 1) {
                                ++spears;
                                // ++lootSpears;
                            } else if(gain === 2) {
                                ++swords;
                                // ++lootSwords;
                            } else if(gain === 3) {
                                ++maces;
                                // ++lootMaces;
                            } else if(gain === 4) {
                                ++axes;
                                // ++lootAxes;
                            } else if(gain === 5) {
                                ++helmets;
                                // ++lootHelmets;
                            } else if(gain === 6) {
                                ++breastplates;
                                // ++lootBreastplates;
                            } else if(gain === 7) {
                                ++misc;
                                // ++lootMisc;
                            } else if(gain === 8) {
                                // let randArrows = randInt(8,24);
                                arrows += randInt(8,24);
                                // lootArrows += randArrows;
                            } else if(gain < 15) {
                                gold += gain - 8;
                                // lootGold += gain - 8;
                            }
                        }
                }
                if(mouseX > 700 && mouseX < 800 && mouseY < 525 && mouseY > 500 && (rallyButton.visible || true)) {
                    if(gold >= 50) {
                        /// Recruit based on reputation
                        /// Recruit half of the militia(losing or gaining percentage based on rep)
                        let militiaNum = 10<=townIn.militia?10:townIn.militia//Math.floor(townIn.militia * (0.75 + (0.25 * reputation)>1?1:0.5 + (0.25 * reputation)<0?0:0.5 + (0.25 * reputation)));
                        knightNum += militiaNum;
                        townIn.militia -= militiaNum;
                        gold -= militiaNum * 10;
                        rallyButton.visible = false;
                        for(let i = 0; i < militiaNum; i++) {
                            var gain = randInt(1,7);
                            if(gain === 1) {
                                ++spears;
                                // ++lootSpears;
                            } else if(gain === 2) {
                                ++swords;
                                // ++lootSwords;
                            } else if(gain === 3) {
                                ++maces;
                                // ++lootMaces;
                            } else if(gain === 4) {
                                ++axes;
                                // ++lootAxes;
                            } else if(gain === 5) {
                                ++helmets;
                                // ++lootHelmets;
                            } else if(gain === 6) {
                                ++breastplates;
                                // ++lootBreastplates;
                            } else if(gain === 7) {
                                ++misc;
                                // ++lootMisc;
                            } else if(gain === 8) {
                                // let randArrows = randInt(8,24);
                                arrows += randInt(8,24);
                                // lootArrows += randArrows;
                            } else if(gain < 15) {
                                // gold += gain - 8;
                                // lootGold += gain - 8;
                            }
                        }
                    }
                }
                if(mouseX > 500 && mouseX < 665 && mouseY < 525 && mouseY > 500) {
                    state = marketSetup;
                }
                // eventText.anchor.set(0.5,0);
                eventText.text = "You are in the town of " + townIn.name + ", population " + townIn.pop.toString() + ".";
                eventText.text += "\nMilitia in the town is " + townIn.militia.toString() + " at the moment. May be attacked.";
                eventText.text += "\nYou can recruit some of the fighting men, and possibly some eager others.";
                eventText.text += "\nRecruit by hitting the " + '"Recruit"' + " button or the Hire 10 Mercenaries button."
                eventText.text += "\nYou will get soldiers based on reputation. Hire 10 Mercenaries makes it be more likely that they have weapons.";
                eventText.text += "\nReputation helps you get recruits and get goods. High reputation means people favor you.";
                eventText.text += "\nBuy goods for gold too. Boulders and arrows are projectiles, swords and helmets are knight equippables.";
                eventText.text += "\nGet gold from looting blobs OR hitting the TAX button. TAX decreases your reputation.";
                eventText.text += "\nProtect towns too. They will be targeted by blobs and destroyed if the militia fail.";
                eventText.text += "\nLeave the town by hitting the Leave Town button. Have fun in " + townIn.name.toString() + "!";
                keys.mouse = false;
            }
        }
        function marketSetup() {
            eventText.text = "1 Sword: " + prices.sword.toString();
            eventText.text += "\n10 Swords: " + (prices.sword * 8).toString();
            eventText.text += "\n1 Mace: " + prices.mace.toString();
            eventText.text += "\n10 Maces: " + (prices.mace * 8).toString();
            eventText.text += "\n1 Axe: " + prices.axe.toString();
            eventText.text += "\n10 Axes: " + (prices.axe * 8).toString();
            eventText.text += "\n1 Spear: " + prices.spear.toString();
            eventText.text += "\n10 Spears: " + (prices.spear * 8).toString();
            eventText.text += "\n1 Breastplate: " + prices.breastplate.toString();
            eventText.text += "\n10 Breastplates: " + (prices.breastplate * 8).toString();
            eventText.text += "\n1 Helmet: " + prices.helmet.toString();
            eventText.text += "\n10 Helmets: " + (prices.helmet * 8).toString();
            eventText.text += "\n1 Other: " + prices.misc.toString();
            eventText.text += "\n10 Others: " + (prices.misc * 8).toString();
            eventText.text += "\n1 Boulder: 70";
            eventText.text += "\nGold:" + gold.toString();
            eventText.text += "\nLeave Market";
            state = townMarket;
        }
        var lastEventText = false;
        function townMarket() {
            market = false;
            function marketUpdate() {
                setTimeout(function(){
                    eventText.text = "1 Sword: " + prices.sword.toString();
                    eventText.text += "\n10 Swords: " + (prices.sword * 8).toString();
                    eventText.text += "\n1 Mace: " + prices.mace.toString();
                    eventText.text += "\n10 Maces: " + (prices.mace * 8).toString();
                    eventText.text += "\n1 Axe: " + prices.axe.toString();
                    eventText.text += "\n10 Axes: " + (prices.axe * 8).toString();
                    eventText.text += "\n1 Spear: " + prices.spear.toString();
                    eventText.text += "\n10 Spears: " + (prices.spear * 8).toString();
                    eventText.text += "\n1 Breastplate: " + prices.breastplate.toString();
                    eventText.text += "\n10 Breastplates: " + (prices.breastplate * 8).toString();
                    eventText.text += "\n1 Helmet: " + prices.helmet.toString();
                    eventText.text += "\n10 Helmets: " + (prices.helmet * 8).toString();
                    eventText.text += "\n1 Other: " + prices.misc.toString();
                    eventText.text += "\n10 Others: " + (prices.misc * 8).toString();
                    eventText.text += "\n1 Boulder: 70";
                    eventText.text += "\nGold:" + gold.toString();
                    eventText.text += "\nLeave Market";
                },1000);
            }
            if(keys.mouse) {
                keys.mouse = false;
                var half = innerWidth / 2 - (501.5 - 387);
                var inc = 28;
                if(mouseX > half && mouseX < 700 - (564 - half) && mouseY > inc*0 && mouseY < inc*1) {
                    if (gold >= prices.sword) {
                        lastEventText = eventText.text;
                        eventText.text = "Purchased!";
                        marketUpdate();
                        ++swords;
                        gold -= prices.sword;
                    } else {
                        eventText.text = "Insufficient money.";
                        marketUpdate();
                    }
                } else if(mouseX > half && mouseX < 744 - (564 - half) && mouseY > inc*1 && mouseY < inc*2) {
                    if (gold >= prices.sword * 8) {
                        lastEventText = eventText.text;
                        eventText.text = "Purchased!";
                        marketUpdate();
                        swords += 10;
                        gold -= prices.sword * 8;
                    } else {
                        eventText.text = "Insufficient money.";
                        marketUpdate();
                    }
                } else if(mouseX > half && mouseX < 691 - (564 - half) && mouseY > inc*2 && mouseY < inc*3) {
                    if (gold >= prices.mace) {
                        lastEventText = eventText.text;
                        eventText.text = "Purchased!";
                        marketUpdate();
                        maces += 1;
                        gold -= prices.mace;
                    } else {
                        eventText.text = "Insufficient money.";
                        marketUpdate();
                    }
                } else if(mouseX > half && mouseX < 735 - (564 - half) && mouseY > inc*3 && mouseY < inc*4) {
                    if (gold >= prices.mace * 8) {
                        lastEventText = eventText.text;
                        eventText.text = "Purchased!";
                        marketUpdate();
                        maces += 10;
                        gold -= prices.mace * 8;
                    } else {
                        eventText.text = "Insufficient money.";
                        marketUpdate();
                    }
                } else if(mouseX > half && mouseX < 672 - (564 - half) && mouseY > inc*4 && mouseY < inc*5) {
                    if (gold >= prices.axe) {
                        lastEventText = eventText.text;
                        eventText.text = "Purchased!";
                        marketUpdate();
                        axes += 1;
                        gold -= prices.axe;
                    } else {
                        eventText.text = "Insufficient money.";
                        marketUpdate();
                    }
                } else if(mouseX > half && mouseX < 716 - (564 - half) && mouseY > inc*5 && mouseY < inc*6) {
                    if (gold >= prices.axe * 8) {
                        lastEventText = eventText.text;
                        eventText.text = "Purchased!";
                        marketUpdate();
                        axes += 10;
                        gold -= prices.axe * 8;
                    } else {
                        eventText.text = "Insufficient money.";
                        marketUpdate();
                    }
                } else if(mouseX > half && mouseX < 695 - (564 - half) && mouseY > inc*6 && mouseY < inc*7) {
                    if (gold >= prices.spear) {
                        lastEventText = eventText.text;
                        eventText.text = "Purchased!";
                        marketUpdate();
                        spears += 1;
                        gold -= prices.spear;
                    } else {
                        eventText.text = "Insufficient money.";
                        marketUpdate();
                    }
                } else if(mouseX > half && mouseX < 725 - (564 - half) && mouseY > inc*7 && mouseY < inc*8) {
                    if (gold >= prices.spear * 8) {
                        lastEventText = eventText.text;
                        eventText.text = "Purchased!";
                        marketUpdate();
                        spears += 10;
                        gold -= prices.spear * 8;
                    } else {
                        eventText.text = "Insufficient money.";
                        marketUpdate();
                    }
                } else if(mouseX > half && mouseX < 760 - (564 - half) && mouseY > inc*8 && mouseY < inc*9) {
                    if (gold >= prices.breastplate) {
                        lastEventText = eventText.text;
                        eventText.text = "Purchased!";
                        marketUpdate();
                        breastplates += 1;
                        gold -= prices.breastplate;
                    } else {
                        eventText.text = "Insufficient money.";
                        marketUpdate();
                    }
                } else if(mouseX > half && mouseX < 800 - (564 - half) && mouseY > inc*9 && mouseY < inc*10) {
                    if (gold >= prices.breastplate * 8) {
                        lastEventText = eventText.text;
                        eventText.text = "Purchased!";
                        marketUpdate();
                        breastplates += 10;
                        gold -= prices.breastplate * 8;
                    } else {
                        eventText.text = "Insufficient money.";
                        marketUpdate();
                    }
                } else if(mouseX > half && mouseX < 710 - (564 - half) && mouseY > inc*10 && mouseY < inc*11) {
                    if (gold >= prices.helmet) {
                        lastEventText = eventText.text;
                        eventText.text = "Purchased!";
                        marketUpdate();
                        helmets += 1;
                        gold -= prices.helmet;
                    } else {
                        eventText.text = "Insufficient money.";
                        marketUpdate();
                    }
                } else if(mouseX > half && mouseX < 750 - (564 - half) && mouseY > inc*11 && mouseY < inc*12) {
                    if (gold >= prices.helmet * 8) {
                        lastEventText = eventText.text;
                        eventText.text = "Purchased!";
                        marketUpdate();
                        helmets += 10;
                        gold -= prices.helmet * 8;
                    } else {
                        eventText.text = "Insufficient money.";
                        marketUpdate();
                    }
                } else if(mouseX > half && mouseX < 690 - (564 - half) && mouseY > inc*12 && mouseY < inc*13) {
                    if (gold >= prices.misc) {
                        lastEventText = eventText.text;
                        eventText.text = "Purchased!";
                        marketUpdate();
                        misc += 1;
                        gold -= prices.misc;
                    } else {
                        eventText.text = "Insufficient money.";
                        marketUpdate();
                    }
                } else if(mouseX > half && mouseX < 735 - (564 - half) && mouseY > inc*13 && mouseY < inc*14) {
                    if (gold >= prices.misc * 8) {
                        lastEventText = eventText.text;
                        eventText.text = "Purchased!";
                        marketUpdate();
                        misc += 10;
                        gold -= prices.misc * 8;
                    } else {
                        eventText.text = "Insufficient money.";
                        marketUpdate();
                    }
                } else if(mouseX > half && mouseX < 735 - (564 - half) && mouseY > inc*14 && mouseY < inc*15) {
                    if (gold >= 70) {
                        lastEventText = eventText.text;
                        eventText.text = "Purchased!";
                        marketUpdate();
                        boulders++;
                        gold -= 70;
                    } else {
                        eventText.text = "Insufficient money.";
                        marketUpdate();
                    }
                } else if(mouseX > half && mouseX < 735 - (564 - half) && mouseY > inc*16 && mouseY < inc*17) {
                    state = map;
                    townScene.visible = false;
                    mapScene.visible = true;
                    app.renderer.backgroundColor = 0x55DD55;
                    eventText.position.set(0,0);
                    eventText.anchor.set(0,0);
                    keys.mouse = false;
                }
            }
        }
        function videoStartup() {
            let blobLineMax = Math.floor(innerWidth / 50);
            let blobLinesNeeded = Math.ceil(blobNum / blobLineMax);
            let knightLineMax = Math.floor(innerWidth / 50);
            let knightLinesNeeded = Math.ceil(knightNum / knightLineMax);
            let totalLinesNeeded = knightLinesNeeded + blobLinesNeeded + 5;
            neededSpacing = innerHeight / totalLinesNeeded;
            if (neededSpacing > 100) {
                neededSpacing = 100;
            }
            spawnAllBlobs();
            spawnAllSoldiers();
            state = play;
        }
        function gameLoop(delta) {
            state(delta);
        }
        function fireArrows() {
            for (let i = 0; i < archerNum; i++) {
                if (arrows > 0) {
                    spawnArrow(0, (i * (innerWidth / archerNum) + 24));
                    --arrows;
                }
            }
        }
        function guideArrows() {
            for (let i = 0; i < archerNum * randNum(0.5,1); i++) {
                if (arrows > 0) {
                    spawnArrow(pointTowards((i * (innerWidth / archerNum) + 24), innerHeight, mouseX, mouseY), (i * (innerWidth / archerNum) + 24));
                    --arrows;
                }
            }
        }
        function spawnArrow(direction, x) {
            let arrow = new Sprite(resources["sprites/arrow.png"].texture);
            arrow.y = innerHeight;
            arrow.x = x;
            // arrow.scale.set(0.05);
            arrow.direction = direction;
            battleScene.addChild(arrow);
            firedArrows.push(arrow);
            arrow.anchor.set(0.5);

        }
        function spawnAllBlobs() {
            var lineMax = Math.floor(innerWidth / 50);
            /// Any amount less than lineMax will work.
            var linesNeeded = Math.ceil(blobNum / lineMax);

            for (let i = 0; i < linesNeeded; i++) {
                if (blobNum >= lineMax) {
                    spawnBlobs(lineMax, 0 + ((i + 1) * neededSpacing));
                    blobNum -= lineMax;
                } else {
                    spawnBlobs(blobNum, 0 + ((i + 1) * neededSpacing));
                    blobNum = 0;
                }
            }
        }
        function spawnAllSoldiers() {
            /// We want to fill the screen as packed as we can with soldiers.

            /// How many soldiers can we fit in a line?
            var lineMax = Math.floor(innerWidth / 50);
            /// Any amount less than lineMax will work.
            var linesNeeded = Math.ceil(knightNum / lineMax);
            for (let i = linesNeeded - 1; i >= 0; i--) {
                if (knightNum >= lineMax) {
                    spawnSoldiers(lineMax, innerHeight - ((i + 1) * neededSpacing));
                    knightNum -= lineMax;
                } else {
                    spawnSoldiers(knightNum, innerHeight - ((i + 1) * neededSpacing));
                    knightNum = 0;
                }
            }
        }
        function townBattle() {
            if (params.slowTick) {
                if (Date.now() - (Number(params.slowTick) * 100) < slowTickSec) {
                    return;
                } else {
                    slowTickSec = Date.now();
                }
            }
            if (numberOfBlobs() < 1) {
                /// The battle is won!
                /// Keep all the alive knights
                console.log("Gave",chosenTown.name,numberOfKnights())
                chosenTown.militia = numberOfKnights();
                /// Gain back the weapons and armor of the knights and perhaps of the fallen
                soldiers.forEach(function (knight) {
                    battleScene.removeChild(knight);
                });
                if(blobArmySplice > -1) {
                    /// Destroy the blob army
                    mapScene.removeChild(blobArmies[blobArmySplice]);
                    blobArmies.splice(blobArmySplice, 1);
                }
                /// Switch to Map
                mapScene.visible = true;
                battleScene.visible = false;
                soldiers = [];
                state = map;
                blobs = [];
                return;
            }
            else if(numberOfKnights() < 1) {
                /// The town is taken
                /// The blobs just burn them down
                // console.log(blobArmies[blobArmySplice].mapX,blobArmies[blobArmySplice].mapY,chosenTown.mapX,chosenTown.mapY);
                mapScene.removeChild(chosenTown);
                towns.splice(townSplice,1);
                mapScene.visible = true;
                battleScene.visible = false;
                // blobs.forEach(function (knight) {
                    // battleScene.removeChild(knight);
                // });
                chosenBlobArmy.num = numberOfBlobs();
                blobs.forEach(function(blob){
                    console.log(blob.state)
                    if(blob.state && blob.state !== "dead") {
                        // blobArmies[blobArmySplice].militia++;
                        if(blob.horns) {
                            chosenBlobArmy.horns++;
                        } else if(blob.redeye) {
                            chosenBlobArmy.redeye++;
                        }
                    }
                    battleScene.removeChild(blob.text);
                    battleScene.removeChild(blob);
                });
                blobs = [];
                soldiers = [];
                state = map;
                return;
            }
            if (cooldown > 0 && Date.now() - 250 > lastSec) {
                lastSec = Date.now();
                cooldown -= 0.25;
            }
            catapult.clear();
            firedArrows.forEach(function (arrow, i) {
                var data = direction(10, arrow.direction + 180);
                arrow.x += data.r;
                arrow.y += data.u;
                arrow.rotation = pointInDirection(arrow.direction);
                if (arrow.x < -100 || arrow.x > innerWidth + 100 || arrow.y < -100 || arrow.y > innerHeight + 100) {
                    battleScene.removeChild(arrow);
                    firedArrows.splice(i, 1);
                }
            });
            eventText.text = chosenTown.name + " is under attack. " + chosenTown.name + " has " + numberOfKnights().toString() + " knights to defend itself, and is under attack by " + numberOfBlobs() + " blobs.";
            // eventText.text = cooldown < 1 ? mouseModes[mouseMode].name : "Cooldown";
            if (keys.ArrowLeft) {
                if (leftReady) {
                    --mouseMode;
                    if (mouseMode < 0) {
                        mouseMode = mouseModes.length - 1;
                    }
                    leftReady = false;
                }
            }
            if (!keys.ArrowLeft) {
                leftReady = true;
            }
            if (keys.ArrowRight) {
                if (rightReady) {
                    ++mouseMode;
                    if (mouseMode >= mouseModes.length) {
                        mouseMode = 0;
                    }
                    rightReady = false;
                }
            }
            if (!keys.ArrowRight) {
                rightReady = true;
            }
            soldiers.forEach(function (knight, i) {
                if(numberOfBlobs() < 1) {
                    return;
                }
                if (params.health) {
                    knight.children[knight.children.length-1].text = knight.health.toString();
                } else if(params.dmg || params.damage) {
                    knight.children[knight.children.length-1].text = knight.dmg.toString();
                }
                if (!knight.state) {
                    return;
                }
                if (knight.health < 1) {
                    if (knight.state === "attacking") {
                        if (blobs[knight.attackingSprite.i].state) {
                            blobs[knight.attackingSprite.i].health -= knight.dmg;
                        }
                    }
                    knight.state = "dead";
                }
                if (knight.state === "dead") {
                    knight.rotation += 0.05;
                    if (knight.rotation > 1.75) {
                        battleScene.removeChild(knight);
                        if (params.debug) {
                            battleScene.removeChild(knight.text);
                        }
                        knight.state = false;
                    }
                } else if (knight.state === "live") {
                    var enemyInfo = nearestBlob(knight);
                    if (!enemyInfo) {
                        return;
                    }
                    var enemy = enemyInfo.sprite;
                    knight.direction = pointTowards(knight.x, knight.y, enemy.x, enemy.y);
                    let data = direction(1, knight.direction + 180);
                    knight.x += data.r;
                    knight.y += data.u;
                    if (enemyInfo.dist < 25) {
                        knight.state = "attacking";
                        knight.attacking = 5;
                        knight.attackingSprite = enemyInfo;
                    }
                    if (knight.health < 1) {
                        knight.state = "dead";
                    }
                } else if (knight.state === "attacking") {
                    var enemy = knight.attackingSprite.sprite
                    knight.direction = pointTowards(knight.x, knight.y, enemy.x, enemy.y);
                    let data = direction(knight.attacking > 0 ? 2 : -2, knight.direction + 180);
                    knight.x += data.r;
                    knight.y += data.u;
                    --knight.attacking;
                    if (knight.attacking < -5) {
                        knight.state = "live";
                        if (blobs[knight.attackingSprite.i].state) {
                            blobs[knight.attackingSprite.i].health -= knight.dmg;
                        }
                    }
                }
            });
            blobs.forEach(function (knight, i) {
                if(numberOfKnights() < 1) {
                    return;
                }
                if (params.debug) {
                    knight.text.text = knight.health.toString();
                    knight.text.anchor.set(0.5);
                    knight.text.x = knight.x;
                    knight.text.y = knight.y;
                }
                if (!knight.state) {
                    return;
                }
                firedArrows.forEach(function (arrow, i) {
                    if (hitTestRectangle(knight, arrow) && knight.state != "dead" && knight.state != false) {
                        knight.health -= 2;
                        firedArrows.splice(i, 1)
                        battleScene.removeChild(arrow);
                    }
                })
                if (knight.health < 1) {
                    if (knight.state === "attacking") {
                        if (soldiers[knight.attackingSprite.i].state) {
                            soldiers[knight.attackingSprite.i].health -= knight.dmg;
                        }
                    }
                    knight.state = "dead";
                }
                if (knight.state === "dead") {
                    knight.rotation += 0.05;
                    if (knight.rotation > 1.75) {
                        battleScene.removeChild(knight);
                        if (params.debug) {
                            battleScene.removeChild(knight.text);
                        }
                        knight.state = false;
                    }
                } else if (knight.state === "live") {
                    var enemyInfo = nearestKnight(knight);
                    if(!enemyInfo) {
                        return;
                    }
                    var enemy = enemyInfo.sprite;
                    knight.direction = pointTowards(knight.x, knight.y, enemy.x, enemy.y);
                    let data = direction(1, knight.direction + 180);
                    knight.x += data.r;
                    knight.y += data.u;
                    if (enemyInfo.dist < 25) {
                        knight.state = "attacking";
                        knight.attacking = 5;
                        knight.attackingSprite = enemyInfo;
                    }
                    if (knight.health < 1) {
                        knight.state = "dead";

                    }
                } else if (knight.state === "attacking") {
                    var enemy = knight.attackingSprite.sprite
                    knight.direction = pointTowards(knight.x, knight.y, enemy.x, enemy.y);
                    let data = direction(knight.attacking > 0 ? 2 : -2, knight.direction + 180);
                    knight.x += data.r;
                    knight.y += data.u;
                    --knight.attacking;
                    if (knight.attacking < -5) {
                        knight.state = "live";
                        if (soldiers[knight.attackingSprite.i].state) {
                            soldiers[knight.attackingSprite.i].health -= blobDmg;
                        }
                    }
                }
            });
        }
        var light = new PIXI.Graphics();
        function winning(){
            mapScene.addChild(light);
            light.alpha = 0;
            light.beginFill(0xFFFFFF);
            light.drawRect(0,0,100+innerWidth, 100+innerHeight);
            state = lightUp;
        }
        function lightUp() {
            if(light.alpha < 1) {
                light.alpha += 0.005;
            } else {
                state = achievements;
            }
        }
        var achieveText;
        function achievements(){
            achieveText = new PIXI.Text("");
            app.stage.addChild(achieveText);
            achieveText.text += "Congratulations! You saved the country!"
            var achievText = "";
            for(let i = 0; i < towns.length; i++) {
                if(towns[i].name == "Royal Guard") {
                    achievText += "\nSaved an Army: Royal Guard was not overcome!"
                } else if(towns[i].name == "Fordstone") {
                    achievText += "\nRockford: Fordstone was not taken!"
                } else if(towns[i].name == "Thrugsford") {
                    achievText += "\nThrugsford: Thrugsford survived!"
                }
            }
            if(merchant) {
                achievText += "\nSounds like a trap: Never go into Merchant's lair."
            }
            if(market) {
                achievText += "\nI never shop: Never go into a market."
            }
            if(noFireCatapult) {
                achievText += "\nCatapult?: Never fire the catapult."
            }
            if(towns.length > 7) {
                achievText += "\nHero of the country: No towns taken!"
            } else if(towns.length > 3) {
                achievText += "\nHolden ground: One middle or farther city survived!"
            }
            if(achievText != "") {
                achieveText.text += "\nYou gained the achievements:\n"+achievText;
            }
            state = wait;
        }
        function wait(){

        }
        function play() {
            if (params.slowTick) {
                if (Date.now() - (Number(params.slowTick) * 100) < slowTickSec) {
                    return;
                } else {
                    slowTickSec = Date.now();
                }
            }
            if (numberOfBlobs() < 1) {
                /// The battle is won!
                /// Keep all the alive knights
                knightNum = numberOfKnights();
                /// Gain back the weapons and armor of the knights and perhaps of the fallen
                soldiers.forEach(function (knight) {
                    if(knight.helmet && (knight.state != false || randInt(1,2) === 2)) {
                        ++helmets;
                    }
                    if(knight.breastplate && (knight.state != false || randInt(1,2) === 2)) {
                        ++breastplates;
                    }
                    if(knight.helmet && (knight.state != false || randInt(1,2) === 2)) {
                        ++misc;
                    }
                    if(knight.sword && (knight.state != false || randInt(1,2) === 2)) {
                        ++swords;
                    } else if(knight.mace && (knight.state != false || randInt(1,2) === 2)) {
                        ++maces;
                    } else if(knight.axe && (knight.state != false || randInt(1,2) === 2)) {
                        ++axes;
                    } else if(knight.spear && (knight.state != false || randInt(1,2) === 2)) {
                        ++spears;
                    }
                    /// Delete that knight
                    battleScene.removeChild(knight);
                });
                /// Loot from the blobs!
                let lootSpears = 0;
                let lootSwords = 0;
                let lootAxes = 0;
                let lootMaces = 0;
                let lootHelmets = 0;
                let lootBreastplates = 0;
                let lootMisc = 0;
                let lootGold = 0;
                let lootArrows = 0;
                for(let i = 0; i < blobs.length; i++) {
                    /// Loot gold, armor, and weapons. No boulders, but maybe arrows.
                    var gain = randInt(0,20);
                    if(gain === 1) {
                        ++spears;
                        ++lootSpears;
                    } else if(gain === 2) {
                        ++swords;
                        ++lootSwords;
                    } else if(gain === 3) {
                        ++maces;
                        ++lootMaces;
                    } else if(gain === 4) {
                        ++axes;
                        ++lootAxes;
                    } else if(gain === 5) {
                        ++helmets;
                        ++lootHelmets;
                    } else if(gain === 6) {
                        ++breastplates;
                        ++lootBreastplates;
                    } else if(gain === 7) {
                        ++misc;
                        ++lootMisc;
                    } else if(gain === 8) {
                        let randArrows = randInt(8,24);
                        arrows += randInt(8,24);
                        lootArrows += randArrows;
                    } else if(gain < 15) {
                        gold += gain - 8;
                        lootGold += gain - 8;
                    }
                    eventText.text = "Congratulations! You won the battle! You looted:"
                    if(lootSwords) {
                        eventText.text += "\nSwords:" + lootSwords.toString()
                    }
                    if(lootSpears) {
                        eventText.text += "\nSpears:" + lootSpears.toString()
                    }
                    if(lootMaces) {
                        eventText.text += "\nMaces:" + lootMaces.toString()
                    }
                    if(lootAxes) {
                        eventText.text += "\nLight Axes:" + lootAxes.toString()
                    }
                    if(lootHelmets) {
                        eventText.text += "\nHelmets:" + lootHelmets.toString()
                    }
                    if(lootBreastplates) {
                        eventText.text += "\nBreastplates:" + lootBreastplates.toString()
                    }
                    if(lootMisc) {
                        eventText.text += "\nOther:" + lootMisc.toString()
                    }
                    if(lootArrows) {
                        eventText.text += "\nArrows:" + lootArrows.toString()
                    }
                    updateStats = false;
                }
                if(blobArmySplice > -1) {
                    /// Destroy the blob army
                    mapScene.removeChild(blobArmies[blobArmySplice]);
                    blobArmies.splice(blobArmySplice, 1);
                }
                /// Switch to Map
                mapScene.visible = true;
                battleScene.visible = false;
                soldiers = [];
                state = map;
                return;
            }
            if (cooldown > 0 && Date.now() - 250 > lastSec) {
                lastSec = Date.now();
                cooldown -= 0.25;
            }
            catapult.clear();
            if (cooldown > 4.75) {
                catapultSize += 2;
                catapult.lineStyle(0)
                catapult.beginFill(0x777777);
                catapult.drawCircle(mouseX, mouseY, catapultSize);
                catapult.endFill();
            } else if (cooldown > 4.5) {
                catapultSize -= 2;
                catapult.lineStyle(0)
                catapult.beginFill(0x777777);
                catapult.drawCircle(mouseX, mouseY, catapultSize);
                catapult.endFill();
            } else if (mouseModes[mouseMode].name === "Fire Catapult") {
                catapult.lineStyle(0)
                catapult.beginFill(0x777777);
                catapult.drawCircle(mouseX, mouseY, 100);
                catapult.endFill();
            }
            firedArrows.forEach(function (arrow, i) {
                var data = direction(10, arrow.direction + 180);
                arrow.x += data.r;
                arrow.y += data.u;
                arrow.rotation = pointInDirection(arrow.direction);
                if (arrow.x < -100 || arrow.x > innerWidth + 100 || arrow.y < -100 || arrow.y > innerHeight + 100) {
                    battleScene.removeChild(arrow);
                    firedArrows.splice(i, 1);
                }
            });
            eventText.text = cooldown < 1 ? mouseModes[mouseMode].name : "Cooldown";
            // eventText.text = numberOfBlobs();
            if (keys.ArrowLeft) {
                if (leftReady) {
                    --mouseMode;
                    if (mouseMode < 0) {
                        mouseMode = mouseModes.length - 1;
                    }
                    leftReady = false;
                }
            }
            if (!keys.ArrowLeft) {
                leftReady = true;
            }
            if (keys.ArrowRight) {
                if (rightReady) {
                    ++mouseMode;
                    if (mouseMode >= mouseModes.length) {
                        mouseMode = 0;
                    }
                    rightReady = false;
                }
            }
            if (!keys.ArrowRight) {
                rightReady = true;
            }
            soldiers.forEach(function (knight, i) {
                if (params.health) {
                    knight.children[knight.children.length - 1].text = knight.health.toString();
                } else if(params.dmg || params.damage) {
                    knight.children[knight.children.length - 1].text = knight.dmg.toString();
                }
                if (!knight.state) {
                    return;
                }
                if (knight.health < 1) {
                    if (knight.state === "attacking") {
                        if (blobs[knight.attackingSprite.i].state) {
                            blobs[knight.attackingSprite.i].health -= knight.dmg;
                        }
                    }
                    knight.state = "dead";
                }
                if (knight.state === "dead") {
                    knight.rotation += 0.05;
                    if (knight.rotation > 1.75) {
                        battleScene.removeChild(knight);
                        if (params.debug) {
                            battleScene.removeChild(knight.text);
                        }
                        knight.state = false;
                    }
                } else if (knight.state === "live") {
                    var enemyInfo = nearestBlob(knight);
                    if (!enemyInfo) {
                        return;
                    }
                    var enemy = enemyInfo.sprite;
                    knight.direction = pointTowards(knight.x, knight.y, enemy.x, enemy.y);
                    let data = direction(1, knight.direction + 180);
                    knight.x += data.r;
                    knight.y += data.u;
                    if (enemyInfo.dist < 25) {
                        knight.state = "attacking";
                        knight.attacking = 5;
                        knight.attackingSprite = enemyInfo;
                    }
                    if (knight.health < 1) {
                        knight.state = "dead";
                    }
                } else if (knight.state === "attacking") {
                    var enemy = knight.attackingSprite.sprite
                    knight.direction = pointTowards(knight.x, knight.y, enemy.x, enemy.y);
                    let data = direction(knight.attacking > 0 ? 2 : -2, knight.direction + 180);
                    knight.x += data.r;
                    knight.y += data.u;
                    --knight.attacking;
                    if (knight.attacking < -5) {
                        knight.state = "live";
                        if (blobs[knight.attackingSprite.i].state) {
                            blobs[knight.attackingSprite.i].health -= knight.dmg;
                        }
                    }
                }
            });
            blobs.forEach(function (knight, i) {
                if (params.debug) {
                    knight.text.text = knight.health.toString();
                    knight.text.anchor.set(0.5);
                    knight.text.x = knight.x;
                    knight.text.y = knight.y;
                }
                if (!knight.state) {
                    return;
                }
                firedArrows.forEach(function (arrow, i) {
                    if (hitTestRectangle(knight, arrow) && knight.state != "dead" && knight.state != false) {
                        knight.health -= 2;
                        firedArrows.splice(i, 1)
                        battleScene.removeChild(arrow);
                    }
                })
                if (knight.health < 1) {
                    if (knight.state === "attacking") {
                        if (soldiers[knight.attackingSprite.i].state) {
                            soldiers[knight.attackingSprite.i].health -= knight.dmg;
                        }
                    }
                    knight.state = "dead";
                }
                if (knight.state === "dead") {
                    knight.rotation += 0.05;
                    if (knight.rotation > 1.75) {
                        battleScene.removeChild(knight);
                        if (params.debug) {
                            battleScene.removeChild(knight.text);
                        }
                        knight.state = false;
                    }
                } else if (knight.state === "live") {
                    var enemyInfo = nearestKnight(knight);
                    var enemy = enemyInfo.sprite;
                    knight.direction = pointTowards(knight.x, knight.y, enemy.x, enemy.y);
                    let data = direction(1, knight.direction + 180);
                    knight.x += data.r;
                    knight.y += data.u;
                    if (enemyInfo.dist < 25) {
                        knight.state = "attacking";
                        knight.attacking = 5;
                        knight.attackingSprite = enemyInfo;
                    }
                    if (knight.health < 1) {
                        knight.state = "dead";

                    }
                } else if (knight.state === "attacking") {
                    var enemy = knight.attackingSprite.sprite
                    knight.direction = pointTowards(knight.x, knight.y, enemy.x, enemy.y);
                    let data = direction(knight.attacking > 0 ? 2 : -2, knight.direction + 180);
                    knight.x += data.r;
                    knight.y += data.u;
                    --knight.attacking;
                    if (knight.attacking < -5) {
                        knight.state = "live";
                        if (soldiers[knight.attackingSprite.i].state) {
                            soldiers[knight.attackingSprite.i].health -= knight.dmg;
                        }
                    }
                }
            });
        }
        function nearestBlob(sprite) {
            var returnSprite = false;
            var dist = Infinity;
            var index = 0;
            blobs.forEach(function (blob, i) {
                if (blob.state === false || blob.state === "dead") {
                    return;
                }
                if (getDistance(sprite.x, sprite.y, blob.x, blob.y) < dist) {
                    returnSprite = blob;
                    dist = getDistance(sprite.x, sprite.y, blob.x, blob.y);
                    index = i;
                }
            });
            if (returnSprite) {
                return { sprite: returnSprite, dist: dist, i: index };
            } else {
                return false;
            }
        }
        function nearestKnight(sprite) {
            var returnSprite = false;
            var dist = Infinity;
            var index = 0;
            soldiers.forEach(function (soldier, i) {
                if (soldier.state === false || soldier.state === "dead") {
                    return;
                }
                if (getDistance(sprite.x, sprite.y, soldier.x, soldier.y) < dist) {
                    returnSprite = soldier;
                    dist = getDistance(sprite.x, sprite.y, soldier.x, soldier.y);
                    index = i;
                }
                if (getDistance(sprite.x, sprite.y, soldier.x, soldier.y) === dist && randInt(1, 2) === 1) {
                    returnSprite = soldier;
                    dist = getDistance(sprite.x, sprite.y, soldier.x, soldier.y);
                    index = i;
                }
            });
            if(returnSprite) {
                return { sprite: returnSprite, dist: dist, i: index };
            } else {
                return false;
            }
        }
        function spawnSoldiers(count, y, isTown) {
            if (count === "fill") {
                count = innerWidth / 50;
            }
            count = Number(count) || 1;
            for (let i = 0; i < count; i++) {
                let knight = new Container();
                battleScene.addChild(knight);
                let newSoldier = new Sprite(id["explorer.png"]);
                knight.y = y;
                knight.x = (i * 50) + 24;
                knight.addChild(newSoldier);
                soldiers.push(knight);
                knight.health = knightHp;
                knight.dmg = knightDmg;
                if(isTown) {
                    let randThreshold = 0.15;
                    if (Math.random() < randThreshold) {
                        let helm = new Sprite(resources["sprites/helmet.png"].texture);
                        helm.scale.set(1.2);
                        helm.position.set(-12,-20);
                        knight.addChild(helm);
                        // --helmets;
                        knight.health += 3;
                        knight.helmet = true;
                    }
                    if (Math.random() < randThreshold) {
                        let breastplate = new Sprite(resources["sprites/breastplate.png"].texture);
                        breastplate.scale.set(1.2);
                        breastplate.position.set(-8,-1);
                        knight.addChild(breastplate);
                        // --breastplates;
                        knight.health += 6;
                        knight.breastplate = true;
                    }
                    if (Math.random() < randThreshold) {
                        let gg = new Sprite(resources["sprites/misc.png"].texture);
                        gg.scale.set(2);
                        gg.position.set(-8,1);
                        knight.addChild(gg);
                        // --misc;
                        knight.health += 4;
                        knight.misc = true;
                    }
                    knight.falter = 0;
                    if(Math.random() < randThreshold) {
                        knight.dmg += 2;
                        let sword = new Sprite(resources["sprites/sword.png"].texture);
                        sword.scale.set(2.5);
                        knight.addChild(sword);
                        knight.sword = true;
                    } else if(Math.random() < randThreshold) {
                        let mace = new Sprite(resources["sprites/mace.png"].texture);
                        mace.scale.set(1.5);
                        mace.position.set(5,-5);
                        knight.addChild(mace);
                        // --maces; 
                        knight.mace = true;
                    } else if(Math.random() < randThreshold) {
                        let axe = new Sprite(resources["sprites/axe.png"].texture);
                        // axe.scale.set(1.2);
                        axe.position.set(2,-4);
                        knight.addChild(axe);
                        // --axes;
                        knight.dmg += 5;
                        knight.falter = 0.5;
                        knight.axe = true;
                    } else if(Math.random() < randThreshold) {
                        let spear = new Sprite(resources["sprites/spear.png"].texture);
                        // spear.scale.set(1.2);
                        spear.position.set(4,-4);
                        knight.addChild(spear);
                        // --spears;
                        knight.dmg += 1;
                        knight.spear = true;
                    }
                } else {
                    if (helmets > 0) {
                        let helm = new Sprite(resources["sprites/helmet.png"].texture);
                        helm.scale.set(1.2);
                        helm.position.set(-12,-20);
                        knight.addChild(helm);
                        --helmets;
                        knight.health += 3;
                        knight.helmet = true;
                    }
                    if (breastplates > 0) {
                        let breastplate = new Sprite(resources["sprites/breastplate.png"].texture);
                        breastplate.scale.set(1.2);
                        breastplate.position.set(-8,-1);
                        knight.addChild(breastplate);
                        --breastplates;
                        knight.health += 6;
                        knight.breastplate = true;
                    }
                    if (misc > 0) {
                        let gg = new Sprite(resources["sprites/misc.png"].texture);
                        gg.scale.set(2);
                        gg.position.set(-8,1);
                        knight.addChild(gg);
                        --misc;
                        knight.health += 4;
                        knight.misc = true;
                    }
                    knight.falter = 0;
                    if(swords > 0) {
                        --swords;
                        knight.dmg += 2;
                        let sword = new Sprite(resources["sprites/sword.png"].texture);
                        sword.scale.set(2.5);
                        knight.addChild(sword);
                        knight.sword = true;
                    } else if(maces > 0) {
                        let mace = new Sprite(resources["sprites/mace.png"].texture);
                        mace.scale.set(1.5);
                        mace.position.set(5,-5);
                        knight.addChild(mace);
                        --maces; 
                        knight.mace = true;
                    } else if(axes > 0) {
                        let axe = new Sprite(resources["sprites/axe.png"].texture);
                        // axe.scale.set(1.2);
                        axe.position.set(2,-4);
                        knight.addChild(axe);
                        --axes;
                        knight.dmg += 5;
                        knight.falter = 0.5;
                        knight.axe = true;
                    } else if(spears > 0) {
                        let spear = new Sprite(resources["sprites/spear.png"].texture);
                        // spear.scale.set(1.2);
                        spear.position.set(4,-4);
                        knight.addChild(spear);
                        --spears;
                        knight.dmg += 1;
                        knight.spear = true;
                    }
                }
                knight.state = "live";
                newSoldier.anchor.set(0.5);
                if (params.debug) {
                    let text = new PIXI.Text(knight.health.toString(), blue);//{stroke:"0000FF",fill:"blue"});
                    //battleScene.addChild(newSoldier.text);
                    knight.addChild(text);
                }
            }

        }
        function spawnBlobs(count, y) {
            if (count === "fill") {
                let x = 24;
                for (let i = 0; i < innerWidth / 50; i++) {
                    var newSoldier;
                    if(blobArmies[blobArmySplice].horns>0) {
                        --blobArmies[blobArmySplice].horns;
                        newSoldier = new Sprite(resources["sprites/horns.png"].texture);
                        newSoldier.horns = true;
                    } else if(blobArmies[blobArmySplice].redeye>0) {
                        --blobArmies[blobArmySplice].redeye;
                        newSoldier = new Sprite(resources["sprites/redeye.png"].texture);
                        newSoldier.redeye = true;
                    } else {
                        newSoldier = new Sprite(id["blob.png"]);
                    }
                    newSoldier.y = y;
                    newSoldier.x = (i * 50) + 24;
                    battleScene.addChild(newSoldier);
                    blobs.push(newSoldier);
                    newSoldier.health = blobHp + (newSoldier.horns?7:newSoldier.redeye?-1:0);
                    newSoldier.dmg = blobDmg + (newSoldier.horns?3:newSoldier.redeye?6:0);
                    newSoldier.state = "live";
                    newSoldier.anchor.set(0.5);
                    if (params.debug) {
                        newSoldier.text = new PIXI.Text(newSoldier.health.toString(), blue);//{stroke:"0000FF",fill:"blue"});
                        battleScene.addChild(newSoldier.text);
                        newSoldier.text.x = newSoldier.x;
                        newSoldier.text.y = newSoldier.y;
                    }
                }
            } else {
                count = Number(count) || 1;
                for (let i = 0; i < count; i++) {
                    var newSoldier;
                    if(blobArmies[blobArmySplice].horns>0) {
                        --blobArmies[blobArmySplice].horns;
                        newSoldier = new Sprite(resources["sprites/horns.png"].texture);
                        newSoldier.horns = true;
                    } else if(blobArmies[blobArmySplice].redeye>0) {
                        --blobArmies[blobArmySplice].redeye;
                        newSoldier = new Sprite(resources["sprites/redeye.png"].texture);
                        newSoldier.redeye = true;
                    } else {
                        newSoldier = new Sprite(id["blob.png"]);
                    }
                    newSoldier.y = y;
                    newSoldier.x = (i * 50) + 24;
                    battleScene.addChild(newSoldier);
                    blobs.push(newSoldier);
                    newSoldier.health = blobHp + (newSoldier.horns?7:newSoldier.redeye?-1:0);
                    newSoldier.state = "live";
                    newSoldier.dmg = blobDmg + (newSoldier.horns?3:newSoldier.redeye?6:0);
                    newSoldier.anchor.set(0.5);
                    if (params.debug) {
                        newSoldier.text = new PIXI.Text(newSoldier.health.toString(), blue);//{stroke:"0000FF",fill:"blue"});
                        battleScene.addChild(newSoldier.text);
                        newSoldier.text.x = newSoldier.x;
                        newSoldier.text.y = newSoldier.y;
                    }
                }
            }
        }
        function spawnTowns() {
            makeTowns.forEach(function (townToMake) {
                var town = new PIXI.Sprite(resources["sprites/house1.png"].texture);
                town.mapX = townToMake.x;
                town.mapY = townToMake.y;
                town.scale.set(0.35);
                town.name = townToMake.name;
                if(town.name == "Royal Guard") {
                    town.pop = townToMake.pop;
                    town.militia = 500;
                    town.pop = 100;//town.militia;
                } else if(town.name == "Xitown") {
                    town.pop = townToMake.pop;
                    town.militia = 100;
                    town.pop -= town.militia;
                } else if(town.name == "Thrugsford"){
                    town.pop = townToMake.pop;
                    town.militia = 70;
                    town.pop -= town.militia;
                } else {
                    town.pop = townToMake.pop;
                    town.militia = Math.round(town.pop / randNum(3.0,5.0));
                }
                // town.militia = 10;
                // town.x = 100;
                // town.y = 300;
                // app.stage.addChild(town);
                mapScene.addChild(town);
                towns.push(town);
            });
        }
        addEventListener("mousedown", function (mouse) {
            mouseX = mouse.pageX;
            mouseY = mouse.pageY;
            keys.mouse = true;
            if (state === play && cooldown < 1) {
                mouseModes[mouseMode].effect();
                if (mouseModes[mouseMode].name === "Fire Catapult") {
                    cooldown = 5;
                    lastSec = Date.now();
                }
            }
        });
        addEventListener("mouseup", function () {
            keys.mouse = false;
        })
        addEventListener("wheel", function (scroll) {
            if (scroll.deltaY < 0) {
                ++mouseMode;
                if (mouseMode >= mouseModes.length) {
                    mouseMode = 0;
                }
            } else if (scroll.deltaY > 0) {
                --mouseMode;
                if (mouseMode < 0) {
                    mouseMode = mouseModes.length - 1;
                }
            }
        })
        addEventListener("mousemove", function (mouse) {
            mouseX = mouse.pageX;
            mouseY = mouse.pageY;
        })
        addEventListener("blur", function () {
            keys = {};
        });
        addEventListener("keydown", function (e) {
            keys[e.key] = true;
        });
        addEventListener("keyup", function (e) {
            keys[e.key] = false;
        });
    </script>
</body>
</html>